import{ai as n,aj as l,al as S,aq as v,az as F,cV as j,fo as L,fp as O}from"./index-4b03b1b0.js";import{n as P}from"./LayerView3D-ba0927cb.js";import{o as _}from"./TiledLayerView3D-a62304ae.js";import{b as G}from"./commonProperties-1e64caff.js";import{T as E,q as V}from"./rasterProjectionHelper-0467928e.js";import{p as M}from"./popupUtils-81d67c22.js";import{d as k}from"./LayerView-dc80e8d1.js";import{a as q}from"./RefreshableLayerView-5aa0dbef.js";import{r as A}from"./drapedUtils-fd696ea8.js";import"./ElevationInfo-f714f054.js";const W=i=>{let e=class extends i{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return this.projectFullExtent(this.view.spatialReference)}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return E(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(t){return!!this.projectFullExtent(t)}projectFullExtent(t){const a=this.layer.fullExtent,r=E(a,t,!1);return V(a,t,r)}async fetchPopupFeatures(t,a){const{layer:r}=this;if(!t)throw new v("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:u}=r,y=M(r,a);if(!u||y==null)throw new v("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:u,popupTemplate:y});const p=[],{value:o,magdirValue:s,processedValue:b}=await r.identify(t,{timeExtent:this.timeExtent});let c="";if(o&&o.length){c=r.type==="imagery-tile"&&r.hasStandardTime()&&o[0]!=null?o.map(w=>r.getStandardTimeValue(w)).join(", "):o.join(", ");const d={ObjectId:0},T="Raster.ServicePixelValue";d[T]=(b==null?void 0:b.join(", "))??c,d[T+".Raw"]=c;const x=r.rasterInfo.attributeTable;if(x!=null){const{fields:w,features:z}=x,R=w.find(({name:m})=>m.toLowerCase()==="value"),g=R?z.find(m=>String(m.attributes[R.name])===c):null;if(g)for(const m in g.attributes)g.attributes.hasOwnProperty(m)&&(d[this._rasterFieldPrefix+m]=g.attributes[m])}const I=r.rasterInfo.dataType;I!=="vector-magdir"&&I!=="vector-uv"||(d["Raster.Magnitude"]=s==null?void 0:s[0],d["Raster.Direction"]=s==null?void 0:s[1]);const f=new F(this.fullExtent.clone(),null,d);f.layer=r,f.sourceLayer=f.layer,p.push(f)}return p}};return n([l()],e.prototype,"layer",void 0),n([l(G)],e.prototype,"timeExtent",void 0),n([l()],e.prototype,"view",void 0),n([l()],e.prototype,"fullExtent",null),n([l()],e.prototype,"tileInfo",void 0),n([l({readOnly:!0})],e.prototype,"hasTilingEffects",null),n([l()],e.prototype,"datumTransformation",null),e=n([S("esri.views.layers.ImageryTileLayerView")],e),e};let h=class extends W(q(_(P(k)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new v("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const i=j(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.tilingSchemeLocked}).then(()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo,a=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t);this.isAlignedMapTile=a;const r=a?t:e.toTileInfo();this.tileInfo=r,this.updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(i)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const i=document.createElement("canvas"),e=i.getContext("2d"),[t,a]=this.tileInfo.size;return i.width=t,i.height=a,e.clearRect(0,0,t,a),e.getImageData(0,0,t,a)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const i=this.tileInfo.lods,e=this.layer.tileInfo.lods,t=i[0].scale,a=e[e.length-1].scale;return this.levelRangeFromScaleRange(t,a)}_getfullExtent(){return this.projectFullExtent(this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference!=null?this.view.basemapTerrain.spatialReference:this.view.spatialReference)}async fetchTile(i,e,t,a){const r=this.tileInfo,u=this._canSymbolizeInWebGL(),y={tileInfo:r,requestRawData:u,signal:a.signal,timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile},p=await this.layer.fetchTile(i,e,t,y);if(p instanceof HTMLImageElement)return p;let o=p&&p.pixelBlock;if(o==null)return this._blankTile;if(!u&&(o=await this.layer.applyRenderer(p),o==null))return this._blankTile;const s=new L([i,e,t],o,r.size[0],r.size[1]);return u?(s.symbolizerRenderer=this.layer.symbolizer.rendererJSON,s.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(i)),s.transformGrid=p.transformGrid):s.isRendereredSource=!0,s.interpolation=this.layer.interpolation,s.bandIds=this.layer.bandIds,s}_getSymbolizerOptions(i){const e=this.tileInfo.lodAt(i).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(i){this._canSymbolizeInWebGL()&&JSON.stringify(i.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(i.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(i.lij[0])))}createFetchPopupFeaturesQueryGeometry(i,e){return A(i,e,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){return O("3d").supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL}};n([l({readOnly:!0})],h.prototype,"_blankTile",null),n([l({readOnly:!0})],h.prototype,"imageFormatIsOpaque",null),n([l({readOnly:!0})],h.prototype,"hasMixedImageFormats",null),n([l({readOnly:!0})],h.prototype,"dataLevelRange",null),h=n([S("esri.views.3d.layers.ImageryTileLayerView3D")],h);const X=h;export{X as default};
