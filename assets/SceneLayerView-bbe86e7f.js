import{c9 as K,by as $,bj as H,ai as c,al as j,aj as p,b3 as L,kk as Q,ao as Y,kl as J,km as W,kn as X,b6 as Z,cS as ee,dH as te,ap as ne,cV as T,cn as k,aF as re,ko as C,dF as se,dG as ie,aD as oe}from"./index-4b03b1b0.js";import{n as v}from"./FeatureLikeLayerView3D-c7be134f.js";import{a as le,n as ae,u as ue}from"./DefinitionExpressionSceneLayerView-5474fc38.js";import{d as de}from"./LayerView-dc80e8d1.js";const ce={setAttribute(){},setGeometry(e){},rollback(){},commit(){}};var E;function Ee(e,n){const t=n.attributes[e.objectIdField],r=e.sessions.get(t);if(r)return r;const s=K(n.attributes),o=new Set;if(t==null)return ce;const a=e.i3sOverrides.createInteractiveEditSession(t),i=new Map,y=(m,b)=>{const f=i.get(m);if(f==null){const u=b.indexOf(t);return i.set(m,u),u}return f};let l=E.EDITING;const g={setAttribute(m,b){if(l!==E.EDITING)return;const f=e.fieldsIndex.get(m);if(!f)return;const u=e.attributeStorageInfo.findIndex(I=>I.name===f.name);if(u<0)return;a.setAttribute(u,b);const d=e.attributeStorageInfo[u];let h=!1;o.add(m),e.forEachNode((I,_)=>{const A=y(I,_);if(A===-1)return;const N=e.getAttributeData(I.index);if(N){const O=N[d.name];O&&(O[A]=b,e.setAttributeData(I.index,N,n),h=!0)}}),h&&e.clearMemCache()},setGeometry(m){l===E.EDITING&&a.setGeometry(m)},rollback(){if(l===E.EDITING){for(const m of o)this.setAttribute(m,s[m]);a.rollback(),l=E.ROLLED_BACK,e.sessions.delete(t)}},commit(){l===E.EDITING&&(a.commit(),l=E.COMMITTED,e.sessions.delete(t))}};return e.sessions.set(t,g),g}function xe(e,n){var f;const t=e.fieldsIndex,r=e.objectIdField,s=e.globalIdField;if(s==null)return;const o=new Map,a=G(n.addedFeatures),i=n.edits.addFeatures,y=D(n.updatedFeatures),l=n.edits.updateFeatures,g=me(t,r,s,(f=n.edits)==null?void 0:f.deleteFeatures),m=D(n.deletedFeatures,g),b=n.edits.deleteFeatures;if(i!=null&&i.length>0)for(const u of i){const d=v(t,u.attributes,s),h=a.get(d);u.geometry!=null&&u.geometry.type==="mesh"&&h!=null&&o.set(h,u.geometry)}if(l!=null&&l.length>0)for(const u of l){const d=v(t,u.attributes,r);u.geometry!=null&&u.geometry.type==="mesh"&&y.has(d)&&o.set(d,u.geometry)}if(b!=null&&b.length>0)for(const u of b){let d=null;d="attributes"in u?v(t,u.attributes,r):u.objectId,d!=null&&m.has(d)&&o.set(d,null)}for(const[u,d]of o)e.i3sOverrides.updateGeometry(u,d)}function ve(e,n){var b;const t=pe(e,n),r=fe(e,n);if(t.size===0&&r.size===0)return;const s=new Map;for(let f=0;f<e.attributeStorageInfo.length;f++)s.set(e.attributeStorageInfo[f].name,f);let o=!1;t.forEach((f,u)=>{const d=e.getAttributeData(u);let h=!1;f.forEach((I,_)=>{const A=d!=null?d[_]:null,N=s.get(_);for(const{featureIndex:O,value:M,featureId:B}of I)A&&(A[O]=M,h=!0,o=!0),e.i3sOverrides.updateAttributeValue(B,N,M)}),h&&e.setAttributeData(u,d,null)}),o&&e.clearMemCache();const{fieldsIndex:a,i3sOverrides:i,objectIdField:y,globalIdField:l}=e,g=(b=i.layer.associatedLayer)==null?void 0:b.infoFor3D,m=new Set(g?[...Object.values(g.assetMapFieldRoles),...Object.values(g.transformFieldRoles)]:[]);for(const[f,u]of r){i.featureAdded(f);const{attributes:d}=u;for(const h in d){if(h!==y&&h!==l&&m.has(h))continue;const I=a.normalizeFieldName(h),_=I!=null?s.get(I):null;if(_==null)continue;const A=d[h];i.updateAttributeValue(f,_,A)}}}function fe(e,{edits:n,addedFeatures:t}){const r=new Map,s=n.addAssetFeatures,{fieldsIndex:o,globalIdField:a}=e;if(!s||s.length===0||a==null)return r;const i=G(t);for(const y of s){const l=v(o,y.attributes,a),g=i.get(l);y.geometry!=null&&y.geometry.type==="mesh"&&g!=null&&r.set(g,y)}return r}function pe(e,n){const t=n.edits.updateFeatures;if(!t||t.length===0)return new R;const r=D(n.updatedFeatures),s=new R,o=new Map;for(let l=0;l<e.attributeStorageInfo.length;l++)o.set(e.attributeStorageInfo[l].name,l);const a=e.fieldsIndex,i=e.objectIdField,y=t.filter(l=>{const g=v(a,l.attributes,i);return r.has(g)});return e.forEachNode((l,g)=>{const m=new Set(g);for(const b of y){const f=v(a,b.attributes,i);if(!m.has(f))continue;const u=g.indexOf(f);for(const d in b.attributes){const h=e.fieldsIndex.normalizeFieldName(d),I=ye(s,l.index,h),_=b.attributes[d];I.push({featureIndex:u,featureId:f,value:_})}}}),s}function ye(e,n,t){const r=ge(e,n),s=t!=null&&r.get(t);if(s)return s;const o=new Array;return r.set(t,o),o}function ge(e,n){const t=e.get(n);if(t)return t;const r=new he;return e.set(n,r),r}function me(e,n,t,r){const s=new Map;if(!r)return s;for(const o of r){let a=null,i=null;"attributes"in o?(a=v(e,o.attributes,n),i=v(e,o.attributes,t)):(a=o.objectId,i=o.globalId),i!=null&&a!=null&&s.set(i,a)}return s}function G(e){const n=new Map;if(!e)return n;for(const t of e)t.globalId!=null&&t.objectId!=null&&t.error==null&&n.set(t.globalId,t.objectId);return n}function D(e,n=null){const t=new Set;if(!e)return t;for(const r of e)if(r.error==null){if(r.objectId!=null&&r.objectId!==-1)t.add(r.objectId);else if(r.globalId!=null&&n!=null){const s=n.get(r.globalId);s!=null&&t.add(s)}}return t}(function(e){e[e.EDITING=0]="EDITING",e[e.ROLLED_BACK=1]="ROLLED_BACK",e[e.COMMITTED=2]="COMMITTED"})(E||(E={}));const he=Map,R=Map;function Ae(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:n},requiredFields:t}=this;return e.outFields?$(n,[...H(n,e.outFields),...t]):$(n,t)}}}}const P=e=>{let n=class extends e{constructor(){super(...arguments),this._numUpdating=0,this._asyncUpdateState=new Map}get updating(){return this._numUpdating>0}autoUpdateAsync(t,r){return be(s=>this._updateAsync(t,s),r)}async _updateAsync(t,r){if(!this._startAsyncUpdate(t)){try{const s=await r();this._set(t,s)}catch{L.getLogger(this).warn(`Async update of "${String(t)}" failed. Async update functions should not throw exceptions.`)}this._endAsyncUpdate(t)&&this._updateAsync(t,r)}}_startAsyncUpdate(t){const r=this._asyncUpdateState.get(t)??w.None;return r&w.Updating?(this._asyncUpdateState.set(t,r|w.Invalidated),!0):(++this._numUpdating,this._asyncUpdateState.set(t,r|w.Updating),!1)}_endAsyncUpdate(t){--this._numUpdating;const r=(this._asyncUpdateState.get(t)??w.None)&~w.Updating;return r&w.Invalidated?(this._asyncUpdateState.set(t,r&~w.Invalidated),!0):(this._asyncUpdateState.set(t,r),!1)}};return c([p({readOnly:!0})],n.prototype,"updating",null),c([p()],n.prototype,"_numUpdating",void 0),n=c([j("esri.core.AsyncUpdate")],n),n};var w;function be(e,n){const t=()=>{o&&!a&&e(r)},r=()=>{if(!o||a)return n();o.clear(),a=!0;const i=J(o,n);return a=!1,i},s=()=>{o&&(o.destroy(),o=null)};let o=new Q(t),a=!1;return e(r),{remove:s}}(function(e){e[e.None=0]="None",e[e.Updating=1]="Updating",e[e.Invalidated=2]="Invalidated"})(w||(w={}));let q=class extends P(Y){};q=c([j("esri.core.AsyncUpdate")],q);const V="esri.views.3d.layers.support.SceneLayerViewRequiredFields";let x=class extends P(Z){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:n},rendererFields:t,labelingFields:r,viewFilterFields:s}=this;return $(e,[...n??[],...t??[],...r??[],...s??[]])}constructor(e){super(e)}initialize(){this.handles.add([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:n}=this.layer;return n?U(t=>n.collectRequiredFields(t,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?U(n=>W(n,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,filter:n}=this.layerView;return U(t=>X(t,e,n))})])}};async function U(e){const n=new Set;try{return await e(n),Array.from(n).sort()}catch(t){return L.getLogger(V).error(t),null}}c([p()],x.prototype,"layerView",void 0),c([p()],x.prototype,"layer",null),c([p()],x.prototype,"requiredFields",null),c([p()],x.prototype,"rendererFields",void 0),c([p()],x.prototype,"labelingFields",void 0),c([p()],x.prototype,"viewFilterFields",void 0),x=c([j(V)],x);const z="esri.views.layers.SceneLayerView",S=L.getLogger(z);let F=class extends de{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return le(this._layerFilter)}get _layerFilter(){const e=this.layer.filter;if(e==null||e.geometries.length<1)return null;const n=this._geometryEngine;if(n==null||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return ae;const t=e.geometries.at(0).spatialReference,r=e.geometries.toArray().map(i=>{try{i=n.simplify(i)}catch{return S.warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(i==null)return null;if(i.spatialReference.equals(t))return i;try{return ee(i,t)}catch{return S.warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(te).sort((i,y)=>i.extent.xmin-y.extent.xmin),s=new Set,o=new Array,a=new Array;for(let i of r){const y=i.extent.xmin;if(o.length=0,s.forEach(l=>{if(y>=l.extent.xmax)return a.push(l),void s.delete(l);i.extent.ymin<=l.extent.ymax&&i.extent.ymax>=l.extent.ymin&&n.intersects(i,l)&&o.push(l)}),o.length>0){o.push(i);try{i=n.union(o)}catch{S.warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}o.pop(),o.forEach(l=>s.delete(l))}s.add(i)}return s.forEach(i=>a.push(i)),a.length>0?{spatialRelationship:e.spatialRelationship,geometries:a}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;const n=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:t})=>!t.equals(n)&&!ne(t,n))}get layerFilterUpdating(){return ue(this._layerFilter)}initialize(){const{signal:e}=this._abortController;T(()=>{var n,t,r;return this.destroyed||!this._geometryEngine&&((r=(t=(n=this.layer)==null?void 0:n.filter)==null?void 0:t.geometries)==null?void 0:r.length)},e).then(async()=>{k(e),this._geometryEngine=await re(()=>import("./geometryEngine-9bdf7794.js"),["./geometryEngine-9bdf7794.js","./geometryEngineBase-8afca563.js","./index-4b03b1b0.js","./index-0de4b476.css","./hydrated-4fea88d3.js"],import.meta.url)}).catch(C),this._projectionEngineLoaded=se(),T(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(async()=>{k(e),await ie(),this._projectionEngineLoaded=!0}).catch(C)}destroy(){this._abortController=oe(this._abortController)}highlight(e){throw new Error("Not implemented")}queryFeatures(e,n){throw new Error("Not implemented")}queryObjectIds(e,n){throw new Error("Not implemented")}queryFeatureCount(e,n){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,n){throw new Error("Not implemented")}};c([p()],F.prototype,"layer",void 0),c([p()],F.prototype,"availableFields",null),c([p()],F.prototype,"maximumNumberOfFeatures",null),c([p({readOnly:!0})],F.prototype,"maximumNumberOfFeaturesExceeded",null),c([p()],F.prototype,"filter",void 0),c([p({readOnly:!0})],F.prototype,"layerFilter",null),c([p({readOnly:!0})],F.prototype,"_layerFilter",null),c([p()],F.prototype,"_geometryEngine",void 0),c([p()],F.prototype,"_projectionEngineLoaded",void 0),c([p()],F.prototype,"_filterNeedsProjectionEngine",null),c([p()],F.prototype,"layerFilterUpdating",null),F=c([j(z)],F);const Oe=F;export{Ae as i,Oe as j,ve as l,x as p,Ee as r,xe as s};
