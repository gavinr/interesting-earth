import{g2 as Y,g3 as X,e_ as G,b4 as k,dt as L,g4 as fe,et as he,g5 as pe,eV as de,bB as ye,g6 as ge,g7 as me,cb as be,g8 as Se,aq as b,g9 as we,a_ as ee,ap as Me,fh as $,ga as v,gb as K,ev as x,b2 as T,gc as te,eY as W,gd as Te,ge as ne,gf as ae,gg as Ee,ex as re,gh as ve,ey as oe,gi as j,gj as xe,gk as Ie,gl as P,gm as Re,aR as Ce,gn as qe,go as Ne,du as B,aZ as Z,eZ as E,gp as _,fT as ze}from"./index-4b03b1b0.js";import{b as ke}from"./Query-cdee9722.js";import{I as We}from"./I3SBinaryReader-2204e87b.js";function Oe(e,t,n,a){const r=Ue(e,t,n),o=G();return Y(n,r,o,a),o}const se=1,H=5-se;function Ue(e,t,n){const a=k(),r=e[3],o=2**(Math.ceil(Math.log(r)*Math.LOG2E/H)*H+se);if(n.isGeographic){const l=o/X(n).radius*180/Math.PI,u=Math.round(e[1]/l),p=Math.max(-90,Math.min(90,u*l)),h=l/Math.cos((Math.abs(p)-l/2)/180*Math.PI),y=Math.round(e[0]/h)*h;a[0]=y,a[1]=p}else{const l=Math.round(e[0]/o),u=Math.round(e[1]/o);a[0]=l*o,a[1]=u*o}const s=e[2]+t,i=Math.round(s/o);return a[2]=i*o,a}function ie(e){return e?parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10):void 0}function ut(e){var t;if(be("disable-feature:i3s-draco")||!e)return!1;for(const n of e)for(const a of n.geometryBuffers)if(((t=a.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0;return!1}function ft(e,t,n,a){n.traverse(t,r=>{const o=r.mbs;return(o!=null&&_e(e,o))!==M.OUTSIDE&&(a(r),!0)})}function ht(e,t,n){let a=0,r=0;for(let o=0;o<t.length&&a<e.length;o++)e[a]===t[o]&&(n(o)&&(e[r]=e[a],r++),a++);e.length=r}function pt(e,t,n){let a=0,r=0;for(;a<n.length;)Se(e,n[a])>=0===t&&(n[r]=n[a],r++),a++;n.length=r}const I=L();function dt(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return I[0]=(e[0]-t.position[0])/t.rotationScale[0],I[1]=(e[1]-t.position[1])/t.rotationScale[4],I[2]=(e[2]-t.position[0])/t.rotationScale[0],I[3]=(e[3]-t.position[1])/t.rotationScale[4],I}var M;function _e(e,t){const n=t[0],a=t[1],r=t[3],o=e[0]-n,s=n-e[2],i=e[1]-a,l=a-e[3],u=Math.max(o,s,0),p=Math.max(i,l,0),h=u*u+p*p;return h>r*r?M.OUTSIDE:h>0?M.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,s,i,l)>r?M.INSIDE:M.INTERSECTS_CENTER_INSIDE}function De(e,t,n){const a=[],r=n&&n.missingFields,o=n&&n.originalFields;for(const s of e){const i=s.toLowerCase();let l=!1;for(const u of t)if(i===u.name.toLowerCase()){a.push(u.name),l=!0,o&&o.push(s);break}!l&&r&&r.push(s)}return a}async function yt(e,t,n,a,r){if(t.length===0)return[];const o=e.attributeStorageInfo;if(e.associatedLayer!=null)try{return await Fe(e.associatedLayer,t,n,a)}catch(s){if(e.associatedLayer.loaded)throw s}if(o){const s=Ae(t,n,r);if(s==null)throw new b("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const i=e.parsedUrl.path;return(await Promise.all(s.map(l=>Ge(i,o,l.node,l.indices,a).then(u=>{for(let p=0;p<l.graphics.length;p++){const h=l.graphics[p],y=u[p];if(h.attributes)for(const f in h.attributes)f in y||(y[f]=h.attributes[f]);h.attributes=y}return l.graphics})))).flat()}throw new b("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function Ae(e,t,n){const a=new Map,r=[],o=n();for(const s of e){const i=s.attributes[t];for(let l=0;l<o.length;l++){const u=o[l],p=u.featureIds.indexOf(i);if(p>=0){let h=a.get(u.node);h||(h={node:u.node,indices:[],graphics:[]},r.push(h),a.set(u.node,h)),h.indices.push(p),h.graphics.push(s);for(let y=l;y>0;y--)o[y]=o[y-1];o[0]=u;break}}}return r}async function Fe(e,t,n,a){t.sort((l,u)=>l.attributes[n]-u.attributes[n]);const r=t.map(l=>l.attributes[n]),o=[],s=De(a,e.fields,{originalFields:o}),i=await le(e,r,s);for(let l=0;l<t.length;l++){const u=t[l],p=i[l],h={};if(u.attributes)for(const y in u.attributes)h[y]=u.attributes[y];for(let y=0;y<o.length;y++)h[o[y]]=p[s[y]];u.attributes=h}return t}function le(e,t,n){const a=e.capabilities.query.maxRecordCount;if(a!=null&&t.length>a){const o=we(t,a);return Promise.all(o.map(s=>le(e,s,n))).then(s=>s.flat())}const r=new ke({objectIds:t,outFields:n,orderByFields:[e.objectIdField]});return e.queryFeatures(r).then(o=>{if(o&&o.features&&o.features.length===t.length)return o.features.map(s=>s.attributes);throw new b("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function Ge(e,t,n,a,r){return Le(e,t,n.resources.attributes,a,r)}function Le(e,t,n,a,r){const o=[];for(const s of t)if(s&&r.includes(s.name)){const i=`${e}/nodes/${n}/attributes/${s.key}/0`;o.push({url:i,storageInfo:s})}return de(o.map(s=>ye(s.url,{responseType:"array-buffer"}).then(i=>We(s.storageInfo,i.data)))).then(s=>{const i=[];for(const l of a){const u={};for(let p=0;p<s.length;p++){const h=s[p].value;h!=null&&(u[o[p].storageInfo.name]=je(h,l))}i.push(u)}return i})}(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"})(M||(M={}));const $e=-32768,Ke=-(2**31);function je(e,t){if(!e)return null;const n=e[t];return ge(e)?n===$e?null:n:me(e)?n===Ke?null:n:n!=n?null:n}function Pe(e){const t=e.store,n=t.indexCRS||t.geographicCRS,a=n===void 0?t.indexWKT:void 0;if(a){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(a!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=n?new ee(ie(n)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function Be(e){const t=e.store,n=t.vertexCRS||t.projectedCRS,a=n===void 0?t.vertexWKT:void 0;if(a){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(a!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=n?new ee(ie(n)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function gt(e,t){return t==null?"@null":t===v(t)?"@ECEF":e.equals(t)?"":t.wkid!=null?"@"+t.wkid:null}function A(e,t,n){if(!Me(e,t))throw new b("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if(n==="local"&&!Ze(e,t))throw new b("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function mt(e,t,n){var a,r;if(((a=e.serviceUpdateTimeStamp)==null?void 0:a.lastUpdate)!==((r=t.serviceUpdateTimeStamp)==null?void 0:r.lastUpdate)||!n.isEmpty||$(e.associatedLayer,o=>o.url)!==$(t.associatedLayer,o=>o.url))throw new b("layerview:recycle-failed")}function Ze(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function He(e,t,n){const a=Pe(e),r=Be(e);A(a,t,n),A(r,t,n)}function Je(e){return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function bt(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Je(e.store.defaultGeometrySchema))throw new b("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function St(e,t){He(e,t.spatialReference,t.viewingMode)}function Qe(e){return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function wt(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Qe(e.store.defaultGeometrySchema))throw new b("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function Mt(e,t){A(e.spatialReference,t.spatialReference,t.viewingMode)}function Ve(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function Ye(e){return e.type==="mesh-3d"}function Tt(e){if(e==null||!Ve(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.getSymbols();if(t.length===0)return!0;for(const n of t){if(!Ye(n)||n.symbolLayers.length===0)return!0;for(const a of n.symbolLayers.items)if(a.type!=="fill"||a.material==null||a.material.color==null||a.material.colorMixMode!=="replace")return!0}return!1}const Et=fe({color:[0,0,0,0],opacity:0});class Xe{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function vt(e){const t=new Xe;let n=!1,a=!1;for(const r of e.symbolLayers.items)if(r.type==="fill"&&r.enabled){const o=r.material,s=r.edges;if(o!=null&&!n){const i=o.color,l=Ie(o.colorMixMode);t.material=i!=null?{color:[i.r/255,i.g/255,i.b/255],alpha:i.a,colorMixMode:l}:{color:[1,1,1],alpha:1,colorMixMode:P.Multiply},t.castShadows=r.castShadows,n=!0}s==null||a||(t.edgeMaterial=Re(s,{}),a=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:P.Multiply}),t}function xt(e,t){return(0|e)+(0|t)|0}function et(e,t,n,a,r=0){a===v(a)?t.isGeographic?st(e,n,t,r):ot(e,n,t,r):t.isWGS84&&(a.isWebMercator||K(a))?tt(t,e,a,n,r):t.isWebMercator&&K(a)?rt(t,e,a,n,r):e===n?(n.center[2]+=r,x(n.center,t,0,n.center,a,0,1)):(T(n.center,e.center[0],e.center[1],e.center[2]+r),x(n.center,t,0,n.center,a,0,1),te(n.quaternion,e.quaternion),W(n.halfSize,e.halfSize))}function tt(e,t,n,a,r){W(w,t.center),w[2]+=r;const o=v(n);x(w,e,0,w,o,0,1),ce(o,t,w,n,a)}const z=new Array(24),nt=new Ce(z,3,!0),J=k(),w=k(),at=qe();function rt(e,t,n,a,r){W(w,t.center),w[2]+=r,ce(e,t,w,n,a)}function ce(e,t,n,a,r){const o=Te(at,t.quaternion);for(let s=0;s<8;++s){for(let i=0;i<3;++i)J[i]=t.halfSize[i]*(s&1<<i?-1:1);for(let i=0;i<3;++i){let l=n[i];for(let u=0;u<3;++u)l+=J[u]*o[3*u+i];z[3*s+i]=l}}x(z,e,0,z,a,0,8),ne(nt,r)}function ot(e,t,n,a){ae(e,F),T(t.center,e.center[0],e.center[1],e.center[2]+a),Y(n,t.center,m,v(n)),T(t.center,m[12],m[13],m[14]);const r=2*Math.sqrt(1+m[0]+m[5]+m[10]);S[0]=(m[6]-m[9])/r,S[1]=(m[8]-m[2])/r,S[2]=(m[1]-m[4])/r,S[3]=.25*r,Ee(t.quaternion,S,e.quaternion),re(S,t.quaternion);let o=0,s=0,i=0;for(const l of F)l[2]+=a,x(l,n,0,l,v(n),0,1),ve(c,l,t.center),oe(c,c,S),o=Math.max(o,Math.abs(c[0])),s=Math.max(s,Math.abs(c[1])),i=Math.max(i,Math.abs(c[2]));T(t.halfSize,o,s,i)}function st(e,t,n,a){const r=X(n),o=1+Math.max(0,a)/(r.radius+e.center[2]);T(t.center,e.center[0],e.center[1],e.center[2]+a),x(t.center,n,0,t.center,v(n),0,1),te(t.quaternion,e.quaternion),re(S,e.quaternion),T(c,0,0,1),oe(c,c,S),T(c,e.halfSize[0]*Math.abs(c[0]),e.halfSize[1]*Math.abs(c[1]),e.halfSize[2]*Math.abs(c[2])),j(c,c,r.inverseFlattening),xe(t.halfSize,e.halfSize,c),j(t.halfSize,t.halfSize,o)}function It(e,t,n,a,r,o){if(!o||o.length===0||t==null||!e.mbs)return null;const s=Oe(e.mbs,r,n,t);Ne(N,s);let i=null;const l=()=>{if(!i)if(i=F,B(q),e.serviceObb!=null){et(e.serviceObb,n,Q,t,r),ae(Q,i);for(const f of i)E(f,f,N),_(q,f)}else{const f=e.mbs;if(!f)return;const d=f[3];Z(f,n,c,t),E(c,c,N),c[2]+=r;for(let g=0;g<8;++g){const R=1&g?d:-d,O=2&g?d:-d,U=4&g?d:-d,C=i[g];W(C,[c[0]+R,c[1]+O,c[2]+U]),_(q,C)}}};let u=1/0,p=-1/0;const h=f=>{if(f.type!=="replace")return;const d=f.geometry;if(!(d!=null&&d.hasZ))return;B(D);const g=d.spatialReference||a,R=d.rings.reduce((O,U)=>U.reduce((C,ue)=>(Z(ue,g,c,t),E(c,c,N),_(D,c),Math.min(c[2],C)),O),1/0);l(),ze(q,D)&&(u=Math.min(u,R),p=Math.max(p,R))};if(o.forEach(f=>h(f)),u===1/0)return null;const y=(f,d,g)=>{E(c,g,s),f[d]=c[0],f[d+1]=c[1],f[d+2]=c[2],d+=24,g[2]=u,E(c,g,s),f[d]=c[0],f[d+1]=c[1],f[d+2]=c[2],d+=24,g[2]=p,E(c,g,s),f[d]=c[0],f[d+1]=c[1],f[d+2]=c[2]};for(let f=0;f<8;++f)y(V.data,3*f,i[f]);return ne(V)}function Rt(e){return e!=null&&e.halfSize[0]>=0}function Ct(e){return e[3]>=0}function qt(e){e!=null&&(e.halfSize[0]=-1)}function Nt(e){e!=null&&(e[3]=-1)}const m=G(),S=he(),F=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],D=L(),q=L(),Q=pe(),c=k(),V={data:new Array(72),size:3,exclusive:!0,stride:3},N=G();export{qt as $,Rt as B,et as C,ft as H,ht as J,It as K,Mt as M,Ct as P,Nt as Q,St as T,vt as U,pt as V,dt as Y,ut as Z,Oe as a,Ue as b,A as d,M as e,je as f,He as g,gt as h,Et as j,xt as k,Le as l,Be as m,yt as n,Pe as p,De as r,_e as t,wt as v,bt as w,Tt as x,mt as y};
