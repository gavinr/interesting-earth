import{b3 as se,ad as it,gi as st,gj as oe,gk as le,bL as rt,r as m,b$ as at,b9 as ue,gl as nt,Z as R,gm as ot,t as _,a8 as re,e as o,d as l,n as M,y as Ie,u as Me,an as lt,aw as ut,ay as Ne,f as D,aX as ee,w as C,aB as Ve,bP as ht,aC as dt,gn as ct,go as pt,bb as mt,E as te,a4 as he,gp as ft,bv as Ae,gq as gt,gr as yt,b2 as _t,gs as Ft,P as V,T as A,v as Et,g as B,a as xt,j as Tt,bG as vt,c as Rt,F as de,h as O,K as S,az as bt,aJ as Le,x as w,G as L,U as ie,bR as wt,gt as Ct,gu as Dt,eA as ce,c1 as St,a3 as pe,c2 as Ue,gv as Pt,gw as Ot,ca as me,cb as H,c7 as $,cg as qe,bj as Ge,cl as He,cm as ze,cn as je,co as Qe,gx as $t,cu as Be,gy as It,gz as Mt,gA as Nt,gB as Vt,gC as At,gD as fe,gE as U,gF as Lt,gG as ge,gH as k,bX as ye,gI as Ut,gJ as qt,gK as Gt,gL as Ht,er as zt,gM as I,gN as jt,gO as Qt,c3 as Bt,bN as x,cj as kt,ch as Wt,gP as Xt,ci as _e,cz as Yt,cH as Zt,gQ as Jt,cA as Kt,bm as ei,bl as ti,gR as ii,gS as si,gT as ri,gU as ai,gV as ni,gW as oi,gX as li,i as ui,p as ke,k as hi,H as We,gY as Fe,gZ as di,g_ as Ee,cL as P,g$ as ci,h0 as pi,h1 as mi,a0 as fi,h2 as xe,$ as Te,h3 as gi,bV as ve,h4 as yi,h5 as _i,bZ as Fi,bM as Ei,h6 as xi,ag as Ti,f6 as vi,aj as Ri,C as bi,aH as q}from"./index.a8738f47.js";import{o as Xe}from"./dehydratedFeatureComparison.47577290.js";import{l as wi,F as Ci}from"./Graphics3DFeatureProcessor.cae1d677.js";import{u as Di}from"./FeatureStore.b55521bf.js";import{l as Si}from"./projectExtentUtils.4c0871bc.js";class Pi{constructor(t,i){this.highestResolutionVersion=null,this.versions=[],this.ref(t,i)}get isReferenced(){return this.versions.length!==0}get isSingle(){return this.versions.length===1&&this.versions[0].refCount===1}ref(t,i){const s=this.feature;E.oldVersion=s,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0});for(const a of this.versions)if(a.resolution===i){a.refCount++;const n=this.highestResolutionVersion===a&&!Xe(t,a.feature);return(n||this.highestResolutionVersion!==a)&&(a.feature=t),E.newVersion=n?t:s,E}const r={feature:t,resolution:i,refCount:1};return this.versions.push(r),!this.highestResolutionVersion||i<this.highestResolutionVersion.resolution?(E.newVersion=t,this.highestResolutionVersion=r):E.newVersion=s,E}unref(t){for(let i=0;i<this.versions.length;i++){const s=this.versions[i];if(s.resolution===t)return s.refCount--,E.oldVersion=this.feature,s.refCount===0&&(this.versions[i]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===s&&(this._recalculateHighestResolutionVersion(),E.oldVersion=s.feature)),E.newVersion=this.feature,E}return null}get feature(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(this.versions.length===0)return void(this.highestResolutionVersion=null);let t=this.versions[0];for(let i=1;i<this.versions.length;i++){const s=this.versions[i];s.resolution<t.resolution&&(t=s)}this.highestResolutionVersion=t}}class Oi{constructor(t){this._feature=t,this.refCount=1}get isReferenced(){return this.refCount!==0}get isSingle(){return this.refCount===1}ref(t){return++this.refCount,E.oldVersion=this._feature,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0}),Xe(this._feature,t)||(this._feature=t),E.newVersion=this._feature,E}unref(){return E.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(E.newVersion=null,E):(E.newVersion=this._feature,E)}get feature(){return this._feature}}const E={oldVersion:null,newVersion:null},$i=16438,Re=new Set;class Ii{constructor(t){this.descriptor=t,this.fetchStatus=f.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=W,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=Re,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(t){this._displayingFeatures=t,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(t){this._featureLimit!==t&&(this._featureLimit=t,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(t,i,s){this._availableFields=it(s,Re),this._features=t,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,t&&t.length>0?(this._emptyFeatureRatio=i/(t.length+i),this._numVertices=t.reduce((r,a)=>r+st(a.geometry),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(t){this._numFeatures=t}get hasPreciseFeatureCount(){return this._numFeatures>W}get needsFeatureCount(){return this._numFeatures===W}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const i=oe(this._features[t]);this._estimatedSize+=i,t>=this.featureLimit&&(this._estimatedUnusedSize+=i)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=oe(this._features[t]);return!0}return!1}get isFetching(){return this.fetchStatus===f.FETCHING||this.fetchStatus===f.REFETCHING}get isRefetching(){return this.fetchStatus===f.REFETCHING}get needsFetching(){return this.fetchStatus===f.FETCH_NEEDED||this.fetchStatus===f.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===f.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===f.DONE||this.fetchStatus===f.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===f.REFETCHING?f.REFETCH_NEEDED:f.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!Ni(this._features,this.displayingFeatures,this.featureLimit)}intersects(t){return!t||!this.descriptor.extent||(le(t,be),rt(this.descriptor.extent,be))}intersectionIncludingBorrowed(t,i){const s=m(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return t||s?(t?(le(t,i),at(i,s,i)):ue(i,s),i):(ue(i,nt),i)}_shuffle(t){this._features.sort((i,s)=>R(i,t)-R(s,t)),ot(this._features,$i),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(t,i,s){if(t<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let r=!1;this.featureLimit=Math.ceil(this.numFeatures*t),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===f.DONE&&this._features.length>0&&(this.fetchStatus=f.REFETCH_NEEDED,r=!0)),!this._shuffled&&t<1&&this._shuffle(s);const a=Math.max(this.featureLimit,Math.ceil(i*this.numFeatures));return this._features.length>a&&(this._features.length=a,this.featuresMissing=!0,this.fetchStatus===f.FULL&&(this.fetchStatus=f.DONE)),r}get cache(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._numFeatures=t.numFeatures,this._emptyFeatureRatio=t.emptyFeatureRatio,this.fetchStatus=t.fetchStatus,this.featuresMissing=t.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const W=-1,Mi=-2;var f;function Ni(e,t,i){if(_(t)||_(e)||i!==t.length||i>e.length)return!1;for(let s=0;s<i;++s)if(e[s]!==t[s])return!1;return!0}(function(e){e[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL"})(f||(f={}));const be=se(),X=re.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");let F=class extends Ie{constructor(e){super(e),this._useTileCount=!1,this.updating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this.handles=new Me,this._frameTask=lt,this._dirty=!1,this.featureTiles=new Map,this.displayingFeatureReferences=new Map,this.numDisplayingFeatureReferences=0,this.suspended=!0,this.pendingEdits=null}set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&m(this.context.query.queryFeatureCount)}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.estimatedUnusedSize),e}get totalVertices(){let e=0;return this.featureTiles.forEach(t=>e+=t.numVertices),e}get totalFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.numFeatures),e}set filterExtent(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void X.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}initialize(){this.handles.add(ut(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty()})),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?Pi:Oi;const e=this.context.scheduler;m(e)&&(this._frameTask=e.registerTask(Ne.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){this._frameTask.remove(),this.handles=D(this.handles),this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._removeTile(e)}),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}get paused(){return this.suspended||!!this.pendingEdits}restart(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)}),m(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._resetFetchTile(e)}),m(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this.suspended||(this.suspended=!0,this._pause(),this._setDirty())}resume(){this.suspended&&(this.suspended=!1,this._unpause())}_pause(){this.paused&&(this.featureTiles.forEach(e=>this._cancelFetchTile(e)),this._updated())}_unpause(){this.paused||(this._setDirty(),this._updated())}get availableFields(){let e=null;return this.featureTiles.forEach(t=>{_(t.displayingFeatures)||t.displayingFeatures.length===0||(_(e)?e=new Set(t.availableFields):e.forEach(i=>{t.availableFields.has(i)||ee(e).delete(i)}))}),m(e)?e:new Set}applyEdits(e){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this.pendingEdits;t.count++;const i=t.edits.then(()=>e.result.catch(s=>{if(C(s))throw s;return null}).then(s=>s&&(this._applyEditsDeleteFeatures(s.deletedFeatures),this._applyEditsAddUpdateFeatures(s.addedFeatures,s.updatedFeatures,t.controller.signal).then(()=>s))).then(s=>(--t.count==0&&(this.pendingEdits===t&&(this.pendingEdits=null),m(this.context.memoryCache)&&this.context.memoryCache.clear(),this._unpause(),this._updated()),s)));return t.edits=i,this._updated(),i}_applyEditsDeleteFeatures(e){if(e.length===0)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),s=new Set,r=this.objectIdField;e.forEach(({objectId:a,globalId:n})=>{if((!a||a<0)&&t){i||X.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);const u=this.features.find(d=>d.attributes&&d.attributes[t]===n);u&&s.add(R(u,r))}else s.add(a)}),this.featureTiles.forEach(a=>{if(!a.features)return;const n=a.features.filter(u=>!s.has(R(u,this.objectIdField)));n.length!==a.features.length&&(a.setFeatures(n,0,a.availableFields),this._invalidateCounts())})}async _applyEditsAddUpdateFeatures(e,t,i){const s=[],r=new Set;if(e.forEach(n=>s.push(n.objectId)),t.forEach(n=>{s.push(n.objectId),r.add(n.objectId)}),s.length===0)return;const a=[];this.featureTiles.forEach(n=>{const u=this._applyEditsAddUpdateTile(n,s,r,i);u&&a.push(u)}),await Ve(a)}async _applyEditsAddUpdateTile(e,t,i,s){if(!e.features)return;const r=this._createQuery(e);r.resultType=void 0,r.cacheHint=!1,r.objectIds=t;const a=await this._queryFeatures(r,s);let n=null;if(i.size>0){const u=e.features.filter(d=>!i.has(R(d,this.objectIdField)));u.length!==e.features.length&&(n=u)}if(a.features.length>0){n||(n=e.features.slice());for(const u of a.features)n.push(u)}n&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,n.length)),e.setFeatures(n,0,we(e.availableFields,a.fields)),this._invalidateCounts())}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:qi})}_setDirty(){this._dirty=!0,this._updated()}get running(){return this.updating}runTask(e){if(this._frameTask.processQueue(e),!this._dirty||!this.constructed)return;this._dirty=!1;const t=this._getListOfTiles();if(this._markTilesNotAlive(t),!e.run(()=>this._addTiles(t,e))||!e.run(()=>this._filterExtentTiles(t,e))||!e.run(()=>this._removeTiles(t,e))||e.done)return void this._setDirty();const i=this._sortTiles(t);e.run(()=>this._displayTiles(i,e))&&e.run(()=>this._fetchTiles(i,e))&&e.run(()=>this._updateMemoryEstimates(i,e))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!this.suspended&&(this.tileDescriptors.forEach(i=>{const s=this.featureTiles.get(i.id);s?s.alive=!0:t.done||(e.push(this._addTile(i)),t.madeProgress())}),t.hasProgressed)}_filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this._clearTile(i),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const s=e[i];s.alive||(this._removeTile(s),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort((t,i)=>t.descriptor.loadPriority-i.descriptor.loadPriority),e}_displayTiles(e,t){const i=this._updateRatio(e),s=r=>{const a=this._fullRatio<1?i(r)*this._farRatio:1;return r.reduceFeatures(a,this.memoryFactor,this.objectIdField)&&this._setDirty(),this._showTile(r)};for(const r of e)if(!t.run(()=>s(r))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this.paused)return!1;let i=!1;for(const s of e){if(!s.needsFetching)continue;const r=m(this.context.memoryCache)?this.context.memoryCache.pop(s.id):null;if(m(r))s.cache=r,this._setDirty(),this._scheduleUpdated(),t.madeProgress();else{if(this._needsNumFeatures(s)){const a=new AbortController,n=this._fetchTileCount(s,a.signal);this._handleRequest(s,n,a,()=>s.numFeatures=Mi),i=!0,t.madeProgress()}if(t.done)return!0}}if(i)return t.hasProgressed;for(const s of e)if(s.needsFetching){const r=new AbortController,a=this._fetchTile(s,r.signal);if(this._handleRequest(s,a,r,n=>{s.setFeatures([],0,null),this._invalidateCounts(),s.featuresMissing=!1,this.context.logFetchError(X,n)}),t.madeProgress(),t.done)return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some(i=>!t.run(()=>i.updateMemoryEstimates())&&(this._setDirty(),!0)),t.hasProgressed}_reclip(e,t){if(!this.constructed)return;const i=new Array;this.featureTiles.forEach(s=>{_(s.displayingFeatures)||s.displayingFeatures.length===0||(s.intersectionIncludingBorrowed(t,Ce),s.intersectionIncludingBorrowed(e,De),ht(Ce,De)||i.push(s))}),this._refreshDisplayingFeatures(i),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,i=this.changes.updates;for(const s of e)if(!_(s.displayingFeatures))for(const r of s.displayingFeatures){const a=R(r,this.objectIdField);if(t.has(a))continue;t.add(a);const{feature:n}=this.displayingFeatureReferences.get(a);i.removes.push(n),i.adds.push(n)}this._applyChanges()}_updated(){let e=0;this.paused||this.featureTiles.forEach(i=>i.isFetching?++e:0);const t=this._dirty||e>0||!!this.pendingEdits;if(this._set("updating",t),t){let i=0,s=0,r=0,a=0,n=0;const u=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach(h=>{if(++s,h.isFetching&&h.hasPreciseFeatureCount){const y=this._maximumFeaturesForTile(h)*(1-h.emptyFeatureRatio),T=m(h.displayingFeatures)?h.displayingFeatures.length*u:0;n+=y-T}h.needsFetching?++a:h.numFeatures>0&&(++r,i+=h.numFeatures)}),a+=e;let d=0,c=0;i?(c=i,d=Math.min(a*i/r,i)):(c=s,d=a),n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",c),this._set("updatingRemaining",d),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const e=dt(this.featureTiles,t=>t.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",e)}_updateRatio(e){const t=Vi(e),i=a=>1/(1<<Math.max(0,t-a.descriptor.lij[0]));let s=0,r=0;for(const a of e){const n=a.numFeatures;s+=n,r+=n*i(a)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/s),this._farRatio=this.maximumNumberOfFeatures/r,this._scheduleUpdated(),i}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this.featureTiles.forEach(i=>{if(!i.featuresMissing)return;const s=this._maximumFeaturesForTile(i);i.features&&(i.features.length>=s||i.fetchStatus===f.FULL)||(this._cancelFetchTile(i),this._resetFetchTile(i))}),this._setDirty())}_addTile(e){const t=new Ii(e);return this.featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this.featureTiles.forEach(i=>{if(!(_(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!ct(e.descriptor.lij,i.descriptor.lij))){_(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&(_(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=pt(e.descriptor.extent)),mt(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const s of i.displayingFeatures){e.displayingFeatures.push(s);const r=this.displayingFeatureReferences.get(R(s,this.objectIdField));r.ref(r.feature,t),this.numDisplayingFeatureReferences++}}}),e.featureLimit=m(e.displayingFeatures)?e.displayingFeatures.length:0}_removeTile(e){this._clearTile(e),this.featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=f.DONE):e.fetchStatus=f.FETCH_NEEDED}_cancelFetchTile(e){const t=e.requestController;m(t)&&(e.requestController=null,e.resetFetching(),t.abort())}async _fetchTileCount(e,t){return e.numFeatures=await this._fetchCount(e,t),this._updateRatio(this._getListOfTiles()),e.fetchStatus===f.REFETCHING?f.REFETCH_NEEDED:f.FETCH_NEEDED}async _fetchTile(e,t){const i=this._maximumFeaturesForTile(e);if(i<=0)return Li(e);const s=this._getMaxRecordCount(e),r=Math.ceil(i/s);if(Y(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=i&&r>te.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(e,t);const a=this._createQuery(e);if(a.maxRecordCountFactor=Math.ceil(i/s),e.isRefetching&&e.features&&e.features.length>0){const h=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/s);a.maxRecordCountFactor=Math.max(h+1,a.maxRecordCountFactor)}const{features:n,exceededTransferLimit:u,fields:d}=await this._queryFeatures(a,t),c=u?a.maxRecordCountFactor>=te.MAX_MAX_RECORD_COUNT_FACTOR?f.FULL:f.DONE:f.FULL;return await this._frameTask.schedule(()=>{e.featuresMissing=n.length<e.numFeatures||u;const h=this._removeEmptyFeatures(n);e.setFeatures(n,h,Ye(d))},t),he(t),this._invalidateCounts(),c}async _fetchCount(e,t){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(e),{signal:t})}async _fetchPagedTile(e,t){let i,s=0,r=0,a=0,n=this._maximumFeaturesForTile(e)-a;const u=this._getMaxRecordCount(e);let d=null;for(;;){const c=this._createQuery(e),h=this._setPagingParameters(c,s,n,u),{features:y,exceededTransferLimit:T,fields:N}=await this._queryFeatures(c,t);if(await this._frameTask.schedule(()=>{h&&(s+=ee(c.num)),a+=y.length,r+=this._removeEmptyFeatures(y),e.featuresMissing=s<e.numFeatures||T,i=i?i.concat(y):y,d=we(d,N),e.setFeatures(i,r,d)},t),he(t),this._invalidateCounts(),this._setDirty(),n=this._maximumFeaturesForTile(e)-a,!h||!T||n<=0)return T?f.DONE:f.FULL}}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;if(i){const s=this.context.tilingScheme.spatialReference;t.geometry=ft(i,s)}return this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}_setPagingParameters(e,t,i,s){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/s),e.num=Math.min(e.maxRecordCountFactor*s,i)):e.num=Math.min(s),!0)}_getEffectiveTileResolution(e){if(e.descriptor.resolution==null)return null;const t=this.context.viewingMode===Ae.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&this.context.geometryType!=="point"}_setResolutionParams(e,t){if(!this.supportsResolution)return;const i=this._getEffectiveTileResolution(t);i!=null&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new gt({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):this.context.geometryType==="polyline"&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let i=0;i<e.length;){const s=e[i];yt(s.geometry)?++i:(e[i]=e[e.length-1],--e.length)}return t-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!Y(e)}_getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this._useTileQuery(e)&&m(t)&&t>0&&this.context.capabilities.supportsResultType?t:m(i)&&i>0?i:Ui}_useTileQuery(e){return(!Y(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,s){e.fetchStatus=e.needsRefetching?f.REFETCHING:f.FETCHING,e.requestController=i;let r=!1;t.then(a=>{e.requestController=null,e.fetchStatus=a}).catch(a=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=f.DONE),C(a)?r=!0:s(a)}).then(()=>{r||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(_t(()=>{this.handles.remove("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(e){if(m(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;const t=e.features;if(e.featureLimit===0||!t){const n=m(e.displayingFeatures)&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],n}const i=e.descriptor.resolution,s=this.changes.updates,r=this.changes.adds,a=Math.min(e.featureLimit,t.length);e.featureLimit=a;for(let n=0;n<a;++n){const u=t[n],d=R(u,this.objectIdField),c=this.displayingFeatureReferences.get(d);if(c){const h=c.ref(u,i);h.oldVersion!==h.newVersion&&(s.removes.push(h.oldVersion),s.adds.push(h.newVersion))}else this.displayingFeatureReferences.set(d,new this.FeatureReferenceClass(u,i)),r.push(u);this.numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,a),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if(_(e.displayingFeatures))return;const t=this.changes.updates,i=this.changes.removes;for(const s of e.displayingFeatures){const r=R(s,this.objectIdField),a=this.displayingFeatureReferences.get(r);if(!a)continue;const n=a.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,n?n.oldVersion!==n.newVersion&&(n.newVersion==null?(this.displayingFeatureReferences.delete(r),i.push(n.oldVersion)):(t.adds.push(n.newVersion),t.removes.push(n.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),e.displayingFeatures=null}_applyChanges(){const e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this.changes.adds,i=this.changes.removes,s=Math.min(t.length,i.length);let r=0;for(;r<s;){const a=Math.min(r+Gi,s);this.features.addMany(t.slice(r,a)),this.features.removeMany(i.slice(r,a)),r=a}t.length>s&&this.features.addMany(r===0?t:t.slice(r)),i.length>s&&this.features.removeMany(r===0?i:i.slice(r)),t.length=0,i.length=0}_clearTile(e){if(this._hideTile(e),e.features&&m(this.context.memoryCache)){const t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this.featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce((e,t)=>e+(t.features?t.features.length:0),0)}_maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0,i=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,s=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(i*s/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this.featureTiles.get(e),forEachFeatureTile:e=>this.featureTiles.forEach(e)}}};function Y(e){return e.id==="dummy-tile-full-extent"}function Vi(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}function ds(e){const t=e.capabilities.query;return{supportsMultipleResolutions:Ai(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function Ai(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function Li(e){return e.setFeatures([],0,null),e.featuresMissing=!1,f.DONE}function Ye(e){return _(e)?new Set:new Set(e.map(t=>t.name))}function we(e,t){if(_(e)||_(t))return Ye(t);const i=new Set;for(const{name:s}of t)e.has(s)&&i.add(s);return i}o([l({constructOnly:!0})],F.prototype,"features",void 0),o([l()],F.prototype,"tileDescriptors",void 0),o([l({value:1/0})],F.prototype,"maximumNumberOfFeatures",null),o([l({value:1})],F.prototype,"memoryFactor",null),o([l({value:1})],F.prototype,"lodFactor",null),o([l()],F.prototype,"useTileCount",null),o([l({readOnly:!0})],F.prototype,"updating",void 0),o([l({readOnly:!0})],F.prototype,"updatingTotal",void 0),o([l({readOnly:!0})],F.prototype,"updatingRemaining",void 0),o([l({readOnly:!0})],F.prototype,"expectedFeatureDiff",void 0),o([l({readOnly:!0})],F.prototype,"memoryForUnusedFeatures",null),o([l({readOnly:!0})],F.prototype,"maximumNumberOfFeaturesExceeded",void 0),o([l({constructOnly:!0})],F.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),o([l({readOnly:!0})],F.prototype,"totalVertices",null),o([l({readOnly:!0})],F.prototype,"totalFeatures",null),o([l()],F.prototype,"filterExtent",null),o([l({constructOnly:!0})],F.prototype,"context",void 0),F=o([M("esri.views.3d.layers.support.FeatureTileFetcher3D")],F);const Ui=2e3,Ce=se(),De=se(),qi=6e5,Gi=200,Hi=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class zi{constructor(t,i,s){this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=t,this.view=s,this.tilingScheme=new Ft(i),this.loadedSymbols=Hi.map(r=>new V(new A({material:{color:[r[0],r[1],r[2],.6]},outline:{color:"black",size:1}}))),this.loadingSymbols=[new V(new A({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new V(new A({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new V(new A({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.update()}update(){this._enabled?(this._synchronizeMaps(this.loadingGraphics,{filter:t=>t.isFetching,symbols:this.loadingSymbols}),this._synchronizeMaps(this.loadedGraphics,{filter:t=>!t.isFetching,symbols:this.loadedSymbols}),this._synchronizeMaps(this.pendingGraphics,{filter:t=>!t.isFetching,symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.loadingGraphics.clear(),this.loadedGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.loadedGraphics.clear(),this.pendingGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}showDataExtent(t){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),!t)return;const i=Et.fromExtent(t);this.dataExtentGraphic=new B({geometry:i,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}_synchronizeMaps(t,i){const s=[];t.forEach((r,a)=>{const n=this.tileFetcher.test.getFeatureTileById(a);n&&i.filter(n)||(this.view.graphics.removeMany(r),s.push(a))}),s.forEach(r=>t.delete(r)),this.tileFetcher.test.forEachFeatureTile(r=>{if(i.filter(r)&&!t.has(r.id)){const[a,n,u]=r.descriptor.lij;this.tilingScheme.ensureMaxLod(a);const d=this.tilingScheme.getExtentGeometry(a,n,u),c=[new B({geometry:d,symbol:i.symbols[a%i.symbols.length]}),new B({geometry:d.center,symbol:new xt({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new Tt({text:`${a}/${n}/${u}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];t.set(r.id,c),this.view.graphics.addMany(c)}})}}const Z=re.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");let g=class extends vt(Ie){constructor(e){super(e),this.type="feature-tile-3d",this.watchUpdatingTracking=new Rt,this.serviceDataExtent=null,this.serviceDataCount=v.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this.suspended=!1,this.tileFetcher=null,this.handles=new Me,this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null,this.lifeCycleAbortController=new AbortController}set extent(e){if(e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void Z.error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("extent",i)}get updating(){return!!(m(this.tileFetcher)&&this.tileFetcher.updating||this.fetchDataInfoPromise!=null||this.mode==="tiles"&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&m(this.tileFetcher)?this.tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&m(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&m(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return m(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!m(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return m(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&(e==null?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){var r,a;const e=this.layerView.layer;if(e.type==="feature"&&m(e.infoFor3D))return"snapshot";if(((a=(r=this.layerView.view.qualitySettings)==null?void 0:r.graphics3D)==null?void 0:a.snapshotAvailable)===!1||this.serviceDataCount===v.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const t=this.layerView.view,i=t&&t.featureTiles,s=i&&i.tilingScheme;if(e&&e.minScale&&this.serviceDataExtent&&s){const n=this._approximateExtentSizeAtScale(e.minScale,s);if((this.serviceDataExtent.width/n+this.serviceDataExtent.height/n)/2>v.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const e=this._get("maxTotalSnapshotVertices")||0,t=this.mode==="snapshot"&&m(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(e,t)}_approximateExtentSizeAtScale(e,t){const i=this.layerView.view,s=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),r=t.levels[0];return s*((r.tileSize[0]/(r.scale/e)+r.tileSize[1]/(r.scale/e))/2)}get tileDescriptors(){return this.mode==="snapshot"?new de([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new de}get test(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}initialize(){this.watchUpdatingTracking.add(()=>this.vertexLimitInfo,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal))),this.watchUpdatingTracking.add(()=>this.mode,()=>this._modeChanged(),O),this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))}_verifyCapabilities(){const e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery")&&e.type!=="ogc-feature")throw new S("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}destroy(){this._cancelFetchServiceDataInfo(),this.tileFetcher=D(this.tileFetcher),this.handles=D(this.handles),this.tilesHandle=bt(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this.suspended||(this.suspended=!0,m(this.tileFetcher)&&this.tileFetcher.suspend())}resume(){this.suspended&&(this.suspended=!1,m(this.tileFetcher)&&this.tileFetcher.resume())}restart(){const e=()=>{m(this.tileFetcher)&&this.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(e,e))}refetch(){const e=()=>{m(this.tileFetcher)&&this.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(e,e))}_initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const t=Le(()=>{var i;return(i=e.featureTiles)==null?void 0:i.tilingScheme},this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(t),t.then(()=>{const{layerView:i,tileDescriptors:s}=this,r=i.layer,a=new F({context:this.context,filterExtent:this.extent,tileDescriptors:s,features:this.graphics});this.tileFetcher=a,this.suspended?this.tileFetcher.suspend():this.tileFetcher.resume();const n=this.layerView.view.resourceController;n&&this.handles.add(w(()=>n.memoryController.memoryFactor,h=>a.memoryFactor=h,L));const u=this.context.geometryType==="polygon"?"polygonLodFactor":this.context.geometryType==="polyline"?"polylineLodFactor":null;u&&this.handles.add(w(()=>{var h,y,T;return(T=(y=(h=this.layerView.view)==null?void 0:h.qualitySettings)==null?void 0:y.graphics3D)==null?void 0:T[u]},h=>a.lodFactor=h||1,O));const d=h=>{a.maximumNumberOfFeatures=h,a.useTileCount=this.serviceDataCount>h},c=h=>a.useTileCount=h>this.maximumNumberOfFeatures;r.type!=="ogc-feature"&&this.watchUpdatingTracking.add(()=>r.createQueryVersion,()=>this._dataFilterChanged()),this.watchUpdatingTracking.add(()=>i.availableFields,(h,y)=>this._availableFieldsChanged(y,h)),this.watchUpdatingTracking.add(()=>i.requiredFields,(h,y)=>this._requiredFieldsChanged(y,h)),this.handles.add([r.on("apply-edits",h=>this._applyEdits(h)),w(()=>this.extent,h=>a.filterExtent=h,ie),w(()=>this.tileDescriptors,h=>a.tileDescriptors=h,ie),w(()=>this.maximumNumberOfFeatures,d,L),w(()=>this.serviceDataCount,c,L),w(()=>wt.FEATURE_TILE_FETCH_SHOW_TILES,h=>{h&&a&&!a.debugger?(a.debugger=new zi(a,e.featureTiles.tilingScheme.toTileInfo(),e),a.debugger.update()):!h&&this.tileFetcher&&a.debugger&&(a.debugger.destroy(),a.debugger=null)},L)]),this.supportsExceedsLimitQuery||this.watchUpdatingTracking.add(()=>this.maxTotalSnapshotVertices,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal)))}).catch(()=>{})}_modeChanged(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:Z.warn("Unhandled feature layer mode "+this.mode);case"snapshot":m(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}_applyEdits(e){_(this.tileFetcher)||this.tileFetcher.applyEdits(e).then(t=>{t&&(t.deletedFeatures.length||t.updatedFeatures.length||t.addedFeatures.length)&&this.watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this.lifeCycleAbortController.signal))}).catch(t=>{if(!C(t))throw t})}_availableFieldsChanged(e,t){m(this.tileFetcher)&&Se(this.tileFetcher.availableFields,t)&&this.refetch()}_requiredFieldsChanged(e,t){m(this.tileFetcher)&&Se(this.tileFetcher.availableFields,t)&&this.restart()}_createVertexLimitExceededQuery(e){const t=this.layerView.layer,i=t.createQuery();return i.outStatistics=[new Ct({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(i.cacheHint=!0),i}_createDataInfoQuery(){const e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}_fullExtentIsAccurate(){const e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return Dt(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async _updateServiceDataExtent(e){try{await this._tryUpdateServiceDataExtent(e)}catch(t){C(t)||this._set("serviceDataExtent",ce(this.layerView.fullExtentInLocalViewSpatialReference))}}async _tryUpdateServiceDataExtent(e){const t=this.layerView,i=t.layer,s=i.capabilities.query.supportsExtent,r=ce(t.fullExtentInLocalViewSpatialReference),a=i.fullExtent,n=this._fullExtentIsAccurate(),u=this.serviceDataCount;if(s&&u<=v.MAX_FEATURE_COUNT_FOR_EXTENT&&(!r||!n)&&"queryExtent"in i){const d=this._createDataInfoQuery(),c=await i.queryExtent(d,{timeout:v.QUERY_EXTENT_TIMEOUT,signal:e});this._set("serviceDataExtent",c.extent)}else if(r)this._set("serviceDataExtent",r);else if(m(a)){const d="portalItem"in i?i.portalItem:null,c=await St(a,t.view.spatialReference,d,e);this._set("serviceDataExtent",c)}else this._set("serviceDataExtent",null)}async _updateServiceDataCount(e){const t=this.layerView.layer;if(!("queryFeatureCount"in t))return void this._set("serviceDataCount",v.NO_SERVICE_DATA_COUNT);const i=await pe(t.queryFeatureCount(this._createDataInfoQuery(),{timeout:v.QUERY_STATISTICS_TIMEOUT,signal:e}));if(i.ok===!0)this._set("serviceDataCount",i.value);else{if(C(i.error))throw i.error;this._set("serviceDataCount",v.NO_SERVICE_DATA_COUNT)}}get vertexLimitInfo(){if(_(this.displayFeatureLimit)||_(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:e,maximumTotalNumberOfPrimitives:t}=this.displayFeatureLimit,{primitivesPerCoordinate:i,primitivesPerFeature:s}=e,r=this._get("vertexLimitInfo");return _(r)||r.maximumTotalNumberOfPrimitives!==t||r.primitivesPerCoordinate!==i||r.primitivesPerFeature!==s?{primitivesPerCoordinate:i,primitivesPerFeature:s,maximumTotalNumberOfPrimitives:t}:r}get supportsExceedsLimitQuery(){const e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async _updateVertexLimitExceeded(e,t){const i=this.vertexLimitInfo;if(_(i))return void this._set("vertexLimitExceeded",!1);const s=i.primitivesPerFeature<=0,r=this.minimumNumberOfVerticesForGeometry>1;if(!s&&!r)return void this._set("vertexLimitExceeded",!1);const{primitivesPerFeature:a,primitivesPerCoordinate:n,maximumTotalNumberOfPrimitives:u}=i;let d;a!==0&&m(e)&&await e;const c=this.serviceDataCount,h=c!==v.NO_SERVICE_DATA_COUNT;if(d=Math.ceil(h?(u-c*a)/(n||1):u/(n||1)),r&&(d=Math.min(d,ki)),h&&this.minimumNumberOfVerticesForGeometry*c>d)return void this._set("vertexLimitExceeded",!0);if(!this.supportsExceedsLimitQuery)return void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>d);const y=await pe(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(d),{timeout:v.QUERY_STATISTICS_TIMEOUT,signal:t}));if(y.ok===!1){if(C(y.error))throw y.error;return void this._set("vertexLimitExceeded",!1)}const T=y.value.features[0];T&&T.attributes?this._set("vertexLimitExceeded",!!T.attributes.exceedslimit):this._set("vertexLimitExceeded",!1)}async _fetchServiceDataInfo(){this._cancelFetchServiceDataInfo();let e=new AbortController;const t=e.signal,i=this._updateServiceDataCount(t),s=Ve([i,this._updateVertexLimitExceeded(i,t)]),r=s.then(()=>this._updateServiceDataExtent(t)).catch(a=>{C(a)||Z.error("#fetchServiceDataInfo()",a)}).then(()=>{r===this.fetchDataInfoPromise&&(this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null),e=null});return e&&(this.fetchDataInfoPromise=r),this.fetchDataInfoAbortController=e,s.then(()=>{},()=>{})}_cancelFetchServiceDataInfo(){const e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())}get debug(){return{storedFeatures:m(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:m(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:m(this.tileFetcher)?this.tileFetcher.totalVertices:0}}};o([l({readOnly:!0})],g.prototype,"type",void 0),o([l({constructOnly:!0})],g.prototype,"graphics",void 0),o([l({constructOnly:!0})],g.prototype,"layerView",void 0),o([l({constructOnly:!0})],g.prototype,"context",void 0),o([l()],g.prototype,"extent",null),o([l()],g.prototype,"updating",null),o([l({readOnly:!0})],g.prototype,"watchUpdatingTracking",void 0),o([l()],g.prototype,"updatingTotal",null),o([l()],g.prototype,"updatingRemaining",null),o([l()],g.prototype,"expectedFeatureDiff",null),o([l()],g.prototype,"memoryForUnusedFeatures",null),o([l()],g.prototype,"maximumNumberOfFeaturesExceeded",null),o([l({readOnly:!0})],g.prototype,"serviceDataExtent",void 0),o([l({readOnly:!0})],g.prototype,"serviceDataCount",void 0),o([l({readOnly:!0})],g.prototype,"vertexLimitExceeded",void 0),o([l()],g.prototype,"displayFeatureLimit",void 0),o([l({type:Number})],g.prototype,"maximumNumberOfFeatures",null),o([l({readOnly:!0})],g.prototype,"mode",null),o([l({readOnly:!0})],g.prototype,"maxTotalSnapshotVertices",null),o([l({readOnly:!0,dependsOn:["mode"]})],g.prototype,"tileDescriptors",null),o([l()],g.prototype,"tileFetcher",void 0),o([l()],g.prototype,"fetchDataInfoPromise",void 0),o([l({readOnly:!0})],g.prototype,"vertexLimitInfo",null),g=o([M("esri.layers.graphics.controllers.FeatureTileController3D")],g);const ji=1e4,Qi=12e3,Bi=1e4,ki=5e6;function Se(e,t){if(!t)return!1;for(const i of t)if(!e.has(i))return!0;return!1}var v;(function(e){function t(){e.MAX_FEATURE_COUNT_FOR_EXTENT=ji,e.QUERY_STATISTICS_TIMEOUT=Qi,e.QUERY_EXTENT_TIMEOUT=Bi}e.NO_SERVICE_DATA_COUNT=1/0,e.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,e.reset=t})(v||(v={})),v.reset();function Wi(){const e=new Ue;return e.include(Pt),e.include(Ot),e.fragment.uniforms.add([new me("densityMap",t=>t.densityMap),new me("tex",t=>t.colorRamp),new H("densityNormalizer",t=>1/(t.maxDensity-t.minDensity)),new H("minDensity",t=>t.minDensity)]),e.fragment.uniforms.add(new H("densityMultiplier",t=>3/(t.searchRadius*t.searchRadius*Math.PI))),e.fragment.code.add($`void main() {
float density = texture2D(densityMap, uv).r * densityMultiplier;
float densityRatio = (density - minDensity) * densityNormalizer;
vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));
discardOrAdjustAlpha(color);
gl_FragColor = color;
}`),e}const Xi=Object.freeze(Object.defineProperty({__proto__:null,build:Wi},Symbol.toStringTag,{value:"Module"}));class Yi extends Mt{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class z extends He{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=z.shader.get().build();return new ze(t.rctx,i,je)}initializePipeline(){return Qe({blending:$t,colorWrite:Be,depthTest:null,depthWrite:null})}get primitiveType(){return It.TRIANGLE_STRIP}}z.shader=new qe(Xi,()=>Ge(()=>import("./Heatmap.glsl.1cef37d9.js"),["Heatmap.glsl.1cef37d9.js","index.a8738f47.js","index.7b18f6ca.css","dehydratedFeatureComparison.47577290.js","Graphics3DFeatureProcessor.cae1d677.js","Graphics3DScaleVisibility.8fa6127f.js","optimizedFeatureQueryEngineAdapter.c129ff5f.js","centroid.88cb65db.js","PooledRBush.dcfb0021.js","quickselect.03306040.js","Graphics3DObjectStates.2d298d9b.js","floorFilterUtils.69500d62.js","QueryEngine.dd064fa9.js","QueryEngineResult.3d7a8c8d.js","WhereClause.d715e7d1.js","utils.bf6b5607.js","ClassBreaksDefinition.d9c6c51f.js","json.d1a0fa35.js","QueryEngineCapabilities.c2e9875c.js","attributeUtils.99d8ee08.js","FeatureStore.b55521bf.js","projectExtentUtils.4c0871bc.js"],import.meta.url));let b=class extends Nt{constructor(e){super(e),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new Yi}initialize(){const e={colorTarget:Vt.TEXTURE,depthStencilTarget:At.NONE,width:0,height:0},{capabilities:t}=this.rctx,{R32F:i}=t.colorBufferFloat,{textureFloatLinear:s}=t.textureFloat,r=i!=null,a={target:fe.TEXTURE_2D,pixelFormat:r?U.RED:U.RGBA,internalFormat:r?Lt.R32F:U.RGBA,dataType:ge.FLOAT,samplingMode:s?k.LINEAR:k.NEAREST,wrapMode:ye.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new Ut(this.rctx,e,a),this._quad=qt(this.rctx);const n=this._colorRampData,u={target:fe.TEXTURE_2D,pixelFormat:U.RGBA,dataType:ge.UNSIGNED_BYTE,samplingMode:k.LINEAR,wrapMode:ye.CLAMP_TO_EDGE,width:n.length/4,height:1};this._colorRamp=new Gt(this.rctx,u,n),this._technique=new z({rctx:this.rctx,viewingMode:Ae.Local},new Ht),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.own(w(()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius],()=>this.rendererContext.notifyContentChanged()))}destroy(){this._technique=zt(this._technique),this._densityMap=I(this._densityMap),this._quad=I(this._quad),this._colorRamp=I(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(e){const{colorRamp:t}=this._heatmapParameters;if(m(t)&&e!==this._colorRampData){const i=t.descriptor.width,s=e.length/4;s!==i&&t.resize(s,1),t.setData(e)}this._colorRampData=e}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(e){this._heatmapParameters.colorRamp=e}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}render(e,t){const i=this._sortedMaterialRenderers,s=i.length;if(s<1)return;const r=this.rctx.getBoundFramebufferObject(),a=this.rctx.getViewport(),{pixelRatio:n}=this,u=Math.ceil(a.width*n),d=Math.ceil(a.height*n);this._densityMap.resize(u,d),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,u,d),this.rctx.clear(jt.COLOR_BUFFER_BIT);let c=!1;for(let h=0;h<s;h++){const y=i.getItemAt(h);y.material.shouldRender(e)&&(c=c||y.materialRenderer.render(e.pass,t))}this.rctx.bindFramebuffer(r),this.rctx.setViewport(a.x,a.y,a.width,a.height),c&&(this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(this._heatmapParameters,e.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,Qt(this._quad,"geometry")))}};o([l()],b.prototype,"searchRadius",null),o([l()],b.prototype,"minDensity",null),o([l()],b.prototype,"maxDensity",null),o([l()],b.prototype,"fieldTotal",null),o([l()],b.prototype,"pixelRatio",void 0),o([l()],b.prototype,"colorRampData",null),o([l()],b.prototype,"_colorRampData",void 0),b=o([M("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],b);function Zi(e){const t=new Ue;Bt(t,e);const{isAttributeDriven:i}=e;return t.attributes.add(x.POSITION,"vec3"),t.attributes.add(x.UV0,"vec2"),i&&(t.attributes.add(x.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),t.varyings.add("unitCirclePos","vec2"),t.vertex.uniforms.add(new H("radius",({resolutionForScale:s,searchRadius:r},{camera:a,screenToWorldRatio:n})=>2*r*(s===0?1:s/n)*a.pixelRatio/a.fullViewport[2])),t.vertex.code.add($`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${x.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${i?$`attributeValue = ${x.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),t.fragment.code.add($`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${i?$` * attributeValue`:""};
      gl_FragColor = vec4(density);
    }
  `),t}const Ji=Object.freeze(Object.defineProperty({__proto__:null,build:Zi},Symbol.toStringTag,{value:"Module"}));var Pe;(function(e){e[e.Screen=0]="Screen",e[e.World=1]="World"})(Pe||(Pe={}));class Ki extends Zt{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class j extends He{initializeProgram(t){const i=j.shader.get().build(this.configuration);return new ze(t.rctx,i,je)}initializePipeline(){return Qe({blending:Wt(_e.ONE,_e.ONE,Xt.ADD),colorWrite:Be,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}j.shader=new qe(Ji,()=>Ge(()=>import("./HeatmapDensity.glsl.86c3b686.js"),["HeatmapDensity.glsl.86c3b686.js","index.a8738f47.js","index.7b18f6ca.css","dehydratedFeatureComparison.47577290.js","Graphics3DFeatureProcessor.cae1d677.js","Graphics3DScaleVisibility.8fa6127f.js","optimizedFeatureQueryEngineAdapter.c129ff5f.js","centroid.88cb65db.js","PooledRBush.dcfb0021.js","quickselect.03306040.js","Graphics3DObjectStates.2d298d9b.js","floorFilterUtils.69500d62.js","QueryEngine.dd064fa9.js","QueryEngineResult.3d7a8c8d.js","WhereClause.d715e7d1.js","utils.bf6b5607.js","ClassBreaksDefinition.d9c6c51f.js","json.d1a0fa35.js","QueryEngineCapabilities.c2e9875c.js","attributeUtils.99d8ee08.js","FeatureStore.b55521bf.js","projectExtentUtils.4c0871bc.js"],import.meta.url));class Ze extends Yt{constructor(){super(...arguments),this.isAttributeDriven=!1}}o([kt()],Ze.prototype,"isAttributeDriven",void 0);const es=2;class ts extends Ki{constructor(){super(...arguments),this.isAttributeDriven=!1}}class Oe extends Kt{constructor(t){super(t,new ts),this._techniqueConfig=new Ze}requiresSlot(t,i){return t===ei.DRAPED_MATERIAL&&i===ti.MATERIAL}getConfiguration(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(t){return new is(t)}intersect(t,i,s,r,a,n,u,d,c){if(_(c)||!ii(n))return;const h=t.vertexAttributes.get(x.POSITION),{parameters:y}=this,{searchRadius:T}=y,{screenToWorldRatio:N}=t,ae=T*N+es*N,Ke=ae*ae,et=h.data.length/h.size;for(let Q=0;Q<et;Q++){const ne=Q*h.size,tt=si(as,h.data[ne],h.data[ne+1]);ri(tt,n)<Ke&&u(c.dist,c.normal,-1,!1)}}createBufferWriter(){return new ss(this.parameters.isAttributeDriven?rs:Je)}}class is extends ai{beginSlot(t){return this.ensureTechnique(j,t)}}class ss{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(x.POSITION).length*J}write(t,i,s,r){ni(i.indices.get(x.POSITION),i.vertexAttributes.get(x.POSITION).data,t.transformation,s.position,r,J);const a=i.indices.get(x.POSITION).length,n=s.uv0;let u=r;for(let c=0;c<a;++c)n.setValues(u++,-1,-1),n.setValues(u++,1,-1),n.setValues(u++,1,1),n.setValues(u++,1,1),n.setValues(u++,-1,1),n.setValues(u++,-1,-1);const d="featureAttribute"in s?s.featureAttribute:null;d&&oi(i.indices.get(x.FEATUREATTRIBUTE),i.vertexAttributes.get(x.FEATUREATTRIBUTE).data,d,r,J)}}const Je=Jt().vec3f(x.POSITION).vec2f(x.UV0),rs=Je.clone().f32(x.FEATUREATTRIBUTE),J=6,as=li(),K=re.getLogger("esri.views.3d.layers.support.HeatmapFeatureProcessor"),G=112;let p=class extends ui{constructor(e){super(e),this.type="heatmap",this.filterVisibility={filterChanged(){},dirty:!1},this.preferredUpdatePolicy=ke.ASYNC,this.dataExtent=null,this.drapeSourceType=hi.Features,this._renderGeometries=new Map,this._material=new Oe({}),this._materialWithField=new Oe({isAttributeDriven:!0}),this._fieldTotal=0,this._drapeSourceRenderer=null}initialize(){this._featureStore=new Di({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{colorBufferFloat:e,textureFloat:t}=this._renderView.capabilities,{floatBufferBlendWorking:i}=this._renderView.renderingContext.driverTest;if(!(t!=null&&t.textureFloat))throw new S("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float.");if(!(e!=null&&e.textureFloat))throw new S("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL2 extension EXT_color_buffer_float or the WebGL1 extension WEBGL_color_buffer_float.");if(!(e!=null&&e.floatBlend))throw new S("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend.");if(!i)throw new S("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend. This device claims support for it, but does not actually support it.");this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,b,this._rendererParameters),this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,s=>this._onLoadedFeaturesChange(s),O),this.updatingHandles.addWhen(()=>this._materialParameters,s=>this._forEachMaterial(r=>r.setParameters(s)),O),this.updatingHandles.add(()=>this._rendererParameters,s=>this._drapeSourceRenderer.set(s)),this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},ie),this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:s,numeric:r})=>{if(m(s)&&r){let a=0;this._featureStore.forEach(n=>{var u;return a+=(u=n.attributes[s])!=null?u:0}),this._fieldTotal=a}else this._fieldTotal=this._featureStore.numFeatures},O),this.handles.add([w(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:s,field:r})=>{var a;s&&!r&&K.warn(`Heatmap renderer field '${s}' for layer '${(a=this.layer.title)!=null?a:this.layer.id}' not found`)}),w(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:s,numeric:r})=>{var a;m(s)&&!r&&K.warn(`Heatmap renderer field '${s.name}' for layer '${(a=this.layer.title)!=null?a:this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),We(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])}destroy(){this._renderGeometries.clear(),this._material=I(this._material),this._materialWithField=I(this._materialWithField),this._featureStore.clear(),this._featureStore=null}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this.updatingHandles.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get displayFeatureLimit(){var s,r,a,n,u,d,c;const e=(u=(n=(a=(r=(s=this.owner)==null?void 0:s.view)==null?void 0:r.resourceController)==null?void 0:a.memoryController)==null?void 0:n.memoryFactor)!=null?u:1,t=(c=(d=this.owner)==null?void 0:d.view)==null?void 0:c.qualitySettings,i=t?Math.ceil(t.heatmap.maxTotalNumberOfFeatures*e):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:i*2,maximumNumberOfFeatures:i}}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){return!1}get usedMemory(){var a,n,u,d,c;const e=this.usedMemoryPerFeature*this._featureStore.numFeatures,{R32F:t}=(n=(a=this._renderView)==null?void 0:a.capabilities)==null?void 0:n.colorBufferFloat,i=t!=null?1:4,s=4,r=(c=Math.ceil(((d=(u=this._overlayRenderer)==null?void 0:u.overlays[0])==null?void 0:d.resolution)*this._densityMapPixelRatio))!=null?c:0;return r*r*i*s+e+(m(this._heatmapRenderer)?Fe(Math.min(this._heatmapRenderer.radius,G)):0)*i*s}get usedMemoryPerFeature(){if(this._featureStore.numFeatures===0)return 0;let e=0;this._featureStore.forEach(s=>e+=di(s.attributes)),e/=this._featureStore.numFeatures;const t=vi(),i=6;return i*Ee([0,0,0],t)+i*Ee([0,0],t)+(this._heatmapRendererFieldIsNumeric?i*t:0)+e}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return{core:{visible:this._featureStore.numFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return ee(this._overlayRenderer.spatialReference)}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const e=this._heatmapRenderer;if(_(e))return null;const{minDensity:t,maxDensity:i}=e;return{minDensity:t,maxDensity:i,fieldTotal:this._fieldTotal}}get _radiusParameter(){return P(this._heatmapRenderer,({radius:e})=>({searchRadius:Fe(this._clampSearchRadius(e))}))}get _resolutionForScaleParameter(){return P(this._heatmapRenderer,({referenceScale:e})=>({resolutionForScale:e===0?0:ci(e,this.view.spatialReference)}))}get _colorRampParameter(){return P(this._heatmapRenderer,e=>({colorRampData:pi(e.colorStops)}))}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){var t,i,s,r,a,n,u,d;const e=(a=(r=(s=(i=(t=this.owner)==null?void 0:t.view)==null?void 0:i.resourceController)==null?void 0:s.memoryController)==null?void 0:r.memoryFactor)!=null?a:1;return((d=(u=(n=this.owner)==null?void 0:n.view)==null?void 0:u.qualitySettings.heatmap.pixelRatio)!=null?d:1)*Math.sqrt(e)}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return this.layer.geometryType==="point"}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const e=this.layer.renderer;return(e==null?void 0:e.type)==="heatmap"?e:null}get _heatmapRendererFieldName(){return P(this._heatmapRenderer,e=>e.field)}get _heatmapRendererField(){return P(this._heatmapRendererFieldName,e=>this.layer.fieldsIndex.get(e))}get _heatmapRendererFieldIsNumeric(){const e=this._heatmapRendererField;return!_(e)&&mi(e)}async whenGraphicBounds(){return null}computeAttachmentOrigin(){return null}highlight(){return $e}maskOccludee(){return $e}setObjectIdVisibility(){}async setup(){}_onLoadedFeaturesChange(e){if(!this._featuresArePoints)return;const{objectIdField:t}=this.layer;this._featureStore.removeManyById(e.removed.map(n=>R(n,t))),this._featureStore.addMany(e.added.map(n=>new fi(xe(new Te,n.geometry),n.attributes,P(n.centroid,u=>xe(new Te,u)),R(n,t))));const i=e.added,s=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,s);const r=gi(s,({uid:n})=>{const u=this._renderGeometries.get(n);return this._renderGeometries.delete(n),u}),a=i.map(n=>{const u=this._pointGraphicToRenderGeometry(n);return this._renderGeometries.set(n.uid,u),u});r.length>0&&this._drapeSourceRenderer.removeGeometries(r,ve.Geometry.REMOVE),a.length>0&&this._drapeSourceRenderer.addGeometries(a,ve.Geometry.ADD),(a.length>0||r.length>0)&&this._renderView.requestRender()}_recreate(){if(!this._loadedPointGraphics)return;const e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}_pointGraphicToRenderGeometry(e){var u;const t=this._heatmapRendererFieldName,i=m(t)?this._materialWithField:this._material,s=Ri();yi(e.geometry,s,this._overlaySpatialReference),s[2]=_i;const r=[[x.POSITION,{data:s,size:s.length}]],a=this._heatmapRendererFieldIsNumeric;m(t)&&r.push([x.FEATUREATTRIBUTE,{data:[a&&(u=e.attributes[t])!=null?u:0],size:1}]);const n=new Fi(new Ei(r,null,xi.Point),i,{layerUid:this.layer.uid,graphicUid:e.uid});return Ti(n.boundingSphere,s),n}_forEachMaterial(e){e(this._material),e(this._materialWithField)}_computeFieldTotalChange(e,t){if(_(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;const i=this._heatmapRendererFieldName,s=(r,a)=>{var n;return r+((n=a.attributes[i])!=null?n:0)};return e.reduce(s,0)-t.reduce(s,0)}_clampSearchRadius(e){return e>G&&K.warnOnce(`SceneView supports a maximum radius of ${G} pt for HeatmapRenderer.`),Math.min(e,G)}};o([l()],p.prototype,"type",void 0),o([l({constructOnly:!0})],p.prototype,"owner",void 0),o([l()],p.prototype,"layer",null),o([l()],p.prototype,"featureStore",null),o([l()],p.prototype,"updating",null),o([l()],p.prototype,"updatingRemaining",null),o([l()],p.prototype,"suspendInfo",null),o([l()],p.prototype,"legendEnabled",null),o([l()],p.prototype,"filterVisibility",void 0),o([l()],p.prototype,"displayFeatureLimit",null),o([l()],p.prototype,"preferredUpdatePolicy",void 0),o([l()],p.prototype,"hasZ",null),o([l()],p.prototype,"hasM",null),o([l()],p.prototype,"dataExtent",void 0),o([l()],p.prototype,"view",null),o([l()],p.prototype,"fullOpacity",null),o([l()],p.prototype,"updatePolicy",null),o([l()],p.prototype,"drapeSourceType",void 0),o([l()],p.prototype,"_featureStore",void 0),o([l()],p.prototype,"_overlayRenderer",null),o([l()],p.prototype,"_overlaySpatialReference",null),o([l()],p.prototype,"_rendererParameters",null),o([l()],p.prototype,"_materialParameters",null),o([l()],p.prototype,"_densityParameters",null),o([l()],p.prototype,"_radiusParameter",null),o([l()],p.prototype,"_resolutionForScaleParameter",null),o([l()],p.prototype,"_colorRampParameter",null),o([l()],p.prototype,"_pixelRatioParameter",null),o([l()],p.prototype,"_densityMapPixelRatio",null),o([l()],p.prototype,"_renderGeometries",void 0),o([l()],p.prototype,"_material",void 0),o([l()],p.prototype,"_materialWithField",void 0),o([l()],p.prototype,"_renderView",null),o([l()],p.prototype,"_featuresArePoints",null),o([l()],p.prototype,"_loadedPointGraphics",null),o([l()],p.prototype,"_heatmapRenderer",null),o([l()],p.prototype,"_heatmapRendererFieldName",null),o([l()],p.prototype,"_heatmapRendererField",null),o([l()],p.prototype,"_heatmapRendererFieldIsNumeric",null),o([l()],p.prototype,"_fieldTotal",void 0),o([l()],p.prototype,"_drapeSourceRenderer",void 0),p=o([M("esri.views.3d.layers.support.HeatmapFeatureProcessor")],p);const $e=We(),cs=e=>{let t=class extends e{constructor(){super(...arguments),this.controller=null,this.updatePolicy=ke.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.clippingExtent=null,this.supportsHeightUnitConversion=!0,this.pendingController=null,this.queryEngine=null}initialize(){const i=this.layer;"isTable"in i&&i.isTable?this.addResolvingPromise(Promise.reject(new S("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:i}))):(this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add(()=>this.layer.renderer,s=>this._recreateProcessor(s),O),this.addResolvingPromise((async()=>{const s=await Si(this);this.fullExtentInLocalViewSpatialReference=s,await this._initializeController()})()),this.updatingHandles.add(()=>this.updatePolicy,s=>this.processor.preferredUpdatePolicy=s),this.queryEngine=new wi({layerView:this,priority:Ne.FEATURE_QUERY_ENGINE}),this.notifyChange("updating"))}destroy(){this._destroyPendingController(),this.controller=D(this.controller),this._set("processor",D(this.processor)),this.queryEngine=D(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this.pendingController=D(this.pendingController)}get legendEnabled(){var i;return this.canResume()&&((i=this.processor)==null?void 0:i.legendEnabled)}get graphics3DProcessor(){var i;return((i=this.processor)==null?void 0:i.type)==="graphics-3d"?this.processor:null}get heatmapProcessor(){var i;return((i=this.processor)==null?void 0:i.type)==="heatmap"?this.processor:null}getHit(i){var r;let s=null;return(r=this.loadedGraphics)==null||r.forEach(a=>{a.uid===i&&(s=bi(a,this.layer))}),s?{type:"graphic",graphic:s,layer:s.layer}:null}whenGraphicBounds(i,s){var r;return(r=this.processor)==null?void 0:r.whenGraphicBounds(i,s)}computeAttachmentOrigin(i,s){var r;return(r=this.processor)==null?void 0:r.computeAttachmentOrigin(i,s)}queryFeatures(i,s){return this.queryEngine.executeQuery(this._ensureQuery(i),q(s,"signal"))}queryObjectIds(i,s){return this.queryEngine.executeQueryForIds(this._ensureQuery(i),q(s,"signal"))}queryFeatureCount(i,s){return this.queryEngine.executeQueryForCount(this._ensureQuery(i),q(s,"signal"))}queryExtent(i,s){return this.queryEngine.executeQueryForExtent(this._ensureQuery(i),q(s,"signal"))}_ensureQuery(i){return _(i)?this.createQuery():te.from(i)}highlight(i){return this.processor.highlight(i,this.layer.objectIdField)}maskOccludee(i){return this.processor.maskOccludee(i)}canResume(){var i;return super.canResume()&&!((i=this.processor)!=null&&i.scaleVisibilitySuspended)}getSuspendInfo(){const i=super.getSuspendInfo();return this.processor?{...i,...this.processor.suspendInfo}:i}isUpdating(){var i,s,r;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&!((i=this.controller)!=null&&i.updating)&&((r=(s=this.view)==null?void 0:s.basemapTerrain)==null?void 0:r.ready)&&!this.processor.updating)}async _initializeController(){const i=this.createController();this.pendingController=i,await i.when(),this._setControllerWhenInitialized(i)}async _setControllerWhenInitialized(i){try{await this.when()}catch{}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await Le(()=>{var s,r;return(r=(s=this.view)==null?void 0:s.basemapTerrain)==null?void 0:r.ready}),this.beforeSetController(i),this.pendingController=null,this.controller=i,this.loadedGraphics=i.graphics,this.notifyChange("updating")):this._destroyPendingController()}_updateClippingExtent(i){if(this.clippingExtent=i,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=i,!0}}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new S("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}_recreateProcessor(i){var u,d;const s=(i==null?void 0:i.type)==="heatmap",r=((u=this.processor)==null?void 0:u.type)==="heatmap",a=this.processor;if(a&&s===r)return;const n=s?new p({owner:this}):new Ci({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:c=>this._updateClippingExtent(c)});this._set("processor",n),a==null||a.destroy(),(d=this.queryEngine)==null||d.clear(),this.addResolvingPromise(n.setup())}_getResourceInfo(){var s,r;const i=this.controller instanceof g?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:(s=i==null?void 0:i.maximumNumberOfFeatures)!=null?s:-1,totalNumberOfFeatures:(r=i==null?void 0:i.serviceDataCount)!=null?r:-1,nodes:0,...this.processor.performanceInfo}}get performanceInfo(){return this._getResourceInfo()}};return o([l()],t.prototype,"loadedGraphics",void 0),o([l()],t.prototype,"suspended",void 0),o([l({readOnly:!0})],t.prototype,"legendEnabled",null),o([l()],t.prototype,"updating",void 0),o([l()],t.prototype,"controller",void 0),o([l()],t.prototype,"processor",void 0),o([l({readOnly:!0})],t.prototype,"updatePolicy",void 0),o([l({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),o([l({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),o([l({readOnly:!0})],t.prototype,"suspendInfo",void 0),o([l()],t.prototype,"graphics3DProcessor",null),o([l()],t.prototype,"heatmapProcessor",null),t=o([M("esri.views.3d.layers.FeatureLikeLayerView3D")],t),t};export{cs as E,g as I,ds as S,Zi as a,Wi as t};
