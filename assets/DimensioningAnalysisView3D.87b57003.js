import{eU as ai,aW as li,jo as di,jp as hi,e as a,d,aO as he,j2 as ci,kx as pi,ky as ui,n as S,kz as gi,t as m,am as Ot,r as f,l as j,gY as fi,kA as _i,kB as mi,kC as yi,u as Je,aj as w,iy as zt,iX as wt,ju as ie,jW as jt,x as C,bK as xt,aX as U,ag as W,eT as Ft,i0 as dt,kD as Ze,jv as Ue,eI as St,jV as vi,ad as ee,kE as ht,kF as wi,hX as xi,kG as Si,kH as Ei,kI as bi,bN as Gt,kJ as re,jb as Et,aM as Pi,jK as Ti,jJ as X,ka as ct,gS as Ci,k5 as we,kq as Ce,el as qt,gT as ge,a8 as Pt,cT as Oi,hu as V,k1 as Ri,y as F,gX as k,k6 as Tt,k0 as Vi,i as Oe,fa as $i,dh as Hi,hi as fe,kK as Li,F as Re,kt as ce,aC as Mi,U as Be,ic as Ii,a4 as Di,bj as pt,G as Te,jZ as ki,k7 as Ni,k8 as Rt,j_ as Wt,jj as Ut,Y as Ai,bT as zi,H as ji,kL as Fi,ay as Xt,an as Yt,kM as Zt,bO as Bt,az as Gi,cL as qi,kN as De,f as bt,a9 as Wi,aa as Ui,kO as Xi,dT as Yi,h as ut,jf as Zi,kP as Qe,f4 as Bi,eR as pe,kQ as ke,jc as gt,kj as Vt,jT as $t,jw as Qi,fn as Ki,kR as Ji,aL as ft,eQ as _t,aK as en,aw as tn}from"./index.a8738f47.js";import{n as Qt,C as mt,a as nn}from"./LineVisualElement.c8ac394d.js";import{G as Ht,y as sn,p as rn,z as on,a as an,c as ln,m as dn,s as hn}from"./analysisViewUtils.1368068e.js";import{_ as cn,S as Lt}from"./PointVisualElement.1a1f0dbc.js";import{j as pn}from"./RightAngleQuadVisualElement.93093297.js";import{c as te,j as un,R as x,l as ve,v as gn,b as fn,o as yt}from"./Segment.00e10e0b.js";import{B as _n,z as mn}from"./dragEventPipeline3D.dd7775a3.js";import{E as Kt,N as yn,y as Jt,b as R,d as ei,j as vn,v as ti,L as be,m as ii,S as wn,g as xn,x as Sn}from"./EditGeometryOperations.17db3234.js";import{E as Ke}from"./QueryEngineResult.3d7a8c8d.js";import{m as Mt}from"./elevationInfoUtils.fe889101.js";import{r as En}from"./dehydratedFeatureComparison.47577290.js";function bn(t){const e=ai(t),i=e===di?hi:e;return li(t,i)?i:t}const Pn=["horizontal","vertical","direct"];let A=class extends gi{constructor(t){super(t),this.type="length",this.startPoint=null,this.endPoint=null,this.axis="horizontal",this.offset=0,this.heading=0}get extent(){if(m(this.startPoint))return null;const t=Ot.fromPoint(this.startPoint);return f(this.endPoint)&&t.union(Ot.fromPoint(this.endPoint)),t}};a([d({type:["length"]})],A.prototype,"type",void 0),a([d({type:he})],A.prototype,"startPoint",void 0),a([d({type:he})],A.prototype,"endPoint",void 0),a([d({type:Pn,nonNullable:!0})],A.prototype,"axis",void 0),a([d({type:Number,nonNullable:!0})],A.prototype,"offset",void 0),a([d({type:Number,nonNullable:!0}),ci(t=>pi.normalize(ui(t),0,!0))],A.prototype,"heading",void 0),a([d({readOnly:!0})],A.prototype,"extent",null),A=a([S("esri.analysis.LengthDimension")],A);const Tn=A,Cn={main:new j([255,127,0])};class On{constructor(){this.color=Cn.main,this.opacity=.5,this.radius=5}}class Rn{constructor(){this.fontSize=14}get height(){return 1.5*fi(this.fontSize)}get offset(){return this.height+20}}class Vn{constructor(){this.pointManipulators=new On,this.labels=new Rn}}const Pe=new Vn;class $n extends Qt{constructor(e){super(e),this._ray=yi(),this._externalResources=null,this._handles=new Je,this._isWorldDown=!1,this._start=w(),this._end=zt(1,0,0),this._width=1,this._color=wt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=wt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=M.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=ie.OccludeAndTransparent,this._fadedExtensions=kt,this.applyProps(e)}createExternalResources(){const e=new jt(this.materialParameters);this._handles.add(C(()=>this.view.state.camera,()=>{this._updateGeometry()}));const i=new cn({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:i}}destroyExternalResources(){f(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){f(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const i=[w(),w()],n=this.extensionType===M.FADED;n&&i.push(w(),w());const s=n?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,r=xt.createPolylineGeometry(i,null,s);e.addGeometry(r,U(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),f(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,W(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),Ft(this._end,e,this._end),dt(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,Ze(this._start,e)||(W(this._start,e),dt(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,Ze(this._end,e)||(W(this._end,e),dt(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Ue(e,this._color)||(St(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Ue(e,this._innerColor)||(St(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=f(e)!==f(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(m(e)||m(this._stippleOffColor)||!Ue(e,this._stippleOffColor))&&(this._stippleOffColor=f(e)?vi(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&f(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,f(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,f(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,f(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=ee(e,kt),this.recreateGeometry()}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){f(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const i=this._extensionType===M.FADED?this._updateLineSegmentFinite(It):this._updateLineSegmentInfinite(this._extensionType,It);this._updateVertexAttributes(e,i),f(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}_updateLineSegmentFinite(e){return ht(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){const n=this.view.state.camera;switch(wi(this._ray,G),e){case M.LINE:G.c0=-Number.MAX_VALUE;break;case M.RAY:case M.GROUND_RAY:{const o=this._ray.origin,l=ee(this.view.elevationProvider.getElevation(o[0],o[1],o[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),h=this.view.renderCoordsHelper.getAltitude(o);this._isWorldDown&&h<l&&xi(G.ray.direction,G.ray.direction),this._extensionType===M.GROUND_RAY&&l!=null&&(G.c1=Math.abs(h-l));break}}if(!Si(n.frustum,G))return ht(this._start,this._end,i);const s=Ei(G,Z),r=bi(G,Hn);return ht(s,r,i)}_updateVertexAttributes(e,i){const n=e.geometries[0].getMutableAttribute(Gt.POSITION).data;if(this.extensionType===M.FADED){const s=re(i,-this.fadedExtensions.start,Z);n[0]=s[0],n[1]=s[1],n[2]=s[2];const r=re(i,0,Z);n[3]=r[0],n[4]=r[1],n[5]=r[2];const o=re(i,1,Z);n[6]=o[0],n[7]=o[1],n[8]=o[2];const l=re(i,1+this.fadedExtensions.end,Z);n[9]=l[0],n[10]=l[1],n[11]=l[2]}else{const s=re(i,0,Z);n[0]=s[0],n[1]=s[1],n[2]=s[2];const r=re(i,1,Z);n[3]=r[0],n[4]=r[1],n[5]=r[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const G=_i(),Z=w(),Hn=w(),It=mi();var M;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(M||(M={}));const Dt=1/3,kt={start:Dt,end:Dt};class Ln extends Qt{constructor(e){super(e),this._handles=new Je,this._location=w(),this._direction=zt(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=wt(1,0,1,1),this._renderOccluded=ie.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){Ze(this._location,e)||(W(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){Ze(this._direction,e)||(W(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){Et(this._direction,Ft(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){Ue(e,this._color)||(St(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new jt(this.materialParameters);this._handles.add(C(()=>this.view.state.camera,()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const i=xt.createPolylineGeometry([w(),w()]),n=xt.createPolylineGeometry([w(),w()]),s=U(this._externalResources).material;e.addGeometry(i,s),e.addGeometry(n,s),this._updateVertices(e)}forEachExternalMaterial(e){f(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;m(e)||this._updateVertices(e)}_updateVertices(e){const i=this.view.state.camera;i.projectToScreen(this.location,Ne),Pi(N,this.location,this.direction),i.projectToScreen(N,oe),Ti(oe,X(oe,oe,Ne)),this._updateVertexAttributes(i,e,0,Ne,oe,1),this._updateVertexAttributes(i,e,1,Ne,oe,-1)}_updateVertexAttributes(e,i,n,s,r,o){const l=i.geometryRecords[n],h=l.geometry.getMutableAttribute(Gt.POSITION).data,c=ct(Nt,Ci(Nt,r[1]*o,r[0]*-o),this.offset+this.width/2),u=we(Ae,we(Ae,we(Ae,s,ct(Ae,r,this.length/2)),c),c),g=we(At,u,ct(At,r,-this.length));e.unprojectFromScreen(u,N),h[0]=N[0],h[1]=N[1],h[2]=N[2],e.unprojectFromScreen(g,N),h[3]=N[0],h[4]=N[1],h[5]=N[2],i.geometryVertexAttrsUpdated(l)}}const N=w(),Ne=Ce(),oe=Ce(),Nt=Ce(),Ae=Ce(),At=Ce();let I=class extends qt{constructor(){super(...arguments),this.enabled=!0}};a([d({type:Boolean})],I.prototype,"enabled",void 0),I=a([S("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],I);let v=class extends qt{constructor(t){super(t),this.lineSnapper=new I,this.parallelLineSnapper=new I,this.rightAngleSnapper=new I,this.rightAngleTriangleSnapper=new I,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new j([255,127,0]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5}};a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"lineSnapper",void 0),a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"parallelLineSnapper",void 0),a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"rightAngleSnapper",void 0),a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"rightAngleTriangleSnapper",void 0),a([d({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],v.prototype,"shortLineThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],v.prototype,"distance",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"pointThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"intersectionParallelLineThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"parallelLineThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"touchSensitivityMultiplier",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"pointOnLineThreshold",void 0),a([d({type:j,nonNullable:!0})],v.prototype,"orange",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"lineHintWidthReference",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"lineHintWidthTarget",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"lineHintFadedExtensions",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"parallelLineHintWidth",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],v.prototype,"parallelLineHintLength",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],v.prototype,"parallelLineHintOffset",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],v.prototype,"rightAngleHintSize",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],v.prototype,"rightAngleHintOutlineSize",void 0),v=a([S("esri.views.interactive.snapping.Settings.Defaults")],v);const y=new v;function ne(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}function $(t,e){const i=t.length===e.length&&t[0]===e[0]&&t[1]===e[1];switch(t.length){case 2:return i;case 3:return i&&t[2]===e[2];case 4:return i&&t[3]===e[3]}return!1}function et(t,e){e.sort((i,n)=>ge(i.targetPoint,t)-ge(n.targetPoint,t))}var b;(function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(b||(b={}));class Ve{constructor(e){this.elevationInfo=e}}class tt extends Ve{constructor(e,i){super(i),this.intersectionPoint=e}equals(e){return e instanceof tt&&$(this.intersectionPoint,e.intersectionPoint)}}Pt.getLogger("esri.views.interactive.snapping.hints.LineSnappingHint");class H extends Ve{constructor(e,i,n,s,r=!0,o=!0){super(s),this.type=e,this.lineStart=i,this.lineEnd=n,this.fadeLeft=r,this.fadeRight=o}equals(e){return e instanceof H&&this.type===e.type&&$(this.lineStart,e.lineStart)&&$(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}}Pt.getLogger("esri.views.interactive.snapping.hints.ParallelSnappingHint");class it extends Ve{constructor(e,i,n){super(n),this.lineStart=e,this.lineEnd=i}equals(e){return e instanceof it&&$(this.lineStart,e.lineStart)&&$(this.lineEnd,e.lineEnd)}}class nt extends Ve{constructor(e,i){super(i),this.point=e}equals(e){return e instanceof nt&&$(this.point,e.point)}}Pt.getLogger("esri.views.interactive.snapping.hints.RightAngleSnappingHint");class $e extends Ve{constructor(e,i,n,s){super(s),this.previousVertex=e,this.centerVertex=i,this.nextVertex=n}equals(e){return e instanceof $e&&$(this.previousVertex,e.previousVertex)&&$(this.centerVertex,e.centerVertex)&&$(this.nextVertex,e.nextVertex)}}class Mn{draw(e,i){const n=this._getUniqueHints(e),s=[];for(const r of n)r instanceof tt&&s.push(this.visualizeIntersectionPoint(r,i)),r instanceof H&&s.push(this.visualizeLine(r,i)),r instanceof it&&s.push(this.visualizeParallelSign(r,i)),r instanceof $e&&s.push(this.visualizeRightAngleQuad(r,i)),r instanceof nt&&s.push(this.visualizePoint(r,i));return Oi(s)}_getUniqueHints(e){const i=[];for(const n of e){let s=!0;for(const r of i)if(n.equals(r)){s=!1;break}s&&i.push(n)}return i}}class In extends Mn{visualizeIntersectionPoint(e,i){const{coordinateHelper:n,view:s}=i;return V(new Lt({view:s,primitive:"circle",geometry:n.vectorToPoint(e.intersectionPoint),elevationInfo:ee(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:j.toUnitRGBA(y.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{coordinateHelper:n,view:s}=i;return V(new Lt({view:s,primitive:"circle",geometry:n.vectorToPoint(e.point),elevationInfo:ee(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:j.toUnitRGBA(y.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:n,view:s}=i;return V(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,n,ee(e.elevationInfo,i.elevationInfo),s,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{coordinateHelper:n,view:s}=i,r=ee(e.elevationInfo,i.elevationInfo),o=te(e.lineStart,n,r,i.view),l=te(e.lineEnd,n,r,i.view),h=Ri(l,o,l,.5),c=new Ln({view:s,attached:!1,offset:y.parallelLineHintOffset,length:y.parallelLineHintLength,width:y.parallelLineHintWidth,color:j.toUnitRGBA(y.orange),location:h,renderOccluded:ie.Opaque});return c.setDirectionFromPoints(o,h),c.attached=!0,V(c)}visualizeRightAngleQuad(e,i){const{coordinateHelper:n,view:s}=i,r=ee(e.elevationInfo,i.elevationInfo);return V(new pn({view:s,attached:!0,color:j.toUnitRGBA(y.orange),renderOccluded:ie.Transparent,outlineRenderOccluded:ie.Opaque,outlineColor:j.toUnitRGBA(y.orange),outlineSize:y.rightAngleHintOutlineSize,size:y.rightAngleHintSize,geometry:{previous:te(e.previousVertex,n,r,s),center:te(e.centerVertex,n,r,s),next:te(e.nextVertex,n,r,s)}}))}_createLineSegmentHintFromMap(e,i,n,s,r,o,l=!0,h=!0){const c=w(),u=w();return un(i,n,s,r,o,c,u),this._createLineSegmentHint(e,o,c,u,l,h)}_createLineSegmentHint(e,i,n,s,r=!0,o=!0){const l=new $n({view:i,extensionType:M.FADED,start:n,end:s,color:j.toUnitRGBA(y.orange),renderOccluded:ie.Opaque});switch(e){case b.TARGET:l.width=y.lineHintWidthTarget,l.fadedExtensions={start:0,end:y.lineHintFadedExtensions};break;case b.REFERENCE_EXTENSION:l.width=y.lineHintWidthReference,l.fadedExtensions={start:0,end:0};break;case b.REFERENCE:l.width=y.lineHintWidthReference,l.fadedExtensions={start:r?y.lineHintFadedExtensions:0,end:o?y.lineHintFadedExtensions:0}}return l.attached=!0,l}}let B=class extends F{constructor(t){super(t),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};a([d({constructOnly:!0})],B.prototype,"layer",void 0),a([d()],B.prototype,"enabled",void 0),a([d()],B.prototype,"updating",void 0),a([d()],B.prototype,"availability",void 0),B=a([S("esri.views.interactive.snapping.SnappingLayerSource")],B);const ni=B;class st{constructor(e){this.coordinateHelper=e}}class He extends st{constructor(e,i){super(e),this.point=i}objectEqual(e){return e instanceof He&&$(this.point,e.point)}check(e){return ge(e,this.point)<y.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(e){const i=[];return e instanceof se?i.push(...Jt({start:e.start,end:e.end,type:e instanceof D?R.LINE:R.RAY},this.point)):e instanceof Le&&i.push(...ei(e.center,e.radius,this.point)),i.map(n=>new me(this.coordinateHelper,n,this,e))}}class se extends st{constructor(e,i,n){super(e),this.start=i,this.end=n}objectEqual(e){return e instanceof se&&$(this.start,e.start)&&$(this.end,e.end)}intersect(e){const i=[];return e instanceof He?i.push(...Jt({start:this.start,end:this.end,type:this instanceof D?R.LINE:R.RAY},e.point)):e instanceof se?i.push(...vn({start:this.start,end:this.end,type:this instanceof D?R.LINE:R.RAY},{start:e.start,end:e.end,type:e instanceof D?R.LINE:R.RAY})):e instanceof Le&&i.push(...ti({start:this.start,end:this.end,type:this instanceof D?R.LINE:R.RAY},e.center,e.radius)),i.map(n=>new me(this.coordinateHelper,n,this,e))}}class rt extends se{constructor(e,i,n){super(e,i,n),this.dir=k(),this.p=k()}objectEqual(e){return e instanceof rt&&super.objectEqual(e)}check(e){return X(this.dir,this.end,this.start),X(this.p,e,this.start),Tt(this.dir,this.p)>=0&&Kt(e,this.start,this.end)<y.pointOnLineThreshold}closestTo(e){const i=this.coordinateHelper.clone(e);return yn(i,e,this.start,this.end),i}}class D extends se{constructor(e,i,n){super(e,i,n)}objectEqual(e){return e instanceof D&&super.objectEqual(e)}check(e){return Kt(e,this.start,this.end)<y.pointOnLineThreshold}closestTo(e){const i=this.coordinateHelper.clone(e);return be(i,e,this.start,this.end),i}}class me extends st{constructor(e,i,n,s){super(e),this.intersection=i,this.first=n,this.second=s}objectEqual(e){return e instanceof me&&this.first.objectEqual(e.first)&&this.second.objectEqual(e.second)}check(){return!1}closestTo(e){const i=this.coordinateHelper.clone(e);return Vi(i,this.intersection),i}intersect(){return[]}}class Le extends st{constructor(e,i,n){super(e),this.center=i,this.radius=n}objectEqual(e){return e instanceof Le&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}check(){return!1}closestTo(e){const i=this.coordinateHelper.clone(e);return ii(i,e,this.center,this.radius),i}intersect(e){const i=[];return e instanceof se?i.push(...ti({start:e.start,end:e.end,type:e instanceof D?R.LINE:R.RAY},this.center,this.radius)):e instanceof He&&i.push(...ei(this.center,this.radius,e.point)),i.map(n=>new me(this.coordinateHelper,n,this,e))}}class ye{constructor(e,i,n,s){this.coordinateHelper=e,this.targetPoint=i,this.constraint=n,this.elevationInfo=s}}class Ct extends ye{constructor({coordinateHelper:e,targetPoint:i,objectId:n,constraint:s,elevationInfo:r}){super(e,i,s,r),this.objectId=n}}class si extends Ct{constructor(e){super({...e,constraint:new D(e.coordinateHelper,e.edgeStart,e.edgeEnd)})}get hints(){return[new H(b.REFERENCE,this.constraint.start,this.constraint.end,this.elevationInfo)]}}class Dn extends Ct{constructor(e){super({...e,constraint:new He(e.coordinateHelper,e.targetPoint)})}get hints(){return[new nt(this.targetPoint,this.elevationInfo)]}}let Q=class extends Oe{constructor(t){super(t),this.availability=0,this._ids=new Set,this.tmpP=w()}destroy(){this.workerHandle.destroy(),this.workerHandle=null}initialize(){this.workerHandle=new kn(this.schedule,{fetchAllEdgeLocations:(t,e)=>this._fetchAllEdgeLocations(t,e)})}async fetchCandidates(t,e){const i=t.coordinateHelper.toXYZ(t.point);this.view.renderCoordsHelper.toRenderCoords(i,t.coordinateHelper.spatialReference,i);const n=typeof t.distance=="number"?t.distance:t.distance.pixelSize,s=await this.workerHandle.invoke({bounds:$i(i[0],i[1],i[2],n),types:t.types},e),r=t.coordinateHelper;return s.candidates.sort((o,l)=>o.distance-l.distance),s.candidates.map(o=>this._convertCandidate(r,o))}async add(t,e){this._ids.add(t.id),await this.workerHandle.invokeMethod("add",t,e)}async remove(t,e){this._ids.delete(t.id),await this.workerHandle.invokeMethod("remove",t,e)}_convertCandidate(t,e){switch(e.type){case"edge":return new si({coordinateHelper:t,objectId:e.objectId,targetPoint:this._convertRenderCoordinate(t,e.target),edgeStart:this._convertRenderCoordinate(t,e.start),edgeEnd:this._convertRenderCoordinate(t,e.end),elevationInfo:Mt});case"vertex":return new Dn({coordinateHelper:t,objectId:e.objectId,targetPoint:this._convertRenderCoordinate(t,e.target),elevationInfo:Mt})}}_convertRenderCoordinate(t,e){return this.view.renderCoordsHelper.fromRenderCoords(e,this.tmpP,t.spatialReference),t.fromXYZ(this.tmpP)}async _fetchAllEdgeLocations(t,e){const i=[],n=[];for(const{id:s,uid:r}of t.components)this._ids.has(s)&&i.push((async()=>{const o=await this.fetchEdgeLocations(s,e.signal);return n.push(o.locations.buffer),{id:s,uid:r,objectIds:o.objectIds,locations:o.locations.buffer,origin:o.origin,type:o.type}})());return{result:{components:(await Promise.all(i)).filter(({id:s})=>this._ids.has(s))},transferList:n}}};a([d({constructOnly:!0})],Q.prototype,"view",void 0),a([d({constructOnly:!0})],Q.prototype,"fetchEdgeLocations",void 0),a([d({constructOnly:!0})],Q.prototype,"schedule",void 0),a([d({readOnly:!0})],Q.prototype,"availability",void 0),Q=a([S("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],Q);class kn extends Hi{constructor(e,i){super("SceneLayerSnappingSourceWorker","fetchCandidates",{},e,{strategy:"dedicated",client:i})}}let K=class extends Oe{constructor(t){super(t),this.availability=1,this.abortController=new AbortController}get updating(){return this.updatingHandles.updating}get layer(){return this.layerSource.layer}destroy(){this.abortController=fe(this.abortController)}initialize(){const t=this.view.resourceController;this.edgeWorker=new Li(e=>t.schedule(e)),this.workerHandle=new Q({view:this.view,schedule:e=>t.schedule(e),fetchEdgeLocations:async(e,i)=>{if(m(this.tracker))throw new Error("tracker-not-initialized");return this.tracker.fetchEdgeLocations(e,this.edgeWorker,i)}}),this.updatingHandles.addPromise(this._setupLayerView()),this.handles.add([V(this.workerHandle),V(this.edgeWorker)])}async fetchCandidates(t,e){return this.workerHandle.fetchCandidates(t,e)}refresh(){}async _setupLayerView(){const t=await this.view.whenLayerView(this.layer);if(t.type==="scene-layer-graphics-3d")return;const e={add:(i,n)=>this.updatingHandles.addPromise(this.workerHandle.add({id:i,bounds:n},this.abortController.signal)),remove:i=>this.updatingHandles.addPromise(this.workerHandle.remove({id:i},this.abortController.signal))};this.tracker=t.trackSnappingSources(e),this.handles.add(this.tracker)}};a([d({constructOnly:!0})],K.prototype,"layerSource",void 0),a([d({constructOnly:!0})],K.prototype,"view",void 0),a([d({readOnly:!0})],K.prototype,"updating",null),a([d({readOnly:!0})],K.prototype,"availability",void 0),K=a([S("esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource")],K);let J=class extends F{constructor(t){super(t),this.options=null,this._snappingSources=new Re}initialize(){this.own([this.view.on("layerview-create",({layerView:t})=>this._createSource(t)),this.view.on("layerview-destroy",({layerView:t})=>this._removeSource(t))]);for(const t of this.view.allLayerViews.items)this._createSource(t)}destroy(){this.options=null,this._snappingSources.drain(t=>t.destroy())}get updating(){return this._snappingSources.some(t=>t.updating)}get _types(){return Ke.EDGE|Ke.VERTEX}async fetchCandidates(t,e,i){const{view:n,options:s}=this,{coordinateHelper:r,elevationInfo:o}=e,l=f(s)?s.distance:1,h=te(t,r,o,n,ce.get()),c=l*n.state.camera.computeScreenPixelSizeAt(h),u=this._types,g=this._snappingSources.items.map(_=>_.fetchCandidates({point:t,coordinateHelper:r,distance:c,types:u},i)),p=(await Promise.all(g)).flat();return et(t,p),p}_createSource(t){if(t.type!=="scene-layer-3d")return;const e=new K({layerSource:new ni({layer:t.layer}),view:this.view});this._snappingSources.push(e)}_removeSource(t){const e=this._snappingSources.findIndex(i=>i.layerSource.layer===t.layer);e!==-1&&this._snappingSources.removeAt(e).destroy()}};a([d({constructOnly:!0})],J.prototype,"view",void 0),a([d()],J.prototype,"updating",null),a([d()],J.prototype,"options",void 0),a([d()],J.prototype,"_snappingSources",void 0),J=a([S("esri.views.interactive.snapping.SceneSnappingEngine")],J);class ri extends ye{constructor({coordinateHelper:e,targetPoint:i,constraint:n,previousVertex:s,otherVertex:r,otherVertexType:o,objectId:l,elevationInfo:h}){super(e,i,n,h),this.previousVertex=s,this.otherVertex=r,this.otherVertexType=o,this.objectId=l}get hints(){const e=this.previousVertex,i=this.otherVertexType===_e.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===_e.CENTER?this.targetPoint:this.otherVertex,s=this.elevationInfo;return[new H(b.TARGET,i,n,s),new H(b.REFERENCE,e,i,s),new $e(this.previousVertex,i,n,s)]}}var _e;(function(t){t[t.NEXT=0]="NEXT",t[t.CENTER=1]="CENTER"})(_e||(_e={}));let q=class extends Oe{constructor(t){super(t),this.options=null,this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return Mi(this.snappingSources,({snappingSource:t})=>t.updating)||this.updatingHandles.updating}get snappingSources(){const t=this._get("snappingSources")||new Map,e=new Map;if(f(this.options)&&f(this.options.featureSources))for(const i of this.options.featureSources.items){const n=i.layer.uid,s=t.get(n);if(s){t.delete(n),e.set(n,s);continue}if(!i.layer.loaded){this.updatingHandles.addPromise(i.layer.load());continue}const r=this._createSourceInfo(i);f(r)&&e.set(n,r)}for(const[,i]of t)i.destroy();return e}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),Be),f(this.view)&&this.handles.add([this.view.on("layerview-create",t=>this._updateLayerView(t.layer,t.layerView)),this.view.on("layerview-destroy",t=>this._updateLayerView(t.layer,null))])}_updateLayerView(t,e){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===t&&(i.layerView=e)}destroy(){this._set("options",null);for(const[,t]of this.snappingSources)t.destroy()}async fetchCandidates(t,e,i){if(m(this.options)||!this.options.effectiveFeatureEnabled)return[];const n=[],s=this._computeScreeenSizeDistanceParameters(t,e),r={distance:s,point:t,coordinateHelper:e.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:l,layerView:h}]of this.snappingSources)!l.layerSource.enabled||f(h)&&h.suspended||n.push(l.fetchCandidates(r,i).then(c=>c.filter(u=>!this._candidateIsExcluded(l,u,e.excludeFeature))));const o=(await Ii(n)).flat();return this._addRightAngleCandidates(o,t,s,e),Di(i),et(t,o),o}_addRightAngleCandidates(t,e,i,n){var l,h,c,u,g,p,_,O;const s=f(n.vertexHandle)?(h=(l=n.vertexHandle.rightEdge)==null?void 0:l.rightVertex)==null?void 0:h.pos:f(n.editGeometryOperations)&&n.editGeometryOperations.data.type==="polygon"?(u=U((c=n.editGeometryOperations.data.components[0])==null?void 0:c.getFirstVertex()))==null?void 0:u.pos:null,r=f(n.vertexHandle)?(p=(g=n.vertexHandle.leftEdge)==null?void 0:g.leftVertex)==null?void 0:p.pos:f(n.editGeometryOperations)?(O=U((_=n.editGeometryOperations.data.components[0])==null?void 0:_.getLastVertex()))==null?void 0:O.pos:null,o=t.length;for(let E=0;E<o;E++)this._addRightAngleCandidate(t[E],r,e,i,n,t),this._addRightAngleCandidate(t[E],s,e,i,n,t)}_addRightAngleCandidate(t,e,i,n,s,r){if(m(e)||!(t instanceof si))return;const o=t.constraint.closestTo(e),l=(o[0]-i[0])/n.x,h=(o[1]-i[1])/n.y;if(l*l+h*h<=1){const c=s.coordinateHelper;r.push(new ri({coordinateHelper:c,targetPoint:o,otherVertex:e,otherVertexType:_e.NEXT,previousVertex:t.constraint.start,constraint:new rt(c,e,o),objectId:t.objectId,elevationInfo:t.elevationInfo}))}}_computeScreeenSizeDistanceParameters(t,e){const i=f(this.options)?this.options.distance*(e.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;if(m(this.view))return{x:i,y:i,pixelSize:i};if(this.view.type==="2d"){const n=i*this.view.resolution;return{x:n,y:n,pixelSize:n}}return this._computeScreenSizeDistanceParameters3D(t,i,this.view,e)}_computeScreenSizeDistanceParameters3D(t,e,i,n){const{coordinateHelper:s,elevationInfo:r}=n,o=i.state.camera.computeScreenPixelSizeAt(te(t,s,r,i,An)),l=o*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,h=e*l;return{x:h/this._computeScreenMagnitudeOfMapOffset(t,l,0,i,n),y:h/this._computeScreenMagnitudeOfMapOffset(t,0,l,i,n),pixelSize:o}}_computeScreenMagnitudeOfMapOffset(t,e,i,n,{coordinateHelper:s,elevationInfo:r}){const o=s.clone(t);o[0]+=e,o[1]+=i;const l=x(t,s,r,n),h=x(o,s,r,n),c=h.x-l.x,u=h.y-l.y;return Math.sqrt(c*c+u*u)}get types(){return Ke.EDGE|Ke.VERTEX}_candidateIsExcluded(t,e,i){if(m(i))return!1;const n=this._getCandidateObjectId(e);if(m(n))return!1;const s=t.layerSource.layer;return s.type==="graphics"?i.uid===n:i.sourceLayer===s&&!(!i.attributes||!("objectIdField"in s))&&i.attributes[s.objectIdField]===n}_getCandidateObjectId(t){return t instanceof Ct?t.objectId:null}_createSourceInfo(t){const e=this._createFeatureSnappingSourceType(t);if(m(e))return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const i=f(this.view)?this.view.allLayerViews.find(n=>n.layer===t.layer):null;return new Nn(e.source,i)}_createFeatureSnappingSourceType(t){switch(t.layer.type){case"feature":case"geojson":case"csv":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(t);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(t)}return null}_createFeatureSnappingSourceFeatureLayer(t){switch(t.layer.source.type){case"feature-layer":{const e=this._getSourceModule("featureService");return f(e.module)?{source:new e.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(t.layer.geometryType==="mesh")return null;const e=this._getSourceModule("featureCollection");return f(e.module)?{source:new e.module.FeatureCollectionSnappingSource({layerSource:t})}:{loading:e.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(t){const e=this._getSourceModule("graphics");return f(e.module)?{source:new e.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}_getSourceModule(t){const e=this.sourceModules[t];if(m(e.loader)){const i=this._loadSourceModule(t).then(n=>{e.module=n});return e.loader=i,{module:e.module,loader:i}}return{module:e.module,loader:e.loader}}_loadSourceModule(t){switch(t){case"featureService":return this.updatingHandles.addPromise(pt(()=>import("./FeatureServiceSnappingSource.fb15aff9.js"),["FeatureServiceSnappingSource.fb15aff9.js","index.a8738f47.js","index.7b18f6ca.css","queryEngineUtils.974386a1.js","TileTreeDebugger.89d4994d.js","LineVisualElement.c8ac394d.js","analysisViewUtils.1368068e.js","PointVisualElement.1a1f0dbc.js","RightAngleQuadVisualElement.93093297.js","Segment.00e10e0b.js","elevationInfoUtils.fe889101.js","dragEventPipeline3D.dd7775a3.js","EditGeometryOperations.17db3234.js","QueryEngineResult.3d7a8c8d.js","WhereClause.d715e7d1.js","utils.bf6b5607.js","ClassBreaksDefinition.d9c6c51f.js","json.d1a0fa35.js","dehydratedFeatureComparison.47577290.js"],import.meta.url));case"featureCollection":return this.updatingHandles.addPromise(pt(()=>import("./FeatureCollectionSnappingSource.fbcd3a6c.js"),["FeatureCollectionSnappingSource.fbcd3a6c.js","index.a8738f47.js","index.7b18f6ca.css","queryEngineUtils.974386a1.js","LineVisualElement.c8ac394d.js","analysisViewUtils.1368068e.js","PointVisualElement.1a1f0dbc.js","RightAngleQuadVisualElement.93093297.js","Segment.00e10e0b.js","elevationInfoUtils.fe889101.js","dragEventPipeline3D.dd7775a3.js","EditGeometryOperations.17db3234.js","QueryEngineResult.3d7a8c8d.js","WhereClause.d715e7d1.js","utils.bf6b5607.js","ClassBreaksDefinition.d9c6c51f.js","json.d1a0fa35.js","dehydratedFeatureComparison.47577290.js"],import.meta.url));case"graphics":return this.updatingHandles.addPromise(pt(()=>import("./GraphicsSnappingSource.da16ad06.js"),["GraphicsSnappingSource.da16ad06.js","index.a8738f47.js","index.7b18f6ca.css","normalizeUtilsSync.0990a781.js","FeatureStore.b55521bf.js","PooledRBush.dcfb0021.js","quickselect.03306040.js","optimizedFeatureQueryEngineAdapter.c129ff5f.js","centroid.88cb65db.js","QueryEngine.dd064fa9.js","QueryEngineResult.3d7a8c8d.js","WhereClause.d715e7d1.js","utils.bf6b5607.js","ClassBreaksDefinition.d9c6c51f.js","json.d1a0fa35.js","QueryEngineCapabilities.c2e9875c.js","queryEngineUtils.974386a1.js","LineVisualElement.c8ac394d.js","analysisViewUtils.1368068e.js","PointVisualElement.1a1f0dbc.js","RightAngleQuadVisualElement.93093297.js","Segment.00e10e0b.js","elevationInfoUtils.fe889101.js","dragEventPipeline3D.dd7775a3.js","EditGeometryOperations.17db3234.js","dehydratedFeatureComparison.47577290.js"],import.meta.url))}return null}};a([d({constructOnly:!0})],q.prototype,"spatialReference",void 0),a([d({constructOnly:!0})],q.prototype,"view",void 0),a([d()],q.prototype,"options",void 0),a([d({readOnly:!0})],q.prototype,"updating",null),a([d({readOnly:!0})],q.prototype,"snappingSources",null),q=a([S("esri.views.interactive.snapping.FeatureSnappingEngine")],q);class Nn{constructor(e,i){this.snappingSource=e,this.layerView=i,this.handles=new Je;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([C(()=>e.updating,s=>e.layerSource.updating=s,Te),C(()=>e.availability,s=>e.layerSource.availability=s,Te)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const An=w();class ot{constructor(e,i){this.view=e,this.options=i,this.squaredShortLineThreshold=y.shortLineThreshold*y.shortLineThreshold}snap(e,i){return f(i.vertexHandle)?i.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,i):this.snapNewVertex(e,i)}edgeExceedsShortLineThreshold(e,i){return this.exceedsShortLineThreshold(e.leftVertex.pos,e.rightVertex.pos,i)}exceedsShortLineThreshold(e,i,{elevationInfo:n,editGeometryOperations:s}){const r=s.data.coordinateHelper;return this.squaredShortLineThreshold===0||ne(x(i,r,n,this.view),x(e,r,n,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return e==="touch"?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:i}=this.options,n=e*i;return n*n}}class zn extends ye{constructor({coordinateHelper:e,lineStart:i,lineEnd:n,targetPoint:s,elevationInfo:r}){super(e,s,new D(e,i,n),r),this.referenceLineHint=new H(b.REFERENCE_EXTENSION,i,n,r)}get hints(){return[this.referenceLineHint,new H(b.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.elevationInfo)]}_lineEndClosestToTarget(){const e=this.constraint.start,i=this.constraint.end;return Math.sign(Tt(X(Fn,i,e),X(jn,this.targetPoint,e)))>0?i:e}}const jn=k(),Fn=k();class Gn extends ot{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const o=i.coordinateHelper,l=x(e,o,i.elevationInfo,this.view),h=n.edges[s-1];let c=h;do this.edgeExceedsShortLineThreshold(c,i)&&this._processCandidateProposal(c.leftVertex.pos,c.rightVertex.pos,e,l,i,r),c=c.leftVertex.leftEdge;while(c&&c!==h);return r}snapExistingVertex(e,i){const n=[],s=U(i.vertexHandle),r=s.component;if(r.edges.length<2)return n;const o=i.coordinateHelper,l=x(e,o,i.elevationInfo,this.view),h=s.leftEdge,c=s.rightEdge;h&&c&&this.edgeExceedsShortLineThreshold(h,i)&&this.edgeExceedsShortLineThreshold(c,i)&&this._processCandidateProposal(h.leftVertex.pos,c.rightVertex.pos,e,l,i,n);const u=r.edges[0];let g=u;do g!==s.leftEdge&&g!==s.rightEdge&&this.edgeExceedsShortLineThreshold(g,i)&&this._processCandidateProposal(g.leftVertex.pos,g.rightVertex.pos,e,l,i,n),g=g.rightVertex.rightEdge;while(g&&g!==u);return n}_processCandidateProposal(e,i,n,s,r,o){const l=be(k(),n,e,i),{coordinateHelper:h,elevationInfo:c,pointer:u}=r,g=h.fromXYZ(l,h.getZ(n,0));ne(s,x(g,h,c,this.view))<this.squaredProximityTreshold(u)&&o.push(new zn({coordinateHelper:h,lineStart:e,lineEnd:i,targetPoint:g,elevationInfo:c}))}}class qn extends ye{constructor({coordinateHelper:e,referenceLine:i,lineStart:n,targetPoint:s,elevationInfo:r}){const o=e.clone(n);X(o,we(o,o,i.rightVertex.pos),i.leftVertex.pos),super(e,s,new D(e,n,o),r),this._referenceLines=[{edge:i,fadeLeft:!0,fadeRight:!0}]}get hints(){const e=this.elevationInfo;return[new H(b.TARGET,this.constraint.start,this.targetPoint,e),new it(this.constraint.start,this.targetPoint,e),...this._referenceLines.map(i=>new H(b.REFERENCE,i.edge.leftVertex.pos,i.edge.rightVertex.pos,e,i.fadeLeft,i.fadeRight))]}addReferenceLine(e){const i={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(n=>{e.rightVertex.rightEdge===n.edge&&(n.fadeLeft=!1,i.fadeRight=!1),e.leftVertex.leftEdge===n.edge&&(n.fadeRight=!1,i.fadeLeft=!1)}),this._referenceLines.push(i)}}class Wn extends ot{constructor(){super(...arguments),this._tmpProjection=k()}snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,o=[];if(s<2)return o;const l=x(e,i.coordinateHelper,i.elevationInfo,this.view),h=n.vertices[r-1],c=n.vertices[0],u=n.edges[s-1];let g=u;do this.edgeExceedsShortLineThreshold(g,i)&&(this._checkEdgeForParalleLines(g,h.pos,e,l,i,o),this._checkEdgeForParalleLines(g,c.pos,e,l,i,o)),g=g.leftVertex.leftEdge;while(g&&g!==u);return o}snapExistingVertex(e,i){const n=[],s=U(i.vertexHandle),r=s.component;if(r.edges.length<3)return n;const o=x(e,i.coordinateHelper,i.elevationInfo,this.view),l=s.leftEdge,h=s.rightEdge,c=r.vertices[0],u=r.vertices.length,g=r.vertices[u-1],p=r.edges[0];let _=p;do _!==l&&_!==h&&this.edgeExceedsShortLineThreshold(_,i)&&(l&&this._checkEdgeForParalleLines(_,l.leftVertex.pos,e,o,i,n),h&&this._checkEdgeForParalleLines(_,h.rightVertex.pos,e,o,i,n),s===c?this._checkEdgeForParalleLines(_,g.pos,e,o,i,n):s===g&&this._checkEdgeForParalleLines(_,c.pos,e,o,i,n)),_=_.rightVertex.rightEdge;while(_&&_!==p);return n}_checkEdgeForParalleLines(e,i,n,s,r,o){const l=e.leftVertex.pos,h=e.rightVertex.pos;if(be(this._tmpProjection,i,l,h),ge(this._tmpProjection,i)<y.parallelLineThreshold)return;be(this._tmpProjection,n,l,h,i);const{coordinateHelper:c,elevationInfo:u,pointer:g}=r,p=c.fromXYZ(this._tmpProjection,c.getZ(n,0));if(ne(s,x(p,c,u,this.view))<this.squaredProximityTreshold(g)){if(this._parallelToPreviousCandidate(e,o))return;o.push(new qn({coordinateHelper:c,referenceLine:e,lineStart:i,targetPoint:p,elevationInfo:u}))}}_parallelToPreviousCandidate(e,i){const n=e.leftVertex.pos,s=e.rightVertex.pos;for(const r of i)if(be(this._tmpProjection,s,r.constraint.start,r.constraint.end,n),ge(this._tmpProjection,s)<y.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}class Un extends ot{constructor(){super(...arguments),this._tmp=k()}snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const o=x(e,i.coordinateHelper,i.elevationInfo,this.view),l=n.vertices[s-1];this._checkForSnappingCandidate(r,l.leftEdge,l.pos,e,l.leftEdge.leftVertex.pos,l.pos,i,e,o);const h=n.vertices[0];return this._checkForSnappingCandidate(r,h.rightEdge,h.pos,e,h.rightEdge.rightVertex.pos,h.pos,i,e,o),r}snapExistingVertex(e,i){const n=[],s=U(i.vertexHandle),r=s.component,o=r.vertices.length;if(o<3)return n;const l=x(e,i.coordinateHelper,i.elevationInfo,this.view),h=s.leftEdge,c=s.rightEdge,u=r.vertices[0],g=r.vertices[o-1];if(!h)return this._checkForSnappingCandidate(n,u.rightEdge.rightVertex.rightEdge,u.rightEdge.rightVertex.pos,e,u.rightEdge.rightVertex.rightEdge.rightVertex.pos,u.rightEdge.rightVertex.pos,i,e,l),n;if(!c)return this._checkForSnappingCandidate(n,g.leftEdge.leftVertex.leftEdge,g.leftEdge.leftVertex.pos,e,g.leftEdge.leftVertex.leftEdge.leftVertex.pos,g.leftEdge.leftVertex.pos,i,e,l),n;if(h&&h.leftVertex.leftEdge){const p=h.leftVertex.leftEdge;this._checkForSnappingCandidate(n,p,h.leftVertex.pos,e,p.leftVertex.pos,h.leftVertex.pos,i,e,l)}if(c&&c.rightVertex.rightEdge){const p=c.rightVertex.rightEdge;this._checkForSnappingCandidate(n,p,c.rightVertex.pos,e,p.rightVertex.pos,c.rightVertex.pos,i,e,l)}return n}_checkForSnappingCandidate(e,i,n,s,r,o,l,h,c){if(!this.edgeExceedsShortLineThreshold(i,l))return;X(this._tmp,i.rightVertex.pos,i.leftVertex.pos);const u=ki(this._tmp[1],-this._tmp[0]),g=Tt(u,X(this._tmp,s,n))/Ni(u),{coordinateHelper:p,elevationInfo:_,pointer:O}=l,E=p.fromXYZ(Rt(k(),o,u,g),p.getZ(h,0));ne(c,x(E,p,_,this.view))<this.squaredProximityTreshold(O)&&e.push(new ri({coordinateHelper:p,targetPoint:E,constraint:new rt(p,o,Rt(p.createVector(),o,u,Math.sign(g))),previousVertex:r,otherVertex:o,otherVertexType:_e.CENTER,elevationInfo:_}))}}class Xn extends ye{constructor({coordinateHelper:e,targetPoint:i,point1:n,point2:s,elevationInfo:r}){super(e,i,new Le(e,Wt(Yn,n,s,.5),.5*Ut(n,s)),r),this.p1=n,this.p2=s}get hints(){const e=this.elevationInfo;return[new H(b.REFERENCE,this.targetPoint,this.p1,e),new H(b.REFERENCE,this.targetPoint,this.p2,e),new $e(this.p1,this.targetPoint,this.p2,e)]}}const Yn=k();class Zn extends ot{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(i.editGeometryOperations.data.type!=="polygon"||r<2)return s;const o=n.vertices[0],l=n.vertices[r-1];return this._processCandidateProposal(o.pos,l.pos,e,i,s),s}snapExistingVertex(e,i){const n=[],s=U(i.vertexHandle),r=s.component;return r.edges.length<2||(i.editGeometryOperations.data.type!=="polyline"||s.index!==0&&s.index!==r.vertices.length-1)&&this._processCandidateProposal(s.leftEdge.leftVertex.pos,s.rightEdge.rightVertex.pos,e,i,n),n}_processCandidateProposal(e,i,n,s,r){if(!this.exceedsShortLineThreshold(e,i,s))return;const o=Wt(k(),e,i,.5),l=.5*Ut(e,i),h=ii(k(),n,o,l),{coordinateHelper:c,elevationInfo:u,pointer:g}=s,p=c.fromXYZ(h,c.getZ(n,0)),_=x(n,c,u,this.view);ne(_,x(p,c,u,this.view))<this.squaredProximityTreshold(g)&&r.push(new Xn({coordinateHelper:c,targetPoint:p,point1:e,point2:i,elevationInfo:u}))}}let ae=class extends F{constructor(t){super(t),this.updating=!1,this._snappers=new Re}initialize(){this._snappers.push(new Wn(this.view,this.options),new Gn(this.view,this.options),new Un(this.view,this.options),new Zn(this.view,this.options))}set options(t){this._set("options",t);for(const e of this._snappers)e.options=t}async fetchCandidates(t,e){if(!this.options.effectiveSelfEnabled)return[];const i=[];for(const n of this._snappers.items)i.push(...n.snap(t,e));return et(t,i),i}};a([d({readOnly:!0})],ae.prototype,"updating",void 0),a([d({constructOnly:!0})],ae.prototype,"view",void 0),a([d()],ae.prototype,"options",null),ae=a([S("esri.views.interactive.snapping.SelfSnappingEngine")],ae);function Bn(t,e){return[new ae({view:t,options:e}),new q({view:t,options:e,spatialReference:t.spatialReference})]}let P=class extends F{constructor(t){super(t),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Re,this.distance=y.distance,this.touchSensitivityMultiplier=y.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};a([d()],P.prototype,"enabled",void 0),a([d()],P.prototype,"enabledToggled",void 0),a([d()],P.prototype,"selfEnabled",void 0),a([d()],P.prototype,"featureEnabled",void 0),a([d({type:Re.ofType(ni)})],P.prototype,"featureSources",void 0),a([d()],P.prototype,"distance",void 0),a([d()],P.prototype,"touchSensitivityMultiplier",void 0),a([d({readOnly:!0})],P.prototype,"effectiveEnabled",null),a([d({readOnly:!0})],P.prototype,"effectiveSelfEnabled",null),a([d({readOnly:!0})],P.prototype,"effectiveFeatureEnabled",null),P=a([S("esri.views.interactive.snapping.SnappingOptions")],P);const Qn=P;class ze extends ye{constructor(e,i,n,s,r){super(e,i,new me(e,i,n.constraint,s.constraint),r),this.first=n,this.second=s}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new tt(this.targetPoint,this.elevationInfo)]}}let z=class extends Ai.EventedMixin(Oe){constructor(t){super(t),this.options=new Qn,this.snappingEnginesFactory=Bn,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}initialize(){this.handles.add([C(()=>{const{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:n}=this.options;return{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:n}},()=>{this.doneSnapping(),this.emit("changed")},Be),C(()=>this.options,t=>{for(const e of this._engines)e.options=t},Be),C(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:t,snappingEnginesFactory:e})=>this._recreateEngines(t,e),Te)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(t=>t.updating)}_recreateEngines(t,e){if(this._destroyEngines(),!t)return;const{view:i,options:n}=this;this._engines=e(i,n)}_destroyEngines(){for(const t of this._engines)t.destroy();this._engines=[]}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,i=t*e;return i*i}async snap(t,e,i){const n=e.coordinateHelper.pointToVector(t),s=await this._fetchCandidates(n,e,i);return{get valid(){return!zi(i)},apply:()=>{const{snappedPoint:r,hints:o}=this._processCandidates(n,s,e);return this._removeVisualization(),f(e.visualizer)&&this.handles.add(e.visualizer.draw(o,{coordinateHelper:e.coordinateHelper,elevationInfo:e.elevationInfo,view:this.view}),je),r}}}update(t,e){this._removeVisualization();let i=t;const n=[];if(f(this._currentMainCandidate)){const s=e.coordinateHelper,r=s.pointToVector(t),o=this._currentMainCandidate.constraint.closestTo(r);if(ne(x(r,s,e.elevationInfo,this.view),x(o,s,e.elevationInfo,this.view))<this._squaredPointProximityThreshold(e.pointer)){i=s.vectorToDehydratedPoint(o),this._currentMainCandidate.targetPoint=o,n.push(...this._currentMainCandidate.hints);for(const l of this._currentOtherActiveCandidates)l.targetPoint=o,n.push(...l.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return f(e.visualizer)&&this.handles.add(e.visualizer.draw(n,{coordinateHelper:e.coordinateHelper,elevationInfo:e.elevationInfo,view:this.view}),je),i}doneSnapping(){this._removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}_removeVisualization(){this.handles.remove(je)}async _fetchCandidates(t,e,i){return(await Promise.all(this._engines.map(n=>n.fetchCandidates(t,e,i)))).flat()}_processCandidates(t,e,i){if(e.length<1)return this.doneSnapping(),{snappedPoint:i.coordinateHelper.vectorToDehydratedPoint(t),hints:[]};et(t,e);const n=this._currentMainCandidate;if(f(n)){const s=this._findOldConstraintInNewCandidates(n,e);if(s>=0){if(!(e[s]instanceof ze))return this._intersectWithOtherCandidates(s,e,t,i);if(ge(t,n.targetPoint)<this._squaredPointProximityThreshold(i.pointer))return this._updateSnappingCandidate(n,e,i)}}return this._intersectWithOtherCandidates(0,e,t,i)}_findOldConstraintInNewCandidates(t,e){return t instanceof ze?this._findOldCandidateIndex(e,t.first)>=0&&this._findOldCandidateIndex(e,t.second)>=0?0:-1:this._findOldCandidateIndex(e,t)}_intersectWithOtherCandidates(t,e,i,n){const s=e[t],r=[],o=n.coordinateHelper;for(let l=0;l<e.length;++l){if(l===t)continue;const h=e[l];for(const c of s.constraint.intersect(h.constraint)){const u=o.fromXYZ(c.intersection,s.targetPoint[2]);r.push([new ze(o,u,s,h,h.elevationInfo),ne(x(i,n.coordinateHelper,n.elevationInfo,this.view),x(u,n.coordinateHelper,n.elevationInfo,this.view))])}}return r.length>0&&(r.sort((l,h)=>l[1]-h[1]),r[0][1]<this._squaredPointProximityThreshold(n.pointer))?this._updateSnappingCandidate(r[0][0],e,n):this._updateSnappingCandidate(s,e,n)}_updateSnappingCandidate(t,e,i){this.doneSnapping(),this._currentMainCandidate=t;const n=this._currentMainCandidate.targetPoint,s=[];s.push(...t.hints);for(const r of e){if(t instanceof ze){if(r.constraint.objectEqual(t.first.constraint)||r.constraint.objectEqual(t.second.constraint))continue}else if(r.constraint.objectEqual(t.constraint))continue;r.constraint.check(n)&&(r.targetPoint=n,this._currentOtherActiveCandidates.push(r),s.push(...r.hints))}return{snappedPoint:i.coordinateHelper.vectorToDehydratedPoint(n),hints:s}}_squaredPointProximityThreshold(t){return t==="touch"?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}_findOldCandidateIndex(t,e){let i=-1;for(let n=0;n<t.length;++n)if(e.constraint.objectEqual(t[n].constraint)){i=n;break}return i}get test(){return{visualizationsActive:this.handles.has(je),engines:this._engines}}};a([d({constructOnly:!0})],z.prototype,"view",void 0),a([d()],z.prototype,"options",void 0),a([d({readOnly:!0})],z.prototype,"updating",null),a([d()],z.prototype,"snappingEnginesFactory",void 0),a([d()],z.prototype,"_engines",void 0),a([d()],z.prototype,"squaredMouseProximityTreshold",null),a([d()],z.prototype,"squaredTouchProximityThreshold",null),z=a([S("esri.views.interactive.snapping.SnappingManager")],z);const je="visualization-handle",Xe=new Map;function Kn(t){Xe.has(t)||Xe.set(t,{referenceCount:0,snappingManager:es(t)});const e=Xe.get(t);e.referenceCount++;const i=ji(()=>Jn(t,e));return{snappingManager:e.snappingManager,...i}}function Jn(t,e){e.referenceCount--,e.referenceCount>0||Fi(()=>{e.referenceCount===0&&(e.snappingManager.destroy(),Xe.delete(t))})}function es(t){return new z({view:t,snappingEnginesFactory:(e,i)=>[new J({view:t,options:i})]})}class oi{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}}class ts{constructor(){this.next=new Ht}createSnapDragEventPipelineStep({predicate:e=()=>!0,cancel:i,snappingManager:n,snappingContext:s,updatingHandles:r}){if(m(n))return p=>p;let o=null,l=null;const h=()=>{o=fe(o),n.doneSnapping(),f(l)&&l.frameTask.remove(),l=null};i.next(p=>(h(),p)),this.next=new Ht;const c=Bt(async({frameTask:p,point:_,context:O,event:E,dx:at,dy:lt},Y)=>{const Me=await p.schedule(()=>n.snap(_,O,Y),Y);if(Me.valid){let Ie=await p.schedule(()=>Me.apply(),Y);_!==u&&(Ie=n.update(u,O)),En(Ie,g)||(E.mapEnd.x=Ie.x+at,E.mapEnd.y=Ie.y+lt,this.next.execute(E))}});let u,g;return p=>{if(!e(p))return p;if(p.action==="start"){const _=n.view.type==="3d"?n.view.resourceController.scheduler.registerTask(Xt.SNAPPING):Yt;l={context:new oi({editGeometryOperations:s.editGeometryOperations,elevationInfo:s.elevationInfo,pointer:s.pointer,vertexHandle:f(p.info)?p.info.handle:null,excludeFeature:s.excludeFeature,visualizer:s.visualizer}),originalPos:f(p.snapOrigin)?s.coordinateHelper.vectorToDehydratedPoint(p.snapOrigin):p.mapStart,frameTask:_}}if(f(l)){const _=l.context.coordinateHelper.vectorToDehydratedPoint(l.context.coordinateHelper.arrayToVector([l.originalPos.x,l.originalPos.y,l.originalPos.z]));_.x+=p.mapEnd.x-p.mapStart.x,_.y+=p.mapEnd.y-p.mapStart.y;const O=p.mapStart.x-l.originalPos.x,E=p.mapStart.y-l.originalPos.y,at={...p,action:"update"},lt=l.context,Y=n.update(_,l.context);if(g=Y,p.mapEnd.x=Y.x+O,p.mapEnd.y=Y.y+E,u=_,p.action!=="end"){const Me=l.frameTask;f(o)||(o=new AbortController),r.addPromise(Zt(c({frameTask:Me,event:at,context:lt,point:_,dx:O,dy:E},o.signal)))}}return p.action==="end"&&h(),p}}}let xe=class extends F{constructor(t){super(t),this.stagedPoint=null,this._abortController=null,this._snap=Bt(async(e,i,n,s)=>{const r=await this._frameTask.schedule(()=>i.snap(e,n,s),s);r.valid&&await this._frameTask.schedule(()=>{this.stagedPoint=r.apply(),e!==this._snapMapPoint&&(this.stagedPoint=i.update(this._snapMapPoint,n))},s)})}initialize(){var e,i;const t=this.view.type==="3d"?(i=(e=this.view)==null?void 0:e.resourceController)==null?void 0:i.scheduler:null;this._frameTask=f(t)?t.registerTask(Xt.SNAPPING):Yt}destroy(){this._abortController=fe(this._abortController),this._frameTask=Gi(this._frameTask)}async snap(t,e,i){return this.stagedPoint=e.update(t,i),this._snapMapPoint=t,m(this._abortController)&&(this._abortController=new AbortController),this._snap(t,e,i,this._abortController.signal)}abort(){this._abortController=fe(this._abortController)}};a([d({constructOnly:!0})],xe.prototype,"view",void 0),a([d()],xe.prototype,"stagedPoint",void 0),xe=a([S("esri.views.interactive.snapping.SnappingOperation")],xe);let le=class extends Oe{constructor(t){super(t),this.stagedDimension=null,this._dimensionManipulators=new Map,this._dimensionHandles=new Je,this._snappingPipeline=new ts,this._snappingManagerResult=Kn(t.view),this.own(this._snappingManagerResult)}initialize(){this._snappingOperation=new xe({view:this.view}),this.own([this._dimensionHandles,C(()=>this._snappingOperation.stagedPoint,t=>{f(this.stagedDimension)&&(this.stagedDimension.endPoint=qi(t,e=>De(e,new he)))},Be)])}destroy(){this._snappingOperation=bt(this._snappingOperation)}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get _snappingManager(){return this._snappingManagerResult.snappingManager}addDimension(t,e){if(this._dimensionManipulators.has(t))return;const i=this._createPointManipulator(t,{isStart:!0}),n=this._createPointManipulator(t,{isStart:!1}),s={startManipulator:i,endManipulator:n};this._setupDimensionToManipulatorsSync(t,s),this._dimensionManipulators.set(t,s),e.add(i),e.add(n)}removeDimension(t,e){const i=this._dimensionManipulators.get(t);if(m(i))return;this._dimensionHandles.remove(t);const{startManipulator:n,endManipulator:s}=i;this._dimensionManipulators.delete(t),e.remove(n),e.remove(s)}getManipulatorsForDimension(t){return this._dimensionManipulators.get(t)}onDeactivate(){this._snappingManager.doneSnapping()}onUnstagedClick({mapPoint:t,pointerType:e}){const i=this._snappingContext(e),n=De(this._snappingManager.update(t,i),new he),s=new Tn({startPoint:n,endPoint:null});return this.stagedDimension=s,this._snappingManager.doneSnapping(),s}onStagedClick({mapPoint:t,pointerType:e}){if(m(this.stagedDimension))return;const i=this._snappingContext(e),n=De(this._snappingManager.update(t,i),new he);this.stagedDimension.endPoint=n,this.stagedDimension=null,this._snappingManager.doneSnapping()}onPointerMove({mapPoint:t,pointerType:e}){const i=this._snappingContext(e);this.updatingHandles.addPromise(Zt(this._snappingOperation.snap(t,this._snappingManager,i)))}_setupDimensionToManipulatorsSync(t,e){const{startManipulator:i,endManipulator:n}=e;this._dimensionHandles.add([C(()=>({startPoint:t.startPoint,endPoint:t.endPoint,stagedDimension:this.stagedDimension}),({startPoint:s,endPoint:r,stagedDimension:o})=>{f(s)?(i.available=m(o)||o===t,i.location=s):i.available=!1,f(r)?(n.available=m(o),n.location=r):n.available=!1},Te)],t)}_createPointManipulator(t,e){const{isStart:i}=e,n=i?"startPoint":"endPoint",s=sn(this.view,j.toUnitRGB(Pe.pointManipulators.color),Pe.pointManipulators.opacity);s.available=!1,s.radius=Pe.pointManipulators.radius;const r=rn(s,(o,l,h,c)=>{const u=mn(o);l.next(u).next(_n(this.view)).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(c),snappingManager:this._snappingManager,cancel:h,updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(g=>{const p=De(g.mapEnd,new he);t[n]=p}),h.next(u).next(on(t,[n]))});return this._dimensionHandles.add(r,t),s}_snappingContext(t){return new oi({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new wn(new xn("point",Sn(!0,!1,this.view.spatialReference))),visualizer:new In})}};a([d({constructOnly:!0,nonNullable:!0})],le.prototype,"view",void 0),a([d({readOnly:!0})],le.prototype,"updating",null),a([d()],le.prototype,"stagedDimension",void 0),le=a([S("esri.views.3d.analysis.Dimensioning.LengthDimensionSubTool")],le);var ue;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(ue||(ue={}));let T=class extends an{constructor(t){super(t),this.preferManipulatorCursor=!0,this.analysisViewData=null}initialize(){this._intersector=Wi(this.view.state.viewingMode),this._intersector.options.store=Ui.MIN,this._lengthDimensionSubTool=new le({view:this.view}),this.own(V(this._lengthDimensionSubTool));for(const t of this.analysis.dimensions.items)this._addDimension(t);this.own(this.analysis.dimensions.on("change",t=>{for(const e of t.added)this._addDimension(e);for(const e of t.removed)this._removeDimension(e)})),this.own(C(()=>this.state,t=>{t===ue.Created&&this.finishToolCreation()},Te))}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?f(this._activeSubTool)?ue.Creating:ue.Created:ue.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}getManipulatorsForDimension(t){return this._lengthDimensionSubTool.getManipulatorsForDimension(t)}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){f(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),f(this._activeSubTool.stagedDimension)&&(this.analysis.dimensions.remove(this._activeSubTool.stagedDimension),this._activeSubTool.stagedDimension=null),this._activeSubTool=null)}_clickHandler(t){if(m(this._activeSubTool))return;const e=this._intersectScreen(t);if(!m(e)){if(m(this._activeSubTool.stagedDimension)){const i=this._activeSubTool.onUnstagedClick({mapPoint:e,pointerType:t.pointerType});this.analysis.dimensions.add(i)}else this._activeSubTool.onStagedClick({mapPoint:e,pointerType:t.pointerType});t.stopPropagation()}}_doubleClickHandler(t){this.view.activeTool=null,t.stopPropagation()}_pointerMoveHandler(t){if(m(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);m(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_intersectScreen(t){const e=Xi(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=ce.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_addDimension(t){this._lengthDimensionSubTool.addDimension(t,this.manipulators)}_removeDimension(t){this._lengthDimensionSubTool.removeDimension(t,this.manipulators)}};a([d({constructOnly:!0})],T.prototype,"view",void 0),a([d({constructOnly:!0})],T.prototype,"analysis",void 0),a([d({readOnly:!0})],T.prototype,"state",null),a([d({readOnly:!0})],T.prototype,"updating",null),a([d({readOnly:!0})],T.prototype,"cursor",null),a([d({readOnly:!0})],T.prototype,"preferManipulatorCursor",void 0),a([d({constructOnly:!0})],T.prototype,"analysisViewData",void 0),a([d()],T.prototype,"_activeSubTool",void 0),a([d()],T.prototype,"_lengthDimensionSubTool",void 0),T=a([S("esri.views.3d.analysis.Dimensioning.DimensioningTool")],T);let Se=class extends F{constructor(t){super(t),this._directSegment=new ve,this._dimensionSegment=new ve,this._offsetAxis=w(),this._startOffsetSegment=new ve(this._directSegment.startRenderSpace,this._dimensionSegment.startRenderSpace),this._endOffsetSegment=new ve(this._directSegment.endRenderSpace,this._dimensionSegment.endRenderSpace),this._labelSegment=new ve,this._hasValidGeometry=!1;const e={view:t.view,attached:!0,width:1,color:Yi(1,.5,0,1),renderOccluded:ie.OccludeAndTransparent},i={...e,stipplePattern:Qi(5)};this._dimensionVisualElement=new mt(e),this._startOffsetVisualElement=new mt(i),this._endOffsetVisualElement=new mt(i),this._label=new gn({view:t.view,attached:!0,distance:0,fontSize:Pe.labels.fontSize})}initialize(){this.own([V(this._dimensionVisualElement),V(this._startOffsetVisualElement),V(this._endOffsetVisualElement),V(this._label)]);const{computation:t,view:e}=this,{dimension:i}=t;this.own([C(()=>({startPoint:i.startPoint,endPoint:i.endPoint,offset:i.offset,axis:i.axis,heading:i.heading}),n=>{this._updateGeometry(n),this._updateLines(),this._updateLabelGeometry(e.state.camera)},ut),C(()=>t.length,n=>this._updateLabelContent(n),ut),C(()=>e.state.camera,n=>this._updateLabelGeometry(n),ut)])}get testInfo(){return{dimensionVisualElement:this._dimensionVisualElement,label:this._label}}_updateGeometry({startPoint:t,endPoint:e,offset:i,axis:n}){const{renderCoordsHelper:s}=this.view,r=this._directSegment;if(m(t)||m(e)||!s.toRenderCoords(t,r.startRenderSpace)||!s.toRenderCoords(e,r.endRenderSpace))return void(this._hasValidGeometry=!1);const{startRenderSpace:o,endRenderSpace:l}=r,h=r.eval(.5,ce.get()),c=s.worldUpAtPosition(h,ce.get()),u=s.worldBasisAtPosition(h,Zi.X,ce.get()),g=this._offsetAxis;is(g,o,l,c,n,u);const p=i/s.unitInMeters,[_,O]=ns(o,l,g,p),E=this._dimensionSegment;Qe(E.startRenderSpace,r.startRenderSpace,g,_),Qe(E.endRenderSpace,r.endRenderSpace,g,O),this._hasValidGeometry=!0}_updateLines(){if(!this._hasValidGeometry)return this._dimensionVisualElement.visible=!1,this._startOffsetVisualElement.visible=!1,void(this._endOffsetVisualElement.visible=!1);this._dimensionVisualElement.setGeometryFromSegment(this._dimensionSegment),this._startOffsetVisualElement.setGeometryFromSegment(this._startOffsetSegment),this._endOffsetVisualElement.setGeometryFromSegment(this._endOffsetSegment),this._dimensionVisualElement.visible=!0,this._startOffsetVisualElement.visible=!0,this._endOffsetVisualElement.visible=!0}_updateLabelContent(t){if(m(t)||!this._hasValidGeometry)return this._label.text="",void(this._label.visible=!1);const{value:e}=fn(t,"meters");this._label.text=`${Bi(e,{minimumFractionDigits:2,maximumFractionDigits:2})} m`,this._label.visible=!0}_updateLabelGeometry(t){if(!this._hasValidGeometry)return void(this._label.visible=!1);const{offset:e}=this.computation.dimension,i=t.computeRenderPixelSizeAt(this._dimensionSegment.eval(.5,ce.get())),n=(Math.sign(e)>=0?1:-1)*Pe.labels.offset*i;ss(this._labelSegment,this._dimensionSegment,this._offsetAxis,n),this._label.geometry={type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1}}};function is(t,e,i,n,s,r){switch(s){case"horizontal":return W(t,n);case"vertical":return pe(e,n)<pe(i,n)?ke(t,i,e):ke(t,e,i),gt(t,t,n),Vt(t,$t)?W(t,r):(gt(t,t,n),Et(t,t),t);case"direct":return pe(e,r)>pe(i,r)?ke(t,i,e):ke(t,e,i),gt(t,t,n),Vt(t,$t)?W(t,r):(Et(t,t),t)}}function ns(t,e,i,n=0){const s=pe(e,i),r=pe(t,i),o=Math.abs(s-r)+n;return s>r?[o,n]:[n,o]}function ss(t,e,i,n){Qe(t.startRenderSpace,e.startRenderSpace,i,n),Qe(t.endRenderSpace,e.endRenderSpace,i,n)}a([d({constructOnly:!0,nonNullable:!0})],Se.prototype,"computation",void 0),a([d({constructOnly:!0,nonNullable:!0})],Se.prototype,"view",void 0),Se=a([S("esri.views.3d.analysis.Dimensioning.LengthDimensionVisualization")],Se);let Ee=class extends F{constructor(t){super(t),this._dimensionVisualizations=new Map}initialize(){for(const t of this.computations)this._addComputation(t);this.own(this.computations.on("change",({added:t,removed:e})=>{for(const i of e)this._removeComputation(i);for(const i of t)this._addComputation(i)}))}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values())}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new Se({computation:t,view:this.view}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);m(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}};a([d({constructOnly:!0,nonNullable:!0})],Ee.prototype,"view",void 0),a([d({constructOnly:!0,nonNullable:!0})],Ee.prototype,"computations",void 0),Ee=a([S("esri.views.3d.analysis.Dimensioning.DimensioningVisualization")],Ee);let Ye=class extends F{constructor(t){super(t),this.dimension=null}};a([d({constructOnly:!0,nonNullable:!0})],Ye.prototype,"dimension",void 0),Ye=a([S("esri.views.3d.analysis.LengthDimensionResult")],Ye);const rs=Ye;function os(t,e){const{spatialReference:i}=t;return Ki(i,e.spatialReference)?(Fe[0]=t.x,Fe[1]=t.y,Fe[2]=t.hasZ?t.z:0,Ge[0]=e.x,Ge[1]=e.y,Ge[2]=e.hasZ?e.z:0,as(Fe,Ge,i)):null}function as(t,e,i){const n=ls(t,e,i);return f(n)?{direct:yt(n.direct,n.unit),horizontal:yt(n.horizontal,n.unit),vertical:yt(n.vertical,n.unit)}:null}function ls(t,e,i,n){const s=bn(i),r=Ji(s);if(m(r))return null;const o=e[2]-t[2];if(n==="vertical")return{verticalSigned:o,unit:r};if(!ft(t,i,vt,s)||!ft(e,i,qe,s))return null;if(n==="direct")return{direct:_t(qe,vt),unit:r};if(en(We,t[0],t[1],e[2]),!ft(We,i,We,s))return null;const l=_t(We,qe);return n==="horizontal"?{horizontal:l,unit:r}:{direct:_t(qe,vt),horizontal:l,vertical:Math.abs(o),unit:r}}const Fe=w(),Ge=w(),vt=w(),qe=w(),We=w();let de=class extends F{constructor(t){super(t)}initialize(){this._set("result",new rs({dimension:this.dimension}))}get length(){const{startPoint:t,endPoint:e,axis:i}=this.dimension;if(m(t)||m(e))return null;const n=os(t,e);return m(n)?null:n[i]}};a([d({constructOnly:!0,nonNullable:!0})],de.prototype,"dimension",void 0),a([d({constructOnly:!0,nonNullable:!0})],de.prototype,"result",void 0),a([d()],de.prototype,"length",null),de=a([S("esri.views.3d.analysis.LengthDimensionComputation")],de);let L=class extends nn(F){constructor(t){super(t),this.type="dimensioning-view-3d",this.tool=null,this._computations=new Re,this._dimensionsToResults=new Map,this._placementTask=null}initialize(){this.own([ln(this,T),tn(()=>this.analysis.dimensions,"change",({added:t,removed:e})=>{for(const i of e)this._removeDimension(i);for(const i of t)this._addDimension(i)},{onListenerAdd:t=>{for(const e of t)this._addDimension(e)},onListenerRemove:t=>{for(const e of t)this._removeDimension(e)}})]),this._analysisVisualization=new Ee({view:this.view,computations:this._computations})}destroy(){this._placementTask=fe(this._placementTask),this._analysisVisualization=bt(this._analysisVisualization),this._computations.drain(t=>t.destroy()),dn(this)}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToResults.get(t))}get testInfo(){return{visualization:this._analysisVisualization}}async createLengthDimensions(t){return this._placementTask=fe(this._placementTask),this._placementTask=hn(this,T,t),this._placementTask.promise}_addDimension(t){const e=this._dimensionsToResults;if(e.has(t))return;const i=this._computations,n=new de({dimension:t});i.add(n),e.set(t,n.result)}_removeDimension(t){const e=this._computations,i=this._dimensionsToResults,n=e.findIndex(r=>r.dimension===t),s=e.removeAt(n);i.delete(t),bt(s)}};a([d({readOnly:!0})],L.prototype,"type",void 0),a([d({constructOnly:!0,nonNullable:!0})],L.prototype,"analysis",void 0),a([d()],L.prototype,"tool",void 0),a([d({readOnly:!0})],L.prototype,"results",null),a([d()],L.prototype,"_analysisVisualization",void 0),a([d()],L.prototype,"_computations",void 0),a([d()],L.prototype,"_dimensionsToResults",void 0),a([d()],L.prototype,"_placementTask",void 0),L=a([S("esri.views.3d.analysis.DimensioningAnalysisView3D")],L);const ds=L,xs=Object.freeze(Object.defineProperty({__proto__:null,default:ds},Symbol.toStringTag,{value:"Module"}));export{xs as D,et as a,si as e,Dn as r};
