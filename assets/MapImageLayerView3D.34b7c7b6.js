import{r as O,fj as k,hj as q,hk as Z,e as o,d as l,hl as z,fp as H,am as U,d2 as K,hm as W,n as j,el as M,hn as C,g as G,cW as X,f7 as Y,ho as ee,hp as te,fo as re,hq as se,hr as ie,br as oe,g7 as ae,K as A,t as ne,a6 as le,g$ as pe,aB as ue,a$ as ye}from"./index.a8738f47.js";import{q as me}from"./DynamicLayerView3D.1e5fbd37.js";import{c as ce}from"./ExportImageParameters.7c5e117f.js";import{n as V}from"./floorFilterUtils.69500d62.js";import{s as J}from"./clickToleranceUtils.501648d0.js";import{i as de}from"./sublayerUtils.82b4cc5f.js";import{d as fe,s as he}from"./popupUtils.097ff953.js";import{a as ge}from"./drapedUtils.ed0ea243.js";import"./LayerView3D.8dc7c2ab.js";import"./projectExtentUtils.4c0871bc.js";import"./ImageMaterial.c05046f5.js";import"./LayerView.bc32b3eb.js";import"./RefreshableLayerView.06f790ae.js";const _=s=>s.spatialReference.wkid||JSON.stringify(s.spatialReference);function we(s,e){const{dpi:r,gdbVersion:i,geometry:t,geometryPrecision:n,height:f,layerOption:p,mapExtent:a,maxAllowableOffset:c,returnFieldName:y,returnGeometry:d,returnUnformattedValues:g,returnZ:E,spatialReference:P,timeExtent:$,tolerance:u,width:v}=s.toJSON(),{dynamicLayers:w,layerDefs:h,layerIds:x}=xe(s),F=e&&O(e.geometry)?e.geometry:null,b={geometryPrecision:n,maxAllowableOffset:c,returnFieldName:y,returnGeometry:d,returnUnformattedValues:g,returnZ:E,tolerance:u},N=F&&F.toJSON()||t;if(b.imageDisplay=`${v},${f},${r}`,i&&(b.gdbVersion=i),N&&(delete N.spatialReference,b.geometry=JSON.stringify(N),b.geometryType=k(N)),P?b.sr=P.wkid||JSON.stringify(P):N&&N.spatialReference?b.sr=_(N):a&&a.spatialReference&&(b.sr=_(a)),b.time=$?[$.start,$.end].join(","):null,a){const{xmin:D,ymin:L,xmax:T,ymax:B}=a;b.mapExtent=`${D},${L},${T},${B}`}return h&&(b.layerDefs=h),w&&!h&&(b.dynamicLayers=w),b.layers=p==="popup"?"visible":p,x&&!w&&(b.layers+=`:${x.join(",")}`),b}function xe(s){var P,$;const{mapExtent:e,floors:r,width:i,sublayers:t,layerIds:n,layerOption:f,gdbVersion:p}=s,a=($=(P=t==null?void 0:t.find(u=>u.layer!=null))==null?void 0:P.layer)==null?void 0:$.serviceSublayers,c=f==="popup",y={},d=q({extent:e,width:i,spatialReference:e==null?void 0:e.spatialReference}),g=[],E=u=>{const v=d===0,w=u.minScale===0||d<=u.minScale,h=u.maxScale===0||d>=u.maxScale;if(u.visible&&(v||w&&h))if(u.sublayers)u.sublayers.forEach(E);else{if((n==null?void 0:n.includes(u.id))===!1||c&&(!u.popupTemplate||!u.popupEnabled))return;g.unshift(u)}};if(t==null||t.forEach(E),t&&!g.length)y.layerIds=[];else{const u=de(g,a,p),v=g.map(w=>{const h=V(r,w);return w.toExportImageJSON(h)});if(u)y.dynamicLayers=JSON.stringify(v);else{if(t){let h=g.map(({id:x})=>x);n&&(h=h.filter(x=>n.includes(x))),y.layerIds=h}else n!=null&&n.length&&(y.layerIds=n);const w=be(r,g);if(O(w)&&w.length){const h={};for(const x of w)x.definitionExpression&&(h[x.id]=x.definitionExpression);Object.keys(h).length&&(y.layerDefs=JSON.stringify(h))}}}return y}function be(s,e){const r=!!(s!=null&&s.length),i=e.filter(t=>t.definitionExpression!=null||r&&t.floorInfo!=null);return i.length?i.map(t=>{const n=V(s,t),f=Z(n,t.definitionExpression);return{id:t.id,definitionExpression:f}}):null}var S;let m=S=class extends M{constructor(s){super(s),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(s){return C(S,s)}};o([l({type:Number,json:{write:!0}})],m.prototype,"dpi",void 0),o([l()],m.prototype,"floors",void 0),o([l({type:String,json:{write:!0}})],m.prototype,"gdbVersion",void 0),o([l({types:z,json:{read:H,write:!0}})],m.prototype,"geometry",void 0),o([l({type:Number,json:{write:!0}})],m.prototype,"geometryPrecision",void 0),o([l({type:Number,json:{write:!0}})],m.prototype,"height",void 0),o([l({type:[Number],json:{write:!0}})],m.prototype,"layerIds",void 0),o([l({type:["top","visible","all","popup"],json:{write:!0}})],m.prototype,"layerOption",void 0),o([l({type:U,json:{write:!0}})],m.prototype,"mapExtent",void 0),o([l({type:Number,json:{write:!0}})],m.prototype,"maxAllowableOffset",void 0),o([l({type:Boolean,json:{write:!0}})],m.prototype,"returnFieldName",void 0),o([l({type:Boolean,json:{write:!0}})],m.prototype,"returnGeometry",void 0),o([l({type:Boolean,json:{write:!0}})],m.prototype,"returnM",void 0),o([l({type:Boolean,json:{write:!0}})],m.prototype,"returnUnformattedValues",void 0),o([l({type:Boolean,json:{write:!0}})],m.prototype,"returnZ",void 0),o([l({type:K,json:{write:!0}})],m.prototype,"spatialReference",void 0),o([l()],m.prototype,"sublayers",void 0),o([l({type:W,json:{write:!0}})],m.prototype,"timeExtent",void 0),o([l({type:Number,json:{write:!0}})],m.prototype,"tolerance",void 0),o([l({type:Number,json:{write:!0}})],m.prototype,"width",void 0),m=S=o([j("esri.rest.support.IdentifyParameters")],m);const Q=m;let I=class extends M{constructor(s){super(s),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(s,e){return G.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(s,e){if(!s)return;const{attributes:r,geometry:i}=s;r&&(e.attributes={...r}),O(i)&&(e.geometry=i.toJSON(),e.geometryType=ee.toJSON(i.type))}};o([l({type:String,json:{write:!0}})],I.prototype,"displayFieldName",void 0),o([l({type:G})],I.prototype,"feature",void 0),o([X("feature",["attributes","geometry"])],I.prototype,"readFeature",null),o([Y("feature")],I.prototype,"writeFeature",null),o([l({type:Number,json:{write:!0}})],I.prototype,"layerId",void 0),o([l({type:String,json:{write:!0}})],I.prototype,"layerName",void 0),I=o([j("esri.rest.support.IdentifyResult")],I);const ve=I;async function Pe(s,e,r){const i=(e=Ee(e)).geometry?[e.geometry]:[],t=te(s);return t.path+="/identify",re(i).then(n=>{const f=we(e,{geometry:n&&n[0]}),p=se({...t.query,f:"json",...f}),a=ie(p,r);return oe(t.path,a).then($e).then(c=>Ie(c,e.sublayers))})}function $e(s){const e=s.data;e.results=e.results||[];const r={results:[]};return r.results=e.results.map(i=>ve.fromJSON(i)),r}function Ee(s){return s=Q.from(s)}function Ie(s,e){if(!(e!=null&&e.length))return s;const r=new Map;function i(t){r.set(t.id,t),t.sublayers&&t.sublayers.forEach(i)}e.forEach(i);for(const t of s.results)t.feature.sourceLayer=r.get(t.layerId);return s}const Ne=s=>{let e=class extends s{initialize(){this.exportImageParameters=new ce({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var r;return(r=this.exportImageParameters)==null||r.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(r,i){var f,p,a,c,y,d;const{layer:t}=this;if(!r)throw new A("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:t});const n=(a=(p=(f=this.layer.capabilities)==null?void 0:f.operations)==null?void 0:p.supportsQuery)!=null?a:!0;if(!(((d=(y=(c=this.layer.capabilities)==null?void 0:c.operations)==null?void 0:y.supportsIdentify)!=null?d:!0)&&this.layer.version>=10.5)&&!n)throw new A("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:t});return n?this._fetchPopupFeaturesUsingQueries(r,i):this._fetchPopupFeaturesUsingIdentify(r,i)}canResume(){var r;return!!super.canResume()&&!((r=this.timeExtent)!=null&&r.isEmpty)}async _fetchPopupFeaturesUsingIdentify(r,i){const t=await this._createIdentifyParameters(r,i);if(ne(t))return[];const{results:n}=await Pe(this.layer.parsedUrl,t);return n.map(f=>f.feature)}async _createIdentifyParameters(r,i){var $,u;const{floors:t,spatialReference:n,scale:f}=this.view,p=O(i)?i.event:null,a=await this._collectPopupProviders(this.layer.sublayers,f,i);if(!a.length)return null;await Promise.all(a.map(({sublayer:v})=>v.load().catch(()=>{})));const c=Math.min(le("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((v,w)=>w.renderer?J({renderer:w.renderer,event:p}):v,2)),y=this.createFetchPopupFeaturesQueryGeometry(r,c),d=pe(f,n),g=Math.round(y.width/d),E=new U({xmin:y.center.x-d*g,ymin:y.center.y-d*g,xmax:y.center.x+d*g,ymax:y.center.y+d*g,spatialReference:y.spatialReference}),P=((u=($=this.layer.capabilities)==null?void 0:$.operations)==null?void 0:u.supportsQuery)===!1||await new Promise(v=>{let w=!1;Promise.all(a.map(async({popupTemplate:h})=>{if(h){const x=await this._loadArcadeModules(h);if(w)return;(x==null?void 0:x.arcadeUtils.hasGeometryOperations(h))&&(w=!0,v(!0))}})).finally(()=>v(!1))});return new Q({floors:t,gdbVersion:this.layer.gdbVersion,geometry:r,height:g,layerOption:"popup",mapExtent:E,maxAllowableOffset:P?0:d,returnGeometry:!0,spatialReference:n,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:c,width:g})}async _fetchPopupFeaturesUsingQueries(r,i){const t=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,i),n=O(i)?i.event:null,f=t.map(async({sublayer:p,popupTemplate:a})=>{var E,P;await p.load().catch(()=>{});const c=p.createQuery(),y=J({renderer:p.renderer,event:n}),d=this.createFetchPopupFeaturesQueryGeometry(r,y);if(c.geometry=d,c.outFields=await fe(p,a),"floors"in this.view){const $=(P=(E=this.view)==null?void 0:E.floors)==null?void 0:P.clone(),u=V($,p);O(u)&&(c.where=c.where?`(${c.where}) AND (${u})`:u)}const g=await this._loadArcadeModules(a);return g&&g.arcadeUtils.hasGeometryOperations(a)||(c.maxAllowableOffset=d.width/y),(await p.queryFeatures(c)).features});return(await ue(f)).reduce((p,a)=>a.value?[...p,...a.value]:p,[]).filter(p=>p!=null)}async _collectPopupProviders(r,i,t){const n=[],f=async a=>{const c=a.minScale===0||i<=a.minScale,y=a.maxScale===0||i>=a.maxScale;if(a.visible&&c&&y){if(a.sublayers)a.sublayers.forEach(f);else if(a.popupEnabled){const d=he(a,{...t,defaultPopupTemplateEnabled:!1});O(d)&&n.unshift({sublayer:a,popupTemplate:d})}}},p=r.toArray().reverse().map(f);return await Promise.all(p),n}_loadArcadeModules(r){var i;if(((i=r.expressionInfos)==null?void 0:i.length)||Array.isArray(r.content)&&r.content.some(t=>t.type==="expression"))return ye()}};return o([l()],e.prototype,"exportImageParameters",void 0),o([l({readOnly:!0})],e.prototype,"exportImageVersion",null),o([l()],e.prototype,"layer",void 0),o([l()],e.prototype,"suspended",void 0),o([l(ae)],e.prototype,"timeExtent",void 0),e=o([j("esri.views.layers.MapImageLayerView")],e),e};let R=class extends Ne(me){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(()=>this.exportImageVersion,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(s,e){return ge(s,e,this.view)}getFetchOptions(){return{timeExtent:this.timeExtent}}};R=o([j("esri.views.3d.layers.MapImageLayerView3D")],R);const De=R;export{De as default};
