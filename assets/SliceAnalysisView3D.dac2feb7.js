import{io as qt,el as Xt,lG as Yt,e as c,d as p,aO as Jt,j2 as Ye,kx as Je,ky as Ze,n as ce,a6 as Zt,em as le,iy as F,jm as me,dT as J,c2 as ei,c3 as ti,bN as ie,c7 as et,js as tt,cb as ii,cg as ai,bj as si,cl as ni,cm as ri,cn as li,co as oi,jt as hi,ci as ue,bo as di,cu as ci,gz as ui,cA as pi,gL as gi,cC as yi,cE as wi,cF as vi,bm as fi,cc as _i,gU as mi,aX as Tt,ju as C,eI as it,r as h,bK as G,a8 as Et,kT as Me,kC as Ct,kt as o,aN as f,ag as H,lV as kt,eR as z,jc as K,jb as I,aM as b,en as k,eT as U,lW as Le,kf as Ot,le as N,lX as Pi,lY as $e,lZ as Di,l_ as bi,ku as St,aK as ne,l$ as Qe,lE as It,dO as Z,m0 as Lt,eS as Ai,lg as pe,ck as ge,m1 as je,l0 as O,aj as ee,t as y,jr as Mi,jf as Re,bu as $t,m2 as at,m3 as Rt,m4 as E,m5 as xe,bM as Vi,m6 as Pe,m7 as Ti,jW as Ei,l4 as st,lp as nt,dp as Te,dk as rt,m8 as lt,m9 as ot,y as Fe,u as De,B as ht,ma as Ci,x,aJ as He,bW as xt,mb as ki,kp as Oi,a9 as Si,aa as Ii,U as Li,G as ze,er as dt,f as q,lT as he,mc as T,kg as ct,hW as Ge,kX as fe,kk as $i,md as Ri,dl as ut,dj as xi,az as pt,kV as gt,kW as Hi,lk as zi,me as Ht,kq as Gi,jw as Ni,mf as Ui}from"./index.a8738f47.js";import{n as Qi,C as ji,a as Fi}from"./LineVisualElement.c8ac394d.js";import{w as de}from"./persistable.6d7b5a7d.js";import{E as Wi}from"./BuildingComponentSublayer.ecd163b1.js";import{n as Bi,a as Ki}from"./projectionUtils.eb41893b.js";import{k as qi,t as We,a as Xi,p as ye,O as Yi,c as Ji,m as Zi}from"./analysisViewUtils.1368068e.js";import{m as ea}from"./ImageMaterial.c05046f5.js";import{C as we}from"./dragEventPipeline3D.dd7775a3.js";let Q=class extends qt(Xt){constructor(e){super(e),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(e){return this.heading===e.heading&&this.tilt===e.tilt&&Yt(this.position,e.position)&&this.width===e.width&&this.height===e.height}};c([p({readOnly:!0,json:{read:!1,write:!0}})],Q.prototype,"type",void 0),c([p({type:Jt}),de()],Q.prototype,"position",void 0),c([p({type:Number,nonNullable:!0,range:{min:0,max:360}}),de(),Ye(e=>Je.normalize(Ze(e),0,!0))],Q.prototype,"heading",void 0),c([p({type:Number,nonNullable:!0,range:{min:0,max:360}}),de(),Ye(e=>Je.normalize(Ze(e),0,!0))],Q.prototype,"tilt",void 0),c([p({type:Number,nonNullable:!0}),de()],Q.prototype,"width",void 0),c([p({type:Number,nonNullable:!0}),de()],Q.prototype,"height",void 0),Q=c([ce("esri.analysis.SlicePlane")],Q);const Be=Q,Ee=Zt("mac")?"Meta":"Control",Ce="Shift",ta=2,ia=1.15,aa=1.15,sa=1.1,na=2500,ra=.02,la=Math.cos(me(45)),yt=Math.cos(me(5)),oa=.95,ha=.3,da=.7,oe=F(1,.5,0),zt=2,Gt=1,ae=le([...oe,da]),se=[0,0,0,.04],Nt=le([...oe,.5]),ca=le([...oe,1]),ua=J(1,1,1,1),pa=J(1,.8,.6,1),ga=J(1,.93,.86,1),ya=le([...oe,1]),wa=le([...oe,1]),va=3,wt=11,fa=22.5,_e=40,vt=48,_a=2.25,ma=le([...oe,1]),Pa=4,ft=1,Da=.3,ba=6,Aa=4,_t=12,Ma=40,Va=27,mt=1600,Ta=.4;function Ea(e){const t=new ei;return t.extensions.add("GL_OES_standard_derivatives"),ti(t,e),t.attributes.add(ie.POSITION,"vec3"),t.attributes.add(ie.UV0,"vec2"),t.varyings.add("vUV","vec2"),t.vertex.code.add(et`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),t.fragment.uniforms.add([new tt("backgroundColor",i=>i.backgroundColor),new tt("gridColor",i=>i.gridColor),new ii("gridWidth",i=>i.gridWidth)]),t.fragment.code.add(et`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const Ca=Object.freeze(Object.defineProperty({__proto__:null,build:Ea},Symbol.toStringTag,{value:"Module"}));class ka extends ui{constructor(){super(...arguments),this.backgroundColor=J(1,0,0,.5),this.gridColor=J(0,1,0,.5),this.gridWidth=4}}class Ve extends ni{initializeProgram(t){const i=Ve.shader.get().build(this.configuration);return new ri(t.rctx,i,li)}initializePipeline(){return oi({blending:hi(ue.ONE,ue.ONE,ue.ONE_MINUS_SRC_ALPHA,ue.ONE_MINUS_SRC_ALPHA),depthTest:{func:di.LESS},colorWrite:ci})}}Ve.shader=new ai(Ca,()=>si(()=>import("./SlicePlaneMaterial.glsl.19643fde.js"),["SlicePlaneMaterial.glsl.19643fde.js","index.a8738f47.js","index.7b18f6ca.css","LineVisualElement.c8ac394d.js","persistable.6d7b5a7d.js","multiOriginJSONSupportUtils.8128aa52.js","BuildingComponentSublayer.ecd163b1.js","capabilities.64684acb.js","I3SIndexInfo.aa09632f.js","I3SLayerDefinitions.38b2ee60.js","projectionUtils.eb41893b.js","analysisViewUtils.1368068e.js","ImageMaterial.c05046f5.js","dragEventPipeline3D.dd7775a3.js"],import.meta.url));class Oa extends pi{constructor(t){super(t,new Ia),this._config=new gi}intersect(t,i,a,s,n,r,l){return yi(t,i,s,n,r,void 0,l)}createBufferWriter(){return new wi(vi)}requiresSlot(t){return t===fi.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(t){return t.output===_i.Color?new Sa(t):null}getConfiguration(){return this._config}}class Sa extends mi{constructor(t){super(t),this.ensureTechnique(Ve,null)}beginSlot(){return Tt(this.technique)}}class Ia extends ka{constructor(){super(...arguments),this.renderOccluded=C.Occlude}}class La extends Qi{constructor(t){super(t),this._material=null,this._renderOccluded=C.OccludeAndTransparent,this._gridWidth=1,this._gridColor=J(1,0,0,1),this._backgroundColor=J(1,0,0,1),this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){it(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){it(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new Oa(this.materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){h(this._material)&&t(this._material)}createGeometries(t){if(h(this._material)){const i=G.createSquareGeometry();t.addGeometry(i,this._material)}}get materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){h(this._material)&&this._material.setParameters(this.materialParameters)}}const $a=Et.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Ra(e,t,i,a,s,n,r,l){return xa(t,r.worldUpAtPosition(e,o.get()),s,n,l.basis1,l.basis2),f(l.basis1,l.basis1,i),f(l.basis2,l.basis2,a),H(l.origin,e),kt(l.basis2,l.basis1,l.origin,l.plane),l}function xa(e,t,i,a,s,n){const r=z(e,t),l=o.get(),u=o.get();switch(a===S.HORIZONTAL_OR_VERTICAL?Math.abs(r)>la?S.HORIZONTAL:S.VERTICAL:a){case S.VERTICAL:{const g=Math.abs(r)<=yt?e:i.viewUp;K(l,g,t),H(u,t);break}case S.HORIZONTAL:K(l,i.viewUp,t),K(u,t,l);break;case S.TILTED:{const g=Math.abs(r)<=yt?t:i.viewUp;K(l,g,e),K(u,e,l);break}}const w=K(o.get(),l,u);z(w,i.viewForward)>0&&f(u,u,-1),I(s,l),I(n,u)}function Ha(e,t,i){const a=t.worldUpAtPosition(e.origin,o.get()),s=e.basis1,n=Xe(e,a),r=Math.round(n/te)*te;return xe(e,r-n,s,i)}function za(e,t,i,a,s,n){const r=H(o.get(),s.origin);b(r,r,f(o.get(),s.basis1,e.direction[0]<0?1:-1)),b(r,r,f(o.get(),s.basis2,e.direction[1]<0?1:-1));const l=k(s.basis1),u=k(s.basis2),w=U(o.get(),i,r),g=U(o.get(),t,r);let d=0,D=0;if(qe(e)){const M=Ne(s),B=Ne(n);d=l-.5*e.direction[0]*z(s.basis1,g)/l,D=u-.5*e.direction[1]*z(s.basis2,g)/u;const X=B/M;d*=X,D*=X}const L=d+.5*e.direction[0]*z(s.basis1,w)/l,m=D+.5*e.direction[1]*z(s.basis2,w)/u,v=f(o.get(),s.basis1,L/l),_=f(o.get(),s.basis2,m/u);(L<=0||Dt(n.origin,v,a)<=mt)&&H(v,n.basis1),(m<=0||Dt(n.origin,_,a)<=mt)&&H(_,n.basis2);const A=H(o.get(),r);return b(A,A,f(o.get(),v,e.direction[0]<0?-1:1)),b(A,A,f(o.get(),_,e.direction[1]<0?-1:1)),Le(A,v,_,n)}function Ga(e,t){return Ta*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Na(e,t,i,a){const s=K(o.get(),t,i);return K(s,s,t),Ot(e,s,a)}function Ut(e,t){return qi(e.basis1,e.basis2,e.origin,t)}function Pt(e,t,i,a){const s=t.worldUpAtPosition(e.origin,o.get()),n=o.get();switch(i){case re.HEADING:H(n,s);break;case re.TILT:H(n,e.basis1)}return Ot(e.origin,n,a)}function Ua(e,t,i,a){const s=Ke(i,W.NEGATIVE_X),n=N.get();Pi(n,t,s.edge*Math.PI/2);const r=I(o.get(),s.basis);let l=f(o.get(),r,s.direction*a.computeScreenPixelSizeAt(s.position)*_e);b(l,l,s.position);const u=a.projectToRenderScreen(l,$e(o.get())),w=Qa(a,u);Di(a,u,ve),I(ve.direction,ve.direction);const g=o.get();!w&&bi(i,ve,g)&&(l=g),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=St(l),w?e.state|=be:e.state&=~be}function Qa(e,t){const[i,a,s,n]=e.viewport,r=Math.min(s,n)/16;let l=!0;return t[0]<i+r?(t[0]=i+r,l=!1):t[0]>i+s-r&&(t[0]=i+s-r,l=!1),t[1]<a+r?(t[1]=a+r,l=!1):t[1]>a+n-r&&(t[1]=a+n-r,l=!1),l}function ja(e,t,i,a){const s=k(a.basis1),n=k(a.basis2),r=Qt(a),l=Ne(a),u=ne(o.get(),0,0,0);b(u,f(o.get(),a.basis1,t.direction[0]),f(o.get(),a.basis2,t.direction[1])),b(u,a.origin,u);let w=0,g=1;if(qe(t))t.direction[0]===1&&t.direction[1]===-1?w=te:t.direction[0]===1&&t.direction[1]===1?w=Math.PI:t.direction[0]===-1&&t.direction[1]===1&&(w=3*Math.PI/2),g=l;else{const D=t.direction[0]!==0?1:2;w=D===1?te:0,g=(D===1?n:s)-r}const d=Qe(N.get(),w);It(d,d,ne(o.get(),g,g,g)),Z(d,i,d),d[12]=0,d[13]=0,d[14]=0,e.modelTransform=d,e.renderLocation=u}function Fa(e,t,i,a){const s=a.worldUpAtPosition(i.origin,o.get()),n=Ke(i,W.POSITIVE_X),r=Qe(N.get(),n.edge*Math.PI/2);Lt(r,r,-Xe(i,s)),Z(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=n.position}function Wa(e,t,i){const a=Ke(i,W.POSITIVE_Y),s=Qe(N.get(),a.edge*Math.PI/2);Lt(s,s,te),Z(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}var W;function Ke(e,t){switch(t){case W.POSITIVE_X:return{basis:e.basis1,direction:1,position:b(o.get(),e.origin,e.basis1),edge:t};case W.POSITIVE_Y:return{basis:e.basis2,direction:1,position:b(o.get(),e.origin,e.basis2),edge:t};case W.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:U(o.get(),e.origin,e.basis1),edge:t};case W.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:U(o.get(),e.origin,e.basis2),edge:t}}}function Dt(e,t,i){const a=i.projectToRenderScreen(b(o.get(),e,t),$e(o.get())),s=i.projectToRenderScreen(U(o.get(),e,t),$e(o.get()));return Ai(U(a,a,s))}function Qt(e){const t=k(e.basis1),i=k(e.basis2);return Da*Math.min(t,i)}function Ne(e){return Qt(e)}function qe(e){return e.direction[0]!==0&&e.direction[1]!==0}function Ba(e,t=Ae.CENTER_ON_ARROW){const i=t===Ae.CENTER_ON_CALLOUT?_e:0,a=[F(i,0,-vt/2),F(i,0,vt/2)],s=Ya(a,!0),n=(v,_)=>qa(a,a,{tubeRadius:va,tipRadius:wt,tipLength:fa,tubeFocusMultiplier:ia,tipFocusMultiplier:aa,padding:v,bothEnds:!0,flat:null,focusTipLength:!0,addCap:_}),r=n(0,!1),l=n(_a,!0),u=new pe({color:ua,cullFace:ge.Back,renderOccluded:C.Opaque}),w=new pe({color:pa,cullFace:ge.Back,renderOccluded:C.Opaque}),g=new pe({color:ga,cullFace:ge.Back,renderOccluded:C.Opaque}),d=new pe({color:wa,transparent:!0,writeDepth:!1,cullFace:ge.Front,renderOccluded:C.Transparent}),D=G.createPolylineGeometry([[i,0,0],[i-_e,0,0]]),L=G.createPolylineGeometry([[i,0,0],[i-_e,0,0]]),m=new je({color:ya,renderOccluded:C.OccludeAndTransparent});return new We({view:e,renderObjects:[...r.normal.map(({part:v,geometry:_,transform:A})=>({geometry:_,material:v==="tip"?u:v==="cap"?w:g,transform:A,stateMask:O.Unfocused|P})),...l.normal.map(({geometry:v,transform:_})=>({geometry:v,material:d,transform:_,stateMask:O.Unfocused|P})),{geometry:D,material:m,stateMask:O.Unfocused|P|be},...r.focused.map(({part:v,geometry:_,transform:A})=>({geometry:_,material:v==="tip"?u:v==="cap"?w:g,transform:A,stateMask:O.Focused|P})),...l.focused.map(({geometry:v,transform:_})=>({geometry:v,material:d,transform:_,stateMask:O.Focused|P})),{geometry:L,material:m,stateMask:O.Focused|P|be}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:wt,state:P})}function bt(e,t){const i=new ea({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:C.Opaque}),a=Ma,s=Va,n=s*sa,r=d=>{const D=new Uint32Array([0,1,2,2,3,0]);return new Vi([[ie.POSITION,{size:3,data:[a-d,-d,0,a+d,-d,0,a+d,d,0,a-d,d,0],exclusive:!0}],[ie.UV0,{size:2,data:[0,0,1,0,1,1,0,1]}]],[[ie.POSITION,D],[ie.UV0,D]])},l=G.createPolylineGeometry([[0,0,0],[a-s,0,0]]),u=G.createPolylineGeometry([[0,0,0],[a-n,0,0]]),w=new je({color:ca,renderOccluded:C.OccludeAndTransparent}),g=[{geometry:r(s),material:i,stateMask:O.Unfocused|P},{geometry:l,material:w,stateMask:O.Unfocused|P},{geometry:r(n),material:i,stateMask:O.Focused|P},{geometry:u,material:w,stateMask:O.Focused|P}];return new We({view:e,renderObjects:g,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},collisionPriority:1,radius:s/2,state:P})}function jt(e){const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new ji({view:e,attached:!0,color:ae,width:Gt,writeDepthEnabled:!1,renderOccluded:C.OccludeAndTransparent,geometry:[t]})}function Ft(e){return new La({view:e,attached:!0,backgroundColor:[...se],gridColor:Nt,gridWidth:4,renderOccluded:C.OccludeAndTransparent})}function Ka(e,t){const i=qe(t),a=i?[F(1,0,0),F(0,0,0),F(0,1,0)]:[F(1,0,0),F(-1,0,0)],s=G.createPolylineGeometry(a),n=ma,r=m=>new Ei({color:n,width:m,renderOccluded:C.OccludeAndTransparent}),l=()=>new je({color:n,renderOccluded:C.OccludeAndTransparent}),u=i?Pa:ft,w=u*ta,g=ft,d=m=>m>1?r(m):l(),D=[{geometry:s,material:d(u),stateMask:O.Unfocused|ke},{geometry:s,material:d(w),stateMask:O.Focused|ke},{geometry:s,material:d(g),stateMask:is}],L=new We({view:e,renderObjects:D,collisionType:{type:"line",paths:[a]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?ba:Aa});return L.state=ke,L}function qa(e,t,i){const a=s=>{const n=(s?t:e).slice(0),r=U(o.get(),n[0],n[1]);I(r,r);const l=U(o.get(),n[n.length-1],n[n.length-2]);if(I(l,l),i.padding>0){const M=f(ee(),l,-i.padding);if(n[n.length-1]=b(M,M,n[n.length-1]),i.bothEnds){const B=f(ee(),r,-i.padding);n[0]=b(B,B,n[0])}}const u=s?i.tipFocusMultiplier:1,w=i.tipLength*(i.focusTipLength?u:1),g=i.tipRadius*u,d=st(N.get());if(i.padding>0){const M=w/4,B=ne(o.get(),0,M,0),X=1+i.padding/M;nt(d,d,B),It(d,d,ne(o.get(),X,X,X)),nt(d,d,f(B,B,-1/X))}const D=st(Te()),L=F(0,1,0),m=rt(Te(),lt(ot.get(),L,l));m[12]=n[n.length-1][0],m[13]=n[n.length-1][1],m[14]=n[n.length-1][2],Z(m,m,d);const v=[{part:"tube",geometry:Xa(i.tubeRadius*(s?i.tubeFocusMultiplier:1)+i.padding,i.flat,n),transform:D}];let _,A;if(h(i.flat)?_=G.createExtrudedTriangle(w,g,g,i.flat.thickness):(_=G.createConeGeometry(w,g,24,!1,!1,!0),A=G.createConeGeometry(w,g,24,!1,!0,!1)),v.push({part:"tip",geometry:_,transform:m}),A&&v.push({part:"cap",geometry:A,transform:m}),i.bothEnds){const M=rt(Te(),lt(ot.get(),L,r));M[12]=n[0][0],M[13]=n[0][1],M[14]=n[0][2],Z(M,M,d),v.push({part:"tip",geometry:_,transform:M}),A&&v.push({part:"cap",geometry:A,transform:M})}return v};return{normal:a(!1),focused:a(!0)}}function Xa(e,t,i){const a=[];if(h(t))a.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else for(let n=0;n<12;n++){const r=n/12*2*Math.PI;a.push([Math.cos(r)*e,Math.sin(r)*e])}return G.createPathExtrusionGeometry(a,i,[],[],!1)}function Ya(e,t){const i=U(ee(),e[e.length-1],e[e.length-2]);if(I(i,i),f(i,i,_t),b(i,i,e[e.length-1]),t){const a=U(ee(),e[0],e[1]);return I(a,a),f(a,a,_t),b(a,a,e[0]),[a,...e,i]}return[...e,i]}function Wt(e,t,i,a=new Be){if(y(e))return null;const{renderCoordsHelper:s}=t,n=s.fromRenderCoords(e.origin,t.spatialReference);if(y(n))return null;const r=Mi(n,i);if(y(r))return null;a.position=r;const l=s.worldUpAtPosition(e.origin,o.get()),u=s.worldBasisAtPosition(e.origin,Re.Y,o.get()),w=2*k(e.basis1),g=2*k(e.basis2),d=$t.renderUnitScaleFactor(t.spatialReference,i);return a.width=w*d,a.height=g*d,a.tilt=at(Xe(e,l)),a.heading=at(Ja(e,l,u)),a}function Xe(e,t){return Rt(t,e.basis2,e.basis1)+te}function Ja(e,t,i){return Rt(e.basis1,i,t)-te}function Za(e,t,i,a,s,n,r=E()){return n.toRenderCoords(e,r.origin)?(n.worldBasisAtPosition(r.origin,Re.X,r.basis1),n.worldBasisAtPosition(r.origin,Re.Y,r.basis2),kt(r.basis2,r.basis1,r.origin,r.plane),xe(r,-me(t),Pe(r),r),xe(r,me(i),r.basis1,r),f(r.basis1,r.basis1,a/2),f(r.basis2,r.basis2,s/2),Ti(r),r):($a.error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function es(e,t){if(y(e)||y(e.position))return null;const i=Bi(e.position,t.spatialReference,t.elevationProvider);if(y(i))return null;const a=$t.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*a,n=e.height*a;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:n}}function ts(e,t,i,a=E()){if(y(e))return null;const s=Za(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,a);return!i.tiltEnabled&&h(s)&&Ha(s,t.renderCoordsHelper,s),s}(function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"})(W||(W={}));const P=Me.Custom1;var re,S;(function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"})(re||(re={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(S||(S={}));const be=Me.Custom2,ve=Ct(),te=Math.PI/2,ke=Me.Custom1,is=Me.Custom2;var Ae;function as(e){const t=e.type==="building-scene-3d"?e:null;return h(t)}(function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Ae||(Ae={}));const Oe=Et.getLogger("esri.views.3d.analysis.Slice.SliceController");let j=class extends Fe{constructor(e){super(e),this._handles=new De,this._internalChange=!1,this._currentSlicePlane=null,this.state="ready"}get ready(){return this.state==="ready"}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const t=e.item;t!=null&&(t instanceof ht||t instanceof Wi)?t instanceof ht&&Ci(t)?(Oe.error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(Oe.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),ns(this.view,this),this._handles.add([x(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),x(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),x(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),x(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([x(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.state!=="destroyed"&&(this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),rs(this.view,this),this._handles.destroy(),this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await He(()=>this.ready),this}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(as).flatMap(({sublayerViews:t})=>t.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(y(t)&&y(e)||h(t)&&h(e)&&e.equals(t))return;let i=null,a=null;if(h(e)&&h(e.position)){const s=e.position.spatialReference,n=es(e,this.view);y(n)&&Ki(this.analysis,s,Oe),i=ts(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},E()),h(i)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=Wt(e,this.view,this.view.spatialReference,new Be);let i=null;h(t)&&(i={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(Se)return;const e=Bt(this.view);if(this.analysisViewData.active)h(e.activeController)&&e.activeController!==this?(Se=!0,e.activeController.analysisViewData.active=!1,Se=!1):h(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(h(e.activeController)&&e.activeController!==this)return;h(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){this.state==="ready"&&ss(this.view)}_updateLayerViews(){const e=h(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};c([p({readOnly:!0})],j.prototype,"state",void 0),c([p()],j.prototype,"view",void 0),c([p()],j.prototype,"analysis",void 0),c([p()],j.prototype,"analysisViewData",void 0),c([p()],j.prototype,"ready",null),c([p()],j.prototype,"_allLayerAndSubLayerViews",null),j=c([ce("esri.views.3d.analysis.Slice.SliceController")],j);const Y=new Map;let Se=!1;function ss(e){const t=Bt(e).activeController;h(t)&&h(t.analysisViewData.plane)&&t.analysisViewData.visible?e.slicePlane=t.analysisViewData.plane:e.slicePlane=null}function ns(e,t){Y.has(e)||Y.set(e,{all:[],activeController:null}),Y.get(e).all.push(t)}function Bt(e){return Y.get(e)}function rs(e,t){if(!Y.has(e))throw new Error("view expected in global slice register");const i=Y.get(e),a=i.all.lastIndexOf(t);if(a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&Y.delete(e)}const At="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAnFBMVEUAAAD/gAD/gAD/cAD/gAD/eAD/gAD/eQD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fAD/gAD/fAD/fQD/fQD/fQD/fQD/fQD/fgD/jR7/mjn/mjf/p1H/plH/smf/sWb/vHr/u3n/xYz/xIv/zZz/zJv/zJr/1Kv/1Kr/06r/06n/27n/27f/4cX/4cT/59D/7dr/8uX/9u7/+/f////u2EN0AAAAM3RSTlMACBAQICAoKDAwODhAQEhIUFBYYGhweICIkJCXmJ+gp6ivsLe4uL+/wMDHx8/P19/n7/cWvjXwAAACeUlEQVR42tWX3XqiMBCGY2pbtbrUnzhhdak/lHWliJD7v7fdJ+KG5AMhh30P8zCTmS+TycDaeBoHi5Wgf4jVYvbKmRfPgSAHMX9mPRnM1tSIGHM/c2QddLp4c8wxCvYIvqROBPfbHlm/sRYC6smMNTKn3sxZAyvyYNW1v38MM/IkcPQnZHPMLtciz9P9hhqwzoLD+cnfpTIUaYinyZlBkE2YKZcMXCyN/YhsPkuFlMfWJLiwo89VMxfpJDForMCwuG+Zx7ttGO2S/w4LJ42ZURDty5M0a4dqsZAQAihQfXqWdlhnpcmdEPAI0tv2EbnsbsKmdgi6/1GN7T1XJLx5sF0P9SWABMC+co5JBE4Ge/1NTM3EGIJgjFONXCdAbeQYwhN7pRrRV20LJNIhWOczdu+xPFzIBiQ62iIsyIOTvlZUY+HXySLQaMUEeSC1CPYxENIlwk+q8e0clFAIfiKG+qpaIvod4wfU8sqvkDLda+xCCqgDaAk7uyeNqD+feFlfGCcg3Hzsk+xS7Nz1Aq4CcauhhMc0uxaqIgcFsF0J+1WQyoCN7Y9ezeCVH5LhSxmyRvsihKbK1m7LafpSpkpj6yJgtsiVBh6AX5UyCVmMbrNpcwj5/h6DPN79JjAiQAhXVeN6SZI0q5bQnn4wBiHEqpUybp1ZJzWxStVCHhKhAhVLp/Emh6trHpGLaB6yZHk7wu3Z+ChOxhwUNEmYYjpUvqJDksSHraQmJm2DdqQK6sGUObybYtpSN+8Phm3pN2xjDH33R6b0CKxAZNLvl8foD3BBnSw5e8RI+G2P8GD9wHw6YN3wkfA0R4Zz8CGCIfOCv8zM738walXuLw6nXBvPr8wvAAAAAElFTkSuQmCC",Mt="data:image/png;base64,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",Kt={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};function ls(e){return e.fromData(At,()=>new xt(At,Kt))}function os(e){return e.fromData(Mt,()=>new xt(Mt,Kt))}var Ue;let V=Ue=class extends Xi{constructor(e){super(e),this.clock=ki,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._handles=new De,this._viewHandles=new De,this._frameTask=null,this._pointerMoveTimerMs=na,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=E(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Oi(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=Si(e.view.state.viewingMode),this._intersector.options.store=Ii.MIN}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.rotateHeadingImage=ls(this.view.toolViewManager.textures),this.rotateTiltImage=os(this.view.toolViewManager.textures);const e=i=>{this._updateManipulatorsInteractive(i),i.grabbing||(h(this.analysisViewData.plane)&&T(this.analysisViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=Ba(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",i=>{this._onShiftGrab(i),e(this.shiftManipulator)}),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=bt(this.view,this.rotateHeadingImage.texture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",i=>{this._onRotateHeadingGrab(i),e(this.rotateHeadingManipulator)}),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=bt(this.view,this.rotateTiltImage.texture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",i=>{this._onRotateTiltGrab(i),e(this.rotateTiltManipulator)}),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((i,a)=>{const s=Ka(this.view,i);return s.events.on("grab-changed",n=>{this._onResizeGrab(n,a),e(s)}),this._handles.add(this._createResizeDragPipeline(s)),s}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Ft(this.view),this._previewPlaneOutlineVisualElement=jt(this.view),this._previewPlaneOutlineVisualElement.width=zt,this._handles.add(x(()=>this.analysisViewData.plane,()=>this._updateManipulators(),Li));const t=x(()=>this.state,i=>{i==="sliced"&&this.finishToolCreation()},ze);this._handles.add([t,x(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this.rotateHeadingImage=dt(this.rotateHeadingImage),this.rotateTiltImage=dt(this.rotateTiltImage),this._handles=q(this._handles),this._viewHandles=q(this._viewHandles),this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=q(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=q(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":h(this._creatingPointerId)?"grabbing":null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._handles.remove("analysis"),this._set("analysis",e)}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=h(e)&&e.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return h(this.inputState)&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){y(this.analysisViewData.plane)||(this._set("layersMode","exclude"),this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){y(this.analysisViewData.plane)||(this._set("layersMode","none"),this.active&&(this.view.activeTool=null))}onDeactivate(){this._set("layersMode","none"),this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this.shiftManipulator&&(this._updateManipulators(),e||this._clearPointerMoveTimeout())}onInputEvent(e){switch(e.type){case"pointer-drag":if(!Ie(e))return;this._isPlacingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!Ie(e))return;this._onClickPlacePlane(e)&&e.stopPropagation();break;case"click":if(!Ie(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.editable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&h(t)&&t.type==="shift"){const i=he(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(he(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&h(this.analysisViewData.plane)){const t=he(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),T(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const t=he(e),i=E();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(T(i,this._startPlane),this.analysis.shape=Wt(i,this.view,this.view.spatialReference,new Be),e.type==="pointer-drag"){const a=this._calculatePickRay(t);this.inputState=Vt(a,e.pointerId,i.origin,i)}return!0}}return!1}_onClickExcludeLayer(e){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(he(e)).then(t=>{if(t.results.length){const i=t.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0}),this._set("layersMode","none"),this.active&&(this.view.activeTool=null),!0)}_onKeyDown(e){return(e.key===Ce||e.key===Ee)&&(this._activeKeyModifiers[e.key]=!0,h(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==Ce&&e.key!==Ee||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],h(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||y(this.analysisViewData.plane))return;const t=this._calculatePickRay(e.screenPoint);T(this.analysisViewData.plane,this._startPlane),this.inputState=Vt(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="shift")return;const n=h(this.analysisViewData.plane)?T(this.analysisViewData.plane,E()):null;i.next(we(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{h(n)&&this._updateBoundedPlane(n)})})}_shiftDragAdjustSensitivity(e){return t=>{if(y(this.analysisViewData.plane))return null;const i=.001,a=Math.min((1-Math.abs(z(Pe(this.analysisViewData.plane),t.ray.direction)/k(t.ray.direction)))/i,1),s=-ct(this._startPlane.plane,t.renderEnd),n=-ct(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-n,t}}_shiftDragUpdatePlane(e){return()=>{if(y(this.analysisViewData.plane))return;const t=H(o.get(),this._startPlane.origin),i=H(o.get(),Pe(this._startPlane));f(i,i,-e.depth),b(i,i,t);const a=Le(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,E());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||y(this.analysisViewData.plane))return;const t=Pt(this.analysisViewData.plane,this.view.renderCoordsHelper,re.HEADING,Ge()),i=this._calculatePickRay(e.screenPoint),a=ee();fe(t,i,a)&&(T(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="rotate")return;const n=h(this.analysisViewData.plane)?T(this.analysisViewData.plane,E()):null;i.next(we(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{h(n)&&this._updateBoundedPlane(n)})})}_onRotateTiltGrab(e){if(e.action!=="start"||y(this.analysisViewData.plane))return;const t=Pt(this.analysisViewData.plane,this.view.renderCoordsHelper,re.TILT,Ge()),i=this._calculatePickRay(e.screenPoint),a=ee();fe(t,i,a)&&(T(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="rotate")return;const n=h(this.analysisViewData.plane)?T(this.analysisViewData.plane,E()):null;i.next(we(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{h(n)&&this._updateBoundedPlane(n)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(y(this.analysisViewData.plane))return null;const i=$i(e.rotatePlane),a=Yi(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(y(this.analysisViewData.plane))return;const t=Ri(N.get(),e.rotateAngle,e.rotateAxis);if(y(t))return;const i=ut(o.get(),this._startPlane.basis1,t),a=ut(o.get(),this._startPlane.basis2,t),s=Le(this.analysisViewData.plane.origin,i,a,E());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||y(this.analysisViewData.plane))return;const i=this._calculatePickRay(e.screenPoint),a=o.get();fe(this.analysisViewData.plane.plane,i,a)&&(T(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:St(a)})}_createResizeDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="resize"||y(this.analysisViewData.plane))return;const n=T(this.analysisViewData.plane,E());i.next(we(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(n)})})}_resizeDragUpdatePlane(e){return t=>{if(y(this.analysisViewData.plane))return;const i=this._resizeHandles[e.activeHandleIdx],a=za(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,T(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(!h(t))throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,y(e))return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=h(i)?i:E();if(i=h(i)?T(i,hs):null,this._pickPlane(e,!0,t,a)){const s=oa;let n=!1;h(i)&&(n=z(i.plane,a.plane)<s||z(I(o.get(),i.basis1),I(o.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}h(this._previewPlane)&&y(this._frameTask)&&this._previewPlaneOpacity===0?this._frameTask=xi({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*ha),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):y(this._previewPlane)&&h(this._frameTask)?this._removeFrameTask():h(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){this._frameTask=pt(this._frameTask)}_calculatePickRay(e){const t=Ct(),i=gt(e,ds);return Hi(this.view.state.camera,i,t),I(t.direction,t.direction),t}_pickMinResult(e){const t=gt(e,zi.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),n=o.get();if(!s.getIntersectionPoint(n))return!1;const r=s.getTransformedNormal(o.get()),l=this.view.state.camera;z(r,l.viewForward)>0&&f(r,r,-1);const u=Ga(n,l),w=(t?1:-1)*u*ra,g=f(o.get(),r,w);b(g,g,n);const d=this.analysis.tiltEnabled?S.TILTED:S.HORIZONTAL_OR_VERTICAL,D=i[Ce]?S.VERTICAL:i[Ee]?S.HORIZONTAL:d;return Ra(g,r,u,u,l,D,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=pt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=P,this.rotateHeadingManipulator.state|=P,this.rotateTiltManipulator.state|=P,this._prevPointerMoveTimeout=this.clock.setTimeout(()=>{this.shiftManipulator.state&=~P,this.rotateHeadingManipulator.state&=~P,this.rotateTiltManipulator.state&=~P},this._pointerMoveTimerMs)}_updateManipulators(){if(Ue.disableEngineLayers)return;let e=null,t=!1;if(h(this.analysisViewData.plane))e=this.analysisViewData.plane,t=!1;else{if(!h(this._previewPlane))return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);e=this._previewPlane,t=!0}const i=Ut(e,N.get());t?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(r=>r.available=!0),Ua(this.shiftManipulator,i,e,this.view.state.camera),Fa(this.rotateHeadingManipulator,i,e,this.view.renderCoordsHelper),Wa(this.rotateTiltManipulator,i,e),this.resizeManipulators.forEach((r,l)=>ja(r,this._resizeHandles[l],i,e)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=ne(o.get(),k(e.basis1),k(e.basis2),1),s=Ht(N.get(),a),n=Z(s,i,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n,this._updateMaterials()}_updateMaterials(){const e=[ae[0],ae[1],ae[2],ae[3]*this._previewPlaneOpacity];this._previewPlaneOutlineVisualElement.color=e;const t=[se[0],se[1],se[2],se[3]*this._previewPlaneOpacity],i=[0,0,0,0];this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=i}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function Vt(e,t,i,a){const s=Na(i,Pe(a),e.direction,Ge()),n=ee();return fe(s,e,n)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function Ie(e){return e.pointerType!=="mouse"||e.button===0}V.disableEngineLayers=!1,c([p()],V.prototype,"clock",void 0),c([p({constructOnly:!0})],V.prototype,"view",void 0),c([p()],V.prototype,"analysisViewData",void 0),c([p({readOnly:!0})],V.prototype,"state",null),c([p({readOnly:!0})],V.prototype,"cursor",null),c([p()],V.prototype,"analysis",null),c([p()],V.prototype,"removeIncompleteOnCancel",void 0),c([p({readOnly:!0})],V.prototype,"layersMode",void 0),c([p({value:null})],V.prototype,"inputState",null),c([p()],V.prototype,"_isPlacingSlicePlane",null),c([p()],V.prototype,"_creatingPointerId",null),V=Ue=c([ce("esri.views.3d.analysis.Slice.SliceTool")],V);const hs=E(),ds=Gi(),cs=V;let $=class extends Fe{constructor(e){super(e),this._handles=new De,this._gridVisualElement=null,this._outlineVisualElement=null,this.state="pending",this.showGrid=!1,this.preview=!0}get ready(){return this.state==="ready"}initialize(){this._initialize()}async _initialize(){if(this.state==="destroyed"||this.state==="ready")return;await He(()=>this.view.ready);const e=this.analysisViewData;if(y(e))throw new Error("expected internal object to be valid");this._gridVisualElement=Ft(this.view),this._outlineVisualElement=jt(this.view),this._handles.add([x(()=>({visible:h(e.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,preview:this.preview,showGrid:this.showGrid}),t=>this._updateMaterials(t),ze),x(()=>e.plane,t=>this._updatePlane(t),ze)],"internal"),this._set("state","ready")}destroy(){this.state!=="destroyed"&&this.state!=="pending"&&(this._handles.destroy(),this._gridVisualElement=q(this._gridVisualElement),this._outlineVisualElement=q(this._outlineVisualElement),this.set("view",null),this._set("state","destroyed"))}async whenReady(){await He(()=>this.view.ready)}_updatePlane(e){if(y(e))return;const t=ne(o.get(),k(e.basis1),k(e.basis2),1),i=Ht(N.get(),t),a=Ut(e,N.get()),s=Z(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a}){this._outlineVisualElement.color=ae,this._outlineVisualElement.width=i?zt:Gt,this._outlineVisualElement.stipplePattern=t?null:Ni(5),this._gridVisualElement.backgroundColor=se,this._gridVisualElement.gridColor=a?Nt:Ui,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};c([p({readOnly:!0})],$.prototype,"state",void 0),c([p()],$.prototype,"view",void 0),c([p()],$.prototype,"analysis",void 0),c([p()],$.prototype,"analysisViewData",void 0),c([p()],$.prototype,"ready",null),c([p()],$.prototype,"showGrid",void 0),c([p()],$.prototype,"preview",void 0),$=c([ce("esri.views.3d.analysis.Slice.SliceVisualization")],$);let R=class extends Fi(Fe){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0,this.showGrid=!1}initialize(){this.analysisVisualization=new $({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new j({view:this.view,analysis:this.analysis,analysisViewData:this}),this.own(Ji(this,cs))}destroy(){Zi(this),this.analysisVisualization=q(this.analysisVisualization),this.analysisController=q(this.analysisController)}get editable(){return!this.analysisVisualization.preview}set editable(e){this.analysisVisualization.preview=!e}async when(){return await this.analysisVisualization.whenReady(),await this.analysisController.whenReady(),this}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:Tt(this.tool)}}};c([p({readOnly:!0})],R.prototype,"type",void 0),c([p({constructOnly:!0,nonNullable:!0})],R.prototype,"analysis",void 0),c([p()],R.prototype,"tool",void 0),c([p()],R.prototype,"plane",void 0),c([p()],R.prototype,"active",void 0),c([p({aliasOf:"analysisVisualization.showGrid"})],R.prototype,"showGrid",void 0),c([p()],R.prototype,"editable",null),R=c([ce("esri.views.3d.analysis.SliceAnalysisView3D")],R);const us=R,Ps=Object.freeze(Object.defineProperty({__proto__:null,default:us},Symbol.toStringTag,{value:"Module"}));export{Ps as S,Ea as t};
