import{e as r,d as n,n as V,y as Q,E as G,am as A,ei as S,r as o,h9 as j,a8 as P,u as N,ay as v,aw as T,aE as y,h7 as M,aF as w,t as m,cR as $,w as H,i as L,k as J,p as D,q as F,f as p,ha as I,D as g,g as O,z as U,A as k,x as f,h as x,hb as z,av as B,aX as Y,fH as Z,c0 as X,I as K,J as W}from"./index.a8738f47.js";import{b as ee,j as te}from"./Graphics3DScaleVisibility.8fa6127f.js";import{d as ie,l as se,s as re}from"./Graphics3DObjectStates.2d298d9b.js";import{o as ne}from"./floorFilterUtils.69500d62.js";import{Y as ae}from"./QueryEngine.dd064fa9.js";import{n as R}from"./attributeUtils.99d8ee08.js";const le=ae;let h=class extends Q{constructor(e){super(e),this._dataQueryEngineInstance=null}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new G({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this._ensureDataQueryEngine()}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t))}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:A.fromJSON(s)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),s=S.fromJSON(i);return s.features.forEach(l=>{l.layer=this.layer,l.sourceLayer=this.layer}),s}async executeQuery(e,t){const i=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),s=S.fromJSON(i);return s.features.forEach(l=>{l.layer=this.layer,l.sourceLayer=this.layer}),s}_ensureQueryJSON(e,t){let i=this.defaultQueryJSON;return o(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),i=e.toJSON()),o(t)&&(i={...i,sceneFilter:{...t,geometry:t.geometry.toJSON()}}),i}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,i=j.toJSON(this.queryGeometryType),s=this.layer.fields.map(q=>q.toJSON()),l=this.layerView.view.resourceController.scheduler,u=this.priority,c=this.spatialReference.toJSON(),b=this.layerView.processor.featureStore,{hasZ:E,hasM:_}=this.layerView;return this._dataQueryEngineInstance=new le({hasZ:E,hasM:_,geometryType:i,fields:s,timeInfo:e,spatialReference:c,objectIdField:t,featureStore:b,scheduler:l,priority:u}),this._dataQueryEngineInstance}};r([n({constructOnly:!0})],h.prototype,"layerView",void 0),r([n({constructOnly:!0})],h.prototype,"priority",void 0),r([n({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],h.prototype,"spatialReference",void 0),r([n({readOnly:!0,aliasOf:"layerView.layer"})],h.prototype,"layer",void 0),r([n({readOnly:!0})],h.prototype,"queryGeometryType",null),r([n({readOnly:!0})],h.prototype,"defaultQueryJSON",null),h=r([V("esri.views.3d.layers.graphics.QueryEngine")],h);const oe=P.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let d=class extends Q{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new N}get updating(){return this._dirty||this._querying||o(this._queryResult)}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new h({layerView:this._layerView,priority:v.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(v.FILTER_VISIBILITY,this)),this._handles.add(T(()=>{var s;return(s=t.owner)==null?void 0:s.loadedGraphics},"after-changes",s=>this._graphicsChanged(s),{onListenerAdd:()=>this.dirty=!0})),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(e=>e.clearVisibilityFlag(y.FILTER)),this._queryResult=null,this._querying=!1),this.dirty=!1}_graphicsChanged(e){this._queryEngine&&(e.type&M.ADD)==0||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(y.FILTER,w.GRAPHIC)||e.setVisibilityFlag(y.FILTER,!1,w.GRAPHIC),this.dirty=!0)}filterChanged(){const e=this._recomputeFilter();e!==this._featureFilter&&(this._featureFilter=e,this.dirty=!0);const t="layerFilter"in this._layerView?this._layerView.layerFilter:null;t!==this._sceneFilter&&(this._sceneFilter=t,this.dirty=!0)}get active(){return(this._featureFilter||this._sceneFilter)&&this._core.graphics3DGraphics.size>0}_recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=ne(this._layerView);if(m(t)&&m(i))return e;const s=o(e)?e.clone():new $;if(o(t)&&(s.timeExtent=o(s.timeExtent)?s.timeExtent.intersection(t):t),o(i)){const l=s.where==null||s.where==="";s.where=l?i:`(${s.where}) AND (${i})`}return s}get running(){return this._dirty&&!this._querying||o(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._featureFilter,this._sceneFilter).then(i=>{this._queryResult=i,this._querying=!1}).catch(i=>{if(!H(i)){oe.warn("FeatureFilter query failed: "+i,{error:i});const s=new Set;this._core.graphics3DGraphics.forEach(l=>s.add(this._getFeatureId(l.graphic))),this._queryResult=s,this._querying=!1}}),e.madeProgress());const t=this._queryResult;o(t)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities(i=>{if(e.done)return!1;const s=t.has(this._getFeatureId(i.graphic));return!!i.setVisibilityFlag(y.FILTER,s,w.GRAPHIC)&&(e.madeProgress(),!0)}),e.done||(this._queryResult=null))}_getFeatureId(e){return e.objectId==null?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e}};r([n({readOnly:!0})],d.prototype,"updating",null),r([n({readOnly:!0})],d.prototype,"running",null),r([n()],d.prototype,"_dirty",void 0),r([n()],d.prototype,"_querying",void 0),r([n()],d.prototype,"_queryResult",void 0),d=r([V("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],d);let a=class extends L{constructor(e){super(e),this.type="graphics-3d",this.elevationFeatureExpressionEnabled=!1,this.dataExtent=null,this.drapeSourceType=J.Features,this.preferredUpdatePolicy=D.ASYNC,this.suspendResumeExtent=null}normalizeCtorArgs(e){const t=e.frustumVisibilityEnabled?new ie:null,i=e.scaleVisibilityEnabled?new ee:null,s=(e.filterVisibilityEnabled||e.timeExtentEnabled)&&e.owner.layer.geometryType!=="multipatch"?new d:null,l=e.elevationAlignmentEnabled?new se:null,{owner:u,updateClippingExtent:c,dataExtent:b,elevationFeatureExpressionEnabled:E,preferredUpdatePolicy:_}=e;return{owner:u,updateClippingExtent:c,dataExtent:b,frustumVisibility:t,scaleVisibility:i,filterVisibility:s,elevationAlignment:l,elevationFeatureExpressionEnabled:E,preferredUpdatePolicy:_}}initialize(){const e=new te({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:this.owner.hasZ,hasM:this.owner.hasM});this._set("graphicsCore",e),this.scaleVisibility&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.scaleVisibility.layerMinMaxScaleChangeHandler());const t=this.filterVisibility;o(t)&&(this.updatingHandles.add(()=>"filter"in this.owner&&this.owner.filter,()=>t.filterChanged()),this.updatingHandles.add(()=>"timeExtent"in this.owner&&this.owner.timeExtent,()=>t.filterChanged()),this.updatingHandles.add(()=>"layerFilter"in this.owner&&this.owner.layerFilter,()=>t.filterChanged())),this.elevationAlignment&&this.updatingHandles.add(()=>this.layer.elevationInfo,(i,s)=>{F(i,s)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this.updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this.updatingHandles.add(()=>this.layer.labelingInfo,(i,s)=>{F(i,s)&&this.graphicsCore.updateLabelingInfo()}),this.updatingHandles.add(()=>this.preferredUpdatePolicy,i=>this.graphicsCore.preferredUpdatePolicy=i)}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",p(this.frustumVisibility)),this._set("scaleVisibility",p(this.scaleVisibility)),this._set("filterVisibility",p(this.filterVisibility)),this._set("elevationAlignment",p(this.elevationAlignment)),this._set("objectStates",p(this.objectStates)),this._set("graphicsCore",p(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){var e;return(e=this.scaleVisibility)==null?void 0:e.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return m(this.frustumVisibility)||!this.frustumVisibility.suspended}get suspendInfo(){var t;const e={};return(t=this.scaleVisibility)!=null&&t.suspended&&(e.outsideScaleRange=!0),o(this.frustumVisibility)&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){var e,t;return!!(((e=this.graphicsCore)==null?void 0:e.updating)||o(this.frustumVisibility)&&this.frustumVisibility.updating||((t=this.updatingHandles)==null?void 0:t.updating))}get updatingRemaining(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.updatingRemaining)!=null?t:0}get featureStore(){var e;return(e=this.graphicsCore)==null?void 0:e.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var e;return(e=this.owner)==null?void 0:e.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphicsByObjectID}get symbolUpdateType(){var e;return(e=this.graphicsCore)==null?void 0:e.symbolUpdateType}get displayFeatureLimit(){var u;const e=this.view.resourceController.memoryController.memoryFactor,t=(u=this.graphicsCore)==null?void 0:u.displayFeatureLimit;if(e===1)return t;const i=Math.ceil(t.maximumNumberOfFeatures*e),s=Math.ceil(t.maximumTotalNumberOfFeatures*e),l=Math.ceil(t.minimumTotalNumberOfFeatures*e);return{...t,maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:l}}get usedMemory(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.usedMemory)!=null?t:0}get usedMemoryPerFeature(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.usedMemoryPerGraphic)!=null?t:0}get unprocessedMemoryEstimate(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.unprocessedMemoryEstimate)!=null?t:0}get performanceInfo(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:m(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibility.suspended}}async setup(){o(this.frustumVisibility)&&this.frustumVisibility.setup(this);const e=this.owner,t=this.owner.view.basemapTerrain,i=(s,l,u)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(s,l,u);if(this.scaleVisibility&&this.scaleVisibility.setup(this,this.layer,i,this.graphicsCore,t),o(this.filterVisibility)&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const s=e.view.elevationProvider;this.elevationAlignment.setup(this,i,this.graphicsCore,s)}this._set("objectStates",new re(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await I(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.updatingHandles.add(()=>this.layer.renderer,s=>this.updatingHandles.addPromise(this.graphicsCore.rendererChange(s))),this.updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add(()=>e.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await I(this.graphicsCore.updateLabelingInfo())}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(g.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,t){if(e instanceof G){const{set:i,handle:s}=this.objectStates.acquireSet(g.Highlight,t);return this.owner.queryObjectIds(e).then(l=>this.objectStates.setObjectIds(i,l)),s}if(typeof e=="number"||typeof e=="string")return this.highlight([e],t);if(e instanceof O)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof O){const i=e;if(R(this.layer.fieldsIndex,i[0].attributes,t)==null){const s=i.map(c=>c.uid),{set:l,handle:u}=this.objectStates.acquireSet(g.Highlight,null);return this.objectStates.setUids(l,s),u}e=i.map(s=>R(this.layer.fieldsIndex,s.attributes,t))}if(typeof e[0]=="number"||typeof e[0]=="string"){const i=e,{set:s,handle:l}=this.objectStates.acquireSet(g.Highlight,t);return this.objectStates.setObjectIds(s,i),l}}return ue}whenGraphicBounds(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){const s=U(e,{renderer:t,arcade:i});if(o(s)&&s.color){const l=s.color;l[0]=l[0]/255,l[1]=l[1]/255,l[2]=l[2]/255}return s}getRenderingInfoAsync(e,t,i,s){return k(e,{renderer:t,arcade:i,...s})}getSymbolLayerSize(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){var i;(i=this.graphicsCore)==null||i.setObjectIdVisibility(e,t)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add(f(()=>this.suspendResumeExtentMode,()=>{switch(this.handles.remove(C),this.suspendResumeExtentMode){case"computed":this.handles.add([f(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),x),f(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],C);break;case"data":this.handles.add([B(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),x),f(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(Y(this.dataExtent)))],C);break;default:z(this.suspendResumeExtentMode)}},x))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this.suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!Z(e,i))return;e=X(e,i)}return K(e,t,W,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){o(this.frustumVisibility)&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};r([n()],a.prototype,"type",void 0),r([n({constructOnly:!0})],a.prototype,"owner",void 0),r([n()],a.prototype,"layer",null),r([n({constructOnly:!0})],a.prototype,"updateClippingExtent",void 0),r([n({constructOnly:!0})],a.prototype,"elevationFeatureExpressionEnabled",void 0),r([n({constructOnly:!0})],a.prototype,"graphicsCore",void 0),r([n({constructOnly:!0})],a.prototype,"scaleVisibility",void 0),r([n({constructOnly:!0})],a.prototype,"filterVisibility",void 0),r([n({constructOnly:!0})],a.prototype,"elevationAlignment",void 0),r([n({constructOnly:!0})],a.prototype,"frustumVisibility",void 0),r([n({readOnly:!0})],a.prototype,"deconfliction",void 0),r([n({readOnly:!0})],a.prototype,"labeling",void 0),r([n({readOnly:!0})],a.prototype,"objectStates",void 0),r([n()],a.prototype,"suspendResumeExtentMode",null),r([n()],a.prototype,"dataExtent",void 0),r([n()],a.prototype,"scaleVisibilitySuspended",null),r([n()],a.prototype,"suspended",null),r([n()],a.prototype,"legendEnabled",null),r([n()],a.prototype,"suspendInfo",null),r([n()],a.prototype,"updating",null),r([n()],a.prototype,"updatingRemaining",null),r([n()],a.prototype,"featureStore",null),r([n()],a.prototype,"view",null),r([n()],a.prototype,"loadedGraphics",null),r([n()],a.prototype,"fullOpacity",null),r([n()],a.prototype,"filter",null),r([n()],a.prototype,"slicePlaneEnabled",null),r([n()],a.prototype,"drapeSourceType",void 0),r([n()],a.prototype,"updatePolicy",null),r([n()],a.prototype,"preferredUpdatePolicy",void 0),r([n()],a.prototype,"displayFeatureLimit",null),a=r([V("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],a);const fe=a,C="suspendResumeExtentMode",ue={remove(){},pause(){},resume(){}};export{fe as F,h as l};
