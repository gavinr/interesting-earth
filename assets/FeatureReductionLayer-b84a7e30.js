import{cz as ue,c8 as G,ai as l,aj as a,al as x,c9 as v,d3 as U,cD as P,c6 as A,ce as T,cN as Q,fC as I,nr as pe,ns as q,b3 as de,cb as W,aq as ce}from"./index-4b03b1b0.js";import{b as X,j as fe,l as R}from"./UniqueValueRenderer-ad13318a.js";import{a as Y,o as C,p as ye}from"./jsonUtils-dc7d3627.js";import{m as Z,p as ee}from"./commonProperties-1e64caff.js";import{v as te}from"./featureLayerUtils-ce39121a.js";import{C as ie}from"./LabelClass-3b8bddeb.js";let z=class extends ue(G){constructor(o){super(o),this.expression=null,this.title=null,this.returnType=null}};l([a({type:String,json:{write:!0}})],z.prototype,"expression",void 0),l([a({type:String,json:{write:!0}})],z.prototype,"title",void 0),l([a({type:String,json:{write:!0}})],z.prototype,"returnType",void 0),z=l([x("esri.layers.support.ExpressionInfo")],z);const D=z;var k;let b=k=class extends G{constructor(e){super(e),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new k({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:v(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};l([a({type:Boolean,json:{write:!0}})],b.prototype,"isAutoGenerated",void 0),l([a({type:String,json:{write:!0}})],b.prototype,"name",void 0),l([a({type:String,json:{write:!0}})],b.prototype,"alias",void 0),l([a({type:String,json:{write:!0}})],b.prototype,"onStatisticField",void 0),l([a({type:D,json:{write:!0}})],b.prototype,"onStatisticExpression",void 0),l([a({type:String,json:{write:!0}})],b.prototype,"statisticType",void 0),b=k=l([x("esri.layers.support.AggregateField")],b);const $=b;let w=class extends G{constructor(){super(...arguments),this.type=null}};l([a({type:["selection","cluster","binning"],readOnly:!0,json:{read:!1,write:!0}})],w.prototype,"type",void 0),w=l([x("esri.layers.support.FeatureReduction")],w);var L;const me="esri.layers.support.FeatureReductionBinning";let m=L=class extends w{constructor(e){super(e),this.type="binning",this.binType="geohash",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}writeFields(e,o,t){const i=e.filter(r=>r.statisticType!=="avg_angle").map(r=>r.toJSON());Q(t,i,o)}readRenderer(e,o,t){var r;const i=(r=o.drawingInfo)==null?void 0:r.renderer;return i?C(i,o,t)??void 0:te(o,t)}clone(){return new L({fields:v(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:v(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:v(this.popupTemplate),renderer:v(this.renderer)})}};l([U({binning:"binning"})],m.prototype,"type",void 0),l([U({geohash:"geohash"})],m.prototype,"binType",void 0),l([a({type:Number,range:{min:1,max:9},json:{write:!0}})],m.prototype,"fixedBinLevel",void 0),l([a({type:[ie],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],m.prototype,"labelingInfo",void 0),l([a(Z)],m.prototype,"labelsVisible",void 0),l([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],m.prototype,"maxScale",void 0),l([a(ee)],m.prototype,"popupEnabled",void 0),l([a({type:P,json:{name:"popupInfo",write:!0}})],m.prototype,"popupTemplate",void 0),l([a({type:[$],json:{write:!0}})],m.prototype,"fields",void 0),l([A("fields")],m.prototype,"writeFields",null),l([a({types:Y,json:{write:{target:"drawingInfo.renderer"}}})],m.prototype,"renderer",void 0),l([T("renderer",["drawingInfo.renderer"])],m.prototype,"readRenderer",null),m=L=l([x(me)],m);const se=m;var N;const he="esri.layers.support.FeatureReductionCluster";function H(e){var o;return e.type==="simple"&&!((o=e.visualVariables)!=null&&o.length)}let p=N=class extends G{constructor(e){super(e),this.type="cluster",this.clusterRadius=I("80px"),this.clusterMinSize=I("12px"),this.clusterMaxSize=I("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}readRenderer(e,o,t){var r,s;const i=(r=o.drawingInfo)==null?void 0:r.renderer;return(s=i==null?void 0:i.authoringInfo)!=null&&s.isAutoGenerated?null:i?H(i)?null:C(i,o,t)??void 0:te(o,t)}readSymbol(e,o,t){var r,s;const i=(r=o.drawingInfo)==null?void 0:r.renderer;if((s=i==null?void 0:i.authoringInfo)!=null&&s.isAutoGenerated)return null;if(i&&H(i)){const n=C(i,o,t);return n==null?void 0:n.symbol}return null}writeSymbol(e,o,t,i){var s,n;const r=(n=(s=this.renderer)==null?void 0:s.authoringInfo)==null?void 0:n.isAutoGenerated;if(!this.renderer||r){const h=new ye({symbol:e});o.drawingInfo={renderer:h.write({},i)}}}writeFields(e,o,t){const i=e.filter(r=>r.statisticType!=="avg_angle").map(r=>r.toJSON());Q(t,i,o)}readFields(e,o,t){return e.filter(i=>!i.isAutoGenerated).map(i=>$.fromJSON(i))}clone(){return new N({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:v(this.labelingInfo),labelsVisible:this.labelsVisible,fields:v(this.fields),maxScale:this.maxScale,renderer:v(this.renderer),symbol:v(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:v(this.popupTemplate)})}};l([a({type:["cluster"],readOnly:!0,json:{write:!0}})],p.prototype,"type",void 0),l([a({type:Number,cast:e=>e==="auto"?e:I(e),json:{write:!0}})],p.prototype,"clusterRadius",void 0),l([a({type:Number,cast:I,json:{write:!0}})],p.prototype,"clusterMinSize",void 0),l([a({type:Number,cast:I,json:{write:!0}})],p.prototype,"clusterMaxSize",void 0),l([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],p.prototype,"maxScale",void 0),l([a(ee)],p.prototype,"popupEnabled",void 0),l([a({type:P,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],p.prototype,"popupTemplate",void 0),l([a({types:Y,json:{write:{target:"drawingInfo.renderer"}}})],p.prototype,"renderer",void 0),l([T("renderer",["drawingInfo.renderer"])],p.prototype,"readRenderer",null),l([a({types:pe})],p.prototype,"symbol",void 0),l([T("symbol",["drawingInfo.renderer"])],p.prototype,"readSymbol",null),l([A("symbol")],p.prototype,"writeSymbol",null),l([a({type:[ie],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],p.prototype,"labelingInfo",void 0),l([a(Z)],p.prototype,"labelsVisible",void 0),l([a({type:[$],json:{write:!0}})],p.prototype,"fields",void 0),l([A("fields")],p.prototype,"writeFields",null),l([T("fields")],p.prototype,"readFields",null),p=N=l([x(he)],p);const re=p;var B;let V=B=class extends w{constructor(e){super(e),this.type="selection"}clone(){return new B}};l([a({type:["selection"]})],V.prototype,"type",void 0),V=B=l([x("esri.layers.support.FeatureReductionSelection")],V);const J=V,K={key:"type",base:w,typeMap:{cluster:re,binning:se}},ve={types:{key:"type",base:w,typeMap:{selection:J,cluster:re,binning:se}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:K},"portal-item":{types:K},"web-scene":{types:{key:"type",base:w,typeMap:{selection:J}}}}}},E={Base64:0,Hex:1,String:2,Raw:3},F=8,ne=(1<<F)-1;function g(e,o){const t=(65535&e)+(65535&o);return(e>>16)+(o>>16)+(t>>16)<<16|65535&t}function be(e){const o=[];for(let t=0,i=e.length*F;t<i;t+=F)o[t>>5]|=(e.charCodeAt(t/F)&ne)<<t%32;return o}function ge(e){const o=[];for(let t=0,i=32*e.length;t<i;t+=F)o.push(String.fromCharCode(e[t>>5]>>>t%32&ne));return o.join("")}function we(e){const o="0123456789abcdef",t=[];for(let i=0,r=4*e.length;i<r;i++)t.push(o.charAt(e[i>>2]>>i%4*8+4&15)+o.charAt(e[i>>2]>>i%4*8&15));return t.join("")}function xe(e){const o="=",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[];for(let r=0,s=4*e.length;r<s;r+=3){const n=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255;for(let h=0;h<4;h++)8*r+6*h>32*e.length?i.push(o):i.push(t.charAt(n>>6*(3-h)&63))}return i.join("")}function Se(e,o){return e<<o|e>>>32-o}function M(e,o,t,i,r,s){return g(Se(g(g(o,e),g(i,s)),r),t)}function d(e,o,t,i,r,s,n){return M(o&t|~o&i,e,o,r,s,n)}function c(e,o,t,i,r,s,n){return M(o&i|t&~i,e,o,r,s,n)}function f(e,o,t,i,r,s,n){return M(o^t^i,e,o,r,s,n)}function y(e,o,t,i,r,s,n){return M(t^(o|~i),e,o,r,s,n)}function $e(e,o){e[o>>5]|=128<<o%32,e[14+(o+64>>>9<<4)]=o;let t=1732584193,i=-271733879,r=-1732584194,s=271733878;for(let n=0;n<e.length;n+=16){const h=t,u=i,le=r,ae=s;t=d(t,i,r,s,e[n],7,-680876936),s=d(s,t,i,r,e[n+1],12,-389564586),r=d(r,s,t,i,e[n+2],17,606105819),i=d(i,r,s,t,e[n+3],22,-1044525330),t=d(t,i,r,s,e[n+4],7,-176418897),s=d(s,t,i,r,e[n+5],12,1200080426),r=d(r,s,t,i,e[n+6],17,-1473231341),i=d(i,r,s,t,e[n+7],22,-45705983),t=d(t,i,r,s,e[n+8],7,1770035416),s=d(s,t,i,r,e[n+9],12,-1958414417),r=d(r,s,t,i,e[n+10],17,-42063),i=d(i,r,s,t,e[n+11],22,-1990404162),t=d(t,i,r,s,e[n+12],7,1804603682),s=d(s,t,i,r,e[n+13],12,-40341101),r=d(r,s,t,i,e[n+14],17,-1502002290),i=d(i,r,s,t,e[n+15],22,1236535329),t=c(t,i,r,s,e[n+1],5,-165796510),s=c(s,t,i,r,e[n+6],9,-1069501632),r=c(r,s,t,i,e[n+11],14,643717713),i=c(i,r,s,t,e[n],20,-373897302),t=c(t,i,r,s,e[n+5],5,-701558691),s=c(s,t,i,r,e[n+10],9,38016083),r=c(r,s,t,i,e[n+15],14,-660478335),i=c(i,r,s,t,e[n+4],20,-405537848),t=c(t,i,r,s,e[n+9],5,568446438),s=c(s,t,i,r,e[n+14],9,-1019803690),r=c(r,s,t,i,e[n+3],14,-187363961),i=c(i,r,s,t,e[n+8],20,1163531501),t=c(t,i,r,s,e[n+13],5,-1444681467),s=c(s,t,i,r,e[n+2],9,-51403784),r=c(r,s,t,i,e[n+7],14,1735328473),i=c(i,r,s,t,e[n+12],20,-1926607734),t=f(t,i,r,s,e[n+5],4,-378558),s=f(s,t,i,r,e[n+8],11,-2022574463),r=f(r,s,t,i,e[n+11],16,1839030562),i=f(i,r,s,t,e[n+14],23,-35309556),t=f(t,i,r,s,e[n+1],4,-1530992060),s=f(s,t,i,r,e[n+4],11,1272893353),r=f(r,s,t,i,e[n+7],16,-155497632),i=f(i,r,s,t,e[n+10],23,-1094730640),t=f(t,i,r,s,e[n+13],4,681279174),s=f(s,t,i,r,e[n],11,-358537222),r=f(r,s,t,i,e[n+3],16,-722521979),i=f(i,r,s,t,e[n+6],23,76029189),t=f(t,i,r,s,e[n+9],4,-640364487),s=f(s,t,i,r,e[n+12],11,-421815835),r=f(r,s,t,i,e[n+15],16,530742520),i=f(i,r,s,t,e[n+2],23,-995338651),t=y(t,i,r,s,e[n],6,-198630844),s=y(s,t,i,r,e[n+7],10,1126891415),r=y(r,s,t,i,e[n+14],15,-1416354905),i=y(i,r,s,t,e[n+5],21,-57434055),t=y(t,i,r,s,e[n+12],6,1700485571),s=y(s,t,i,r,e[n+3],10,-1894986606),r=y(r,s,t,i,e[n+10],15,-1051523),i=y(i,r,s,t,e[n+1],21,-2054922799),t=y(t,i,r,s,e[n+8],6,1873313359),s=y(s,t,i,r,e[n+15],10,-30611744),r=y(r,s,t,i,e[n+6],15,-1560198380),i=y(i,r,s,t,e[n+13],21,1309151649),t=y(t,i,r,s,e[n+4],6,-145523070),s=y(s,t,i,r,e[n+11],10,-1120210379),r=y(r,s,t,i,e[n+2],15,718787259),i=y(i,r,s,t,e[n+9],21,-343485551),t=g(t,h),i=g(i,u),r=g(r,le),s=g(s,ae)}return[t,i,r,s]}function oe(e,o=E.Hex){const t=o||E.Base64,i=$e(be(e),e.length*F);switch(t){case E.Raw:return i;case E.Hex:return we(i);case E.String:return ge(i);case E.Base64:return xe(i)}}var O;let _=O=class extends X{writeLevels(e,o,t){for(const i in e){const r=this.levels[i];return void(o.stops=r)}}clone(){return new O({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:q(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:q(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(e=>e.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:v(this.levels)})}};l([a()],_.prototype,"levels",void 0),l([A("levels")],_.prototype,"writeLevels",null),_=O=l([x("esri.views.2d.engine.LevelDependentSizeVariable")],_);const Ee=de.getLogger("esri.views.2d.layers.support.clusterUtils");W.add("esri-cluster-arcade-enabled",!0);const ze=W("esri-cluster-arcade-enabled"),Ie=(e,o,t,i,r)=>{const s=o.clone();if(!_e(s))return s;if(s.authoringInfo||(s.authoringInfo=new fe),s.authoringInfo.isAutoGenerated=!0,"visualVariables"in s){const n=(s.visualVariables||[]).filter(u=>u.valueExpression!=="$view.scale"),h=Fe(n);n.forEach(u=>{u.type==="rotation"?u.field?u.field=S(e,u.field,"avg_angle","number"):u.valueExpression&&(u.field=j(e,u.valueExpression,"avg_angle","number"),u.valueExpression=null):u.normalizationField?(u.field=S(e,u.field,"avg_norm","number",u.normalizationField),u.normalizationField=null):u.field?u.field=S(e,u.field,"avg","number"):u.valueExpression&&(u.field=j(e,u.valueExpression,"avg","number"),u.valueExpression=null)}),h==null&&!Re(n)&&r&&(n.push(je(t,i)),s.dynamicClusterSize=!0),s.visualVariables=n}switch(s.type){case"simple":break;case"pie-chart":for(const n of s.attributes)n.field?n.field=S(e,n.field,"sum","number"):n.valueExpression&&(n.field=j(e,n.valueExpression,"sum","number"),n.valueExpression=null);break;case"unique-value":s.field?s.field=S(e,s.field,"mode","string"):s.valueExpression&&(s.field=j(e,s.valueExpression,"mode","string"),s.valueExpression=null);break;case"class-breaks":s.normalizationField?(s.field=S(e,s.field,"avg_norm","number",s.normalizationField),s.normalizationField=null):s.field?s.field=S(e,s.field,"avg","number"):s.valueExpression&&(s.field=j(e,s.valueExpression,"avg","number"),s.valueExpression=null)}return s},Fe=e=>{for(const o of e)if(o.type==="size")return o;return null},Re=e=>{for(const o of e)if(o.field==="cluster_count")return!0;return!1},je=(e,o)=>{const t=[new R({value:0,size:0}),new R({value:1})];if(o==null)return new X({field:"cluster_count",stops:[...t,new R({value:2,size:0})]});const i=Object.keys(o).reduce((r,s)=>({...r,[s]:[...t,new R({value:Math.max(2,o[s].minValue),size:e.clusterMinSize}),new R({value:Math.max(3,o[s].maxValue),size:e.clusterMaxSize})]}),{});return new _({field:"cluster_count",levels:i})},_e=e=>{const o=t=>Ee.error(new ce("Unsupported-renderer",t,{renderer:e}));if(!e)return!1;switch(e.type){case"unique-value":if(e.field2||e.field3)return o("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(e.normalizationField){const t=e.normalizationType;if(t!=="field")return o(`FeatureReductionCluster does not support a normalizationType of ${t}`),!1}break;case"simple":case"pie-chart":break;default:return o(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1}if(!ze){if("valueExpression"in e&&e.valueExpression)return o("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some(t=>!(!("valueExpression"in t)||!t.valueExpression)))return o("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function Te(e,o,t){switch(e){case"sum":return`cluster_sum_${o}`;case"avg":case"avg_angle":return`cluster_avg_${o}`;case"mode":return`cluster_type_${o}`;case"avg_norm":{const i=t,r="field",s=o.toLowerCase()+",norm:"+r+","+i.toLowerCase();return"cluster_avg_"+oe(s)}}}function j(e,o,t,i){const r=oe(o),s=t==="mode"?`cluster_type_${r}`:t==="sum"?`cluster_sum_${r}`:`cluster_avg_${r}`;return e.some(n=>n.name===s)||e.push(new $({name:s,isAutoGenerated:!0,onStatisticExpression:new D({expression:o,returnType:i}),statisticType:t})),s}function S(e,o,t,i,r){if(o==="cluster_count"||e.some(n=>n.name===o))return o;const s=Te(t,o,r);return e.some(n=>n.name===s)||(t==="avg_norm"?e.push(new $({name:s,isAutoGenerated:!0,onStatisticExpression:new D({expression:`$feature.${o} / $feature.${r}`,returnType:i}),statisticType:"avg"})):e.push(new $({name:s,isAutoGenerated:!0,onStatisticField:o,statisticType:t}))),s}const Be=e=>{let o=class extends e{constructor(...t){super(...t),this.own(this.watch("renderer",()=>{if(this.featureReduction){const i=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",i)}},!0))}set featureReduction(t){const i=this._normalizeFeatureReduction(t);this._set("featureReduction",i)}set renderer(t){}_normalizeFeatureReduction(t){var h;if((t==null?void 0:t.type)!=="cluster")return t;const i=t.clone(),r=[new $({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],s=(i.fields??[]).filter(u=>!u.isAutoGenerated);if(t.renderer&&!((h=t.renderer.authoringInfo)!=null&&h.isAutoGenerated))return i.fields=[...r,...s],i;if(t.symbol)return i.fields=[...r,...s],i.renderer=null,i;if(!this.renderer)return t;const n=Ie(r,this.renderer,t,null,!1);return i.fields=[...r,...s],i.renderer=n,i}};return l([a(ve)],o.prototype,"featureReduction",null),o=l([x("esri.layers.mixins.FeatureReductionLayer")],o),o};export{E as a,Be as n,J as p,w as t,oe as x};
