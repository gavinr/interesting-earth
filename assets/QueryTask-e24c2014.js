import{ca as y,bl as T,ai as a,aj as u,al as A,ao as w,dW as Q,cb as P,e$ as p,aF as s,dn as f,dm as h,aq as j}from"./index-4b03b1b0.js";import{b as _,K as S}from"./Query-cdee9722.js";import{n as q,s as L}from"./executeForIds-ab1d15b9.js";import{S as $}from"./query-af06498b.js";import{a as J}from"./executeQueryJSON-838e0f16.js";import{n as N}from"./executeQueryPBF-95f90cfc.js";import{d as z}from"./FeatureSet-d4d9321c.js";async function C(r,t,e){const o=y(r);return $(o,_.from(t),{...e}).then(c=>({count:c.data.count,extent:T.fromJSON(c.data.extent)}))}let i=class extends w{constructor(r){super(r),this.dynamicDataSource=null,this.fieldsIndex=null,this.gdbVersion=null,this.infoFor3D=null,this.pbfSupported=!1,this.queryAttachmentsSupported=!1,this.sourceSpatialReference=null,this.url=null}get parsedUrl(){return Q(this.url)}async execute(r,t){const e=await this.executeJSON(r,t);return this.featureSetFromJSON(r,e,t)}async executeJSON(r,t){var n;const e=this._normalizeQuery(r),o=((n=r.outStatistics)==null?void 0:n[0])!=null,c=P("featurelayer-pbf-statistics"),l=!o||c;let m;if(this.pbfSupported&&l)try{m=await N(this.url,e,t)}catch(d){if(d.name!=="query:parsing-pbf")throw d;this.pbfSupported=!1}return this.pbfSupported&&l||(m=await J(this.url,e,t)),this._normalizeFields(m.fields),m}async featureSetFromJSON(r,t,e){if(!this._queryIs3DObjectFormat(r)||this.infoFor3D==null||!t.features)return z.fromJSON(t);const{meshFeatureSetFromJSON:o}=await p(s(()=>import("./meshFeatureSet-14795b8b.js"),["./meshFeatureSet-14795b8b.js","./index-4b03b1b0.js","./index-0de4b476.css","./MeshGeoreferencedRelativeVertexSpace-01dadcff.js","./MeshLocalVertexSpace-e2febaf3.js","./georeference-840449ac.js","./External-c5d404b6.js","./FeatureSet-d4d9321c.js"],import.meta.url),e);return o(r,this.infoFor3D,t)}executeForCount(r,t){return q(this.url,this._normalizeQuery(r),t)}executeForExtent(r,t){return C(this.url,this._normalizeQuery(r),t)}executeForIds(r,t){return L(this.url,this._normalizeQuery(r),t)}async executeRelationshipQuery(r,t){const[{default:e},{executeRelationshipQuery:o}]=await p(Promise.all([s(()=>import("./RelationshipQuery-ab8c76dd.js"),["./RelationshipQuery-ab8c76dd.js","./index-4b03b1b0.js","./index-0de4b476.css","./Query-cdee9722.js"],import.meta.url),s(()=>import("./executeRelationshipQuery-be22db3c.js"),["./executeRelationshipQuery-be22db3c.js","./index-4b03b1b0.js","./index-0de4b476.css","./query-af06498b.js","./normalizeUtils-1bd513d6.js","./normalizeUtilsCommon-a78292a0.js","./pbfQueryUtils-8c741d64.js","./pbf-18997bde.js","./queryZScale-2a8227ea.js","./FeatureSet-d4d9321c.js","./RelationshipQuery-ab8c76dd.js","./Query-cdee9722.js"],import.meta.url)]),t);return r=e.from(r),(this.gdbVersion||this.dynamicDataSource)&&((r=r.clone()).gdbVersion=r.gdbVersion||this.gdbVersion,r.dynamicDataSource=r.dynamicDataSource||this.dynamicDataSource),o(this.url,r,t)}async executeRelationshipQueryForCount(r,t){const[{default:e},{executeRelationshipQueryForCount:o}]=await p(Promise.all([s(()=>import("./RelationshipQuery-ab8c76dd.js"),["./RelationshipQuery-ab8c76dd.js","./index-4b03b1b0.js","./index-0de4b476.css","./Query-cdee9722.js"],import.meta.url),s(()=>import("./executeRelationshipQuery-be22db3c.js"),["./executeRelationshipQuery-be22db3c.js","./index-4b03b1b0.js","./index-0de4b476.css","./query-af06498b.js","./normalizeUtils-1bd513d6.js","./normalizeUtilsCommon-a78292a0.js","./pbfQueryUtils-8c741d64.js","./pbf-18997bde.js","./queryZScale-2a8227ea.js","./FeatureSet-d4d9321c.js","./RelationshipQuery-ab8c76dd.js","./Query-cdee9722.js"],import.meta.url)]),t);return r=e.from(r),(this.gdbVersion||this.dynamicDataSource)&&((r=r.clone()).gdbVersion=r.gdbVersion||this.gdbVersion,r.dynamicDataSource=r.dynamicDataSource||this.dynamicDataSource),o(this.url,r,t)}async executeAttachmentQuery(r,t){const{executeAttachmentQuery:e,fetchAttachments:o,processAttachmentQueryResult:c}=await p(s(()=>import("./queryAttachments-57c71031.js"),["./queryAttachments-57c71031.js","./index-4b03b1b0.js","./index-0de4b476.css","./query-af06498b.js","./normalizeUtils-1bd513d6.js","./normalizeUtilsCommon-a78292a0.js","./pbfQueryUtils-8c741d64.js","./pbf-18997bde.js","./queryZScale-2a8227ea.js","./AttachmentInfo-03541bb8.js"],import.meta.url),t),l=y(this.url);return c(l,await(this.queryAttachmentsSupported?e(l,r,t):o(l,r,t)))}async executeTopFeaturesQuery(r,t){const{executeTopFeaturesQuery:e}=await p(s(()=>import("./executeTopFeaturesQuery-0247be79.js"),["./executeTopFeaturesQuery-0247be79.js","./index-4b03b1b0.js","./index-0de4b476.css","./queryTopFeatures-3312d0ed.js","./normalizeUtils-1bd513d6.js","./normalizeUtilsCommon-a78292a0.js","./query-af06498b.js","./pbfQueryUtils-8c741d64.js","./pbf-18997bde.js","./queryZScale-2a8227ea.js","./FeatureSet-d4d9321c.js","./TopFeaturesQuery-da745a52.js"],import.meta.url),t);return e(this.parsedUrl,r,this.sourceSpatialReference,t)}async executeForTopIds(r,t){const{executeForTopIds:e}=await p(s(()=>import("./executeForTopIds-8426fd35.js"),["./executeForTopIds-8426fd35.js","./index-4b03b1b0.js","./index-0de4b476.css","./queryTopFeatures-3312d0ed.js","./normalizeUtils-1bd513d6.js","./normalizeUtilsCommon-a78292a0.js","./query-af06498b.js","./pbfQueryUtils-8c741d64.js","./pbf-18997bde.js","./queryZScale-2a8227ea.js","./TopFeaturesQuery-da745a52.js"],import.meta.url),t);return e(this.parsedUrl,r,t)}async executeForTopExtents(r,t){const{executeForTopExtents:e}=await p(s(()=>import("./executeForTopExtents-9f857919.js"),["./executeForTopExtents-9f857919.js","./index-4b03b1b0.js","./index-0de4b476.css","./queryTopFeatures-3312d0ed.js","./normalizeUtils-1bd513d6.js","./normalizeUtilsCommon-a78292a0.js","./query-af06498b.js","./pbfQueryUtils-8c741d64.js","./pbf-18997bde.js","./queryZScale-2a8227ea.js","./TopFeaturesQuery-da745a52.js"],import.meta.url),t);return e(this.parsedUrl,r,t)}async executeForTopCount(r,t){const{executeForTopCount:e}=await p(s(()=>import("./executeForTopCount-4b45843d.js"),["./executeForTopCount-4b45843d.js","./index-4b03b1b0.js","./index-0de4b476.css","./queryTopFeatures-3312d0ed.js","./normalizeUtils-1bd513d6.js","./normalizeUtilsCommon-a78292a0.js","./query-af06498b.js","./pbfQueryUtils-8c741d64.js","./pbf-18997bde.js","./queryZScale-2a8227ea.js","./TopFeaturesQuery-da745a52.js"],import.meta.url),t);return e(this.parsedUrl,r,t)}_normalizeQuery(r){let t=_.from(r);t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===r?t.clone():t,t.gdbVersion=r.gdbVersion||this.gdbVersion,t.dynamicDataSource=r.dynamicDataSource?S.from(r.dynamicDataSource):this.dynamicDataSource);const{infoFor3D:e}=this;if(e!=null&&this._queryIs3DObjectFormat(r)){t=t===r?t.clone():t,t.formatOf3DObjects=null;const{supportedFormats:o,queryFormats:c}=e,l=f("model/gltf-binary",o)??h("glb",o),m=f("model/gltf+json",o)??h("gtlf",o);for(const n of c){if(n===l){t.formatOf3DObjects=n;break}n!==m||t.formatOf3DObjects||(t.formatOf3DObjects=n)}if(!t.formatOf3DObjects)throw new j("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(t.outFields==null||!t.outFields.includes("*")){t=t===r?t.clone():t,t.outFields==null&&(t.outFields=[]);const{originX:n,originY:d,originZ:D,translationX:F,translationY:b,translationZ:O,scaleX:x,scaleY:g,scaleZ:V,rotationX:E,rotationY:R,rotationZ:I,rotationDeg:v}=e.transformFieldRoles;t.outFields.push(n,d,D,F,b,O,x,g,V,E,R,I,v)}}return t}_normalizeFields(r){if(this.fieldsIndex!=null&&r!=null)for(const t of r){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}}_queryIs3DObjectFormat(r){return this.infoFor3D!=null&&r.returnGeometry===!0&&r.multipatchOption!=="xyFootprint"&&!r.outStatistics}};a([u({type:S})],i.prototype,"dynamicDataSource",void 0),a([u()],i.prototype,"fieldsIndex",void 0),a([u()],i.prototype,"gdbVersion",void 0),a([u()],i.prototype,"infoFor3D",void 0),a([u({readOnly:!0})],i.prototype,"parsedUrl",null),a([u()],i.prototype,"pbfSupported",void 0),a([u()],i.prototype,"queryAttachmentsSupported",void 0),a([u()],i.prototype,"sourceSpatialReference",void 0),a([u({type:String})],i.prototype,"url",void 0),i=a([A("esri.tasks.QueryTask")],i);const M=i;export{M as x};
